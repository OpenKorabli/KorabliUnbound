(def constant LEAGUE_CHANGE_BG_THRESHOLD 4)
(def constant MAX_RANK_TO_DISPLAY 10000)
(def constant RANKS_COUNT_IN_EACH_LEAGUE 20)
(def constant RESET_TASKS_TYPE_ALL 0)
(def constant RESET_TASKS_TYPE_SINGLE 1)
(def constant TOP_LEAGUE 6)
(def constant LEAGUE_ICON_SIZE 200px)
(def constant MASTERY_PROGRESS_WIDTH 252px)
(def constant MASTERY_EMBLEM_CT_WHITE {
	redMultiplier: 1,
	greenMultiplier: 1,
	blueMultiplier: 1,
	alphaMultiplier: 1,
	redOffset: 200,
	greenOffset: 200,
	blueOffset: 200,
	alphaOffset: 0,
})

(def struct PROGRESS_COUNT (_pointsForNextRank:number, _points:number, _pointsForCurrentRank:number)
	(var pointsTillNextRank:number = "max(0, _pointsForNextRank - _points)")
	(var maxPointsTillNextRank:number = "_pointsForNextRank - _pointsForCurrentRank")
	(var progress:number = "maxPointsTillNextRank > 0	?	(maxPointsTillNextRank - pointsTillNextRank) / maxPointsTillNextRank
														:	0")
)

(def struct LEAGUE_COUNT (_rank:number = 0)
	(var value:number = "_rank > 0 ? floor(_rank / RANKS_COUNT_IN_EACH_LEAGUE) + 1 : 0")
)

(def css $MasteryAnimationStyle ()
	(hitTest = false)
	(position = "absolute")
	(width = "LEAGUE_ICON_SIZE")
	(height = "LEAGUE_ICON_SIZE")
)

(def element ShipMasteryMainInset ()
	(scope
		(macro PULL_SHIP_ID)
		(var shipInfo:dhComponent = "getPrimaryComponent(CC.ship, viewedShipId)")

		(var shipMasteryEntity:dhEntity = "getPrimaryEntity(CC.shipMastery, playerShipId)")
		(var status:number = "shipMasteryEntity.shipMastery.status ?: 0" (event "shipMasteryEntity.shipMastery.evStatusChanged"))
		(var isMaxRank:bool = "status == SC.Common.SHIP_MASTERY_STATUSES.MAX_RANK_REACHED")
	)

	(macro SOUND_DOCK_INSET_HANDLER "SC.Ui_windows.ROUTE.SHIP_MASTERY")

	(name = 'ship_mastery')

	(class $Fullsize)

	(style
		
		(bind alpha "0"			on='addedToStage' on='removedFromStage')
		(bind hitTest "false"	on='addedToStage' on='removedFromStage')
	)

	(controller $Animation
		(bindcall play
			delay = 0.3
			duration = 0.2
			from = "{ alpha: 0, hitTest:false }"
			to = "{ alpha: 1, hitTest: true }"
			easing = "Easing.quad_out"
			action = "kill"
			on = 'addedToStage'
		)
	)

	(block
		(style
			(position = "absolute")
			(top = "{ 720:SXS, 1080:L }")
			(left = "{ 1280:SXS, 1920:L }")
		)
		(controller $Instance renderer='ShipMasteryTrials'
			(bind enabled "!isMaxRank && shipMasteryEntity")
			(args
				_playerShipId = "playerShipId"
			)
		)
	)

	(block
		(class $MiddleAlignedAbsolutely)
		(style (bind top "shipMasteryEntity ? {720:-46px, 1080:-L} : {720:XLM, 1080:94px}"))

		(controller $Instance renderer='ShipMasteryProgress'
			(bind enabled "shipMasteryEntity")
			(args
				_playerShipId = "playerShipId"
			)
		)

		(controller $Instance renderer='ShipMasterySelectShipWarning'
			(bind enabled "!shipMasteryEntity")
		)
	)
)

(def element ShipMasteryTrials (_playerShipId:number = 0)
	(scope
		(var shipMasteryComponent:dhComponent = "getPrimaryComponent(CC.shipMastery, _playerShipId)")
		(var rank:number = "shipMasteryComponent.rank ?: 0" (event "shipMasteryComponent.evRankChanged"))
		(var status:number = "shipMasteryComponent.status ?: 0" (event "shipMasteryComponent.evStatusChanged"))
		(var conditionSetEntityID:number = "shipMasteryComponent.conditionSetEntityID ?: 0")
		(var taskEntitiesIDs:array = "shipMasteryComponent.taskEntitiesIDs ?: []" (event "shipMasteryComponent.evTaskEntitiesIDsChanged"))
		(var threshold:number = "shipMasteryComponent.closestFromAboveRankWithTasks ?: 0" (event "shipMasteryComponent.evClosestFromAboveRankWithTasksChanged"))
		(var isRankInProgress:bool = "status == SC.Common.SHIP_MASTERY_STATUSES.RANK_IN_PROGRESS")
		(var isTrialInProgress:bool = "status == SC.Common.SHIP_MASTERY_STATUSES.TASKS_IN_PROGRESS")
		(var topStatusText:str = "isRankInProgress	? 'IDS_SHIP_MASTERY_TRIALS_TOP_STATUS_NO_ACTIVE_TRIALS_0'
													: 'IDS_SHIP_MASTERY_TRIALS_TOP_STATUS_NO_ACTIVE_TRIALS_1'")
		(var bottomStatusText:str = "isRankInProgress	? subst('IDS_SHIP_MASTERY_TRIALS_STATUS_1', [], {_threshold: threshold + 1})
														: 'IDS_SHIP_MASTERY_TRIALS_STATUS_2'")

		(var conditionEntity:dhEntity = "getEntity(conditionSetEntityID)")
		(var battleTypes:array = "conditionEntity.battleTypesView.viewList ?: []" (event "conditionEntity.battleTypesView.evBattleTypesViewChanged"))

		(var shipOwnEntity:dhEntity = "getPrimaryEntity(CC.ownShip, _playerShipId)")
		(var shipOwnComponent:dhComponent = "shipOwnEntity.ownShip")

		(var isShipInBalancer:bool = "shipOwnComponent.lock == SC.Common.OWN_SHIP_LOCK.BALANCER" (event "shipOwnComponent.evUpdateLock"))
		(var isShipReadyForBattle:bool = "shipOwnComponent.lock == SC.Common.OWN_SHIP_LOCK.DIVISION_IS_READY" (event "shipOwnComponent.evUpdateLock"))

		(var buttonHintTooltipStatus:dict = "	isShipInBalancer 			? 	{ 	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.WARNING,
																					text: 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER' } :
												isShipReadyForBattle		? 	{ 	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.ATTENTION,
																					text: 'IDS_SHIP_MASTERY_TRIALS_TASKS_DIVISION_READY_BUTTON_HINT' }
																			: 	{ 	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.ATTENTION,
																					text: 'IDS_SHIP_MASTERY_TRIALS_TASKS_AVAILABLE_SOON_BUTTON_HINT' }")

		(var isMaxBattleTypePerRow:bool = "battleTypes.length > 6")

		(var isShipLocked:bool = "isShipReadyForBattle || isShipInBalancer")

		(var resetButtonAllStatusText:str = "	isShipInBalancer		? 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER' :
												isShipReadyForBattle	? 'IDS_UNABLE_TO_SET_WHILE_READY_FOR_BATTLE'
																		: null")
	)

	(style (width = 360px))
	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND)

	(hblock
		(style
			(width = 100%)
			(paddingLeft = "M")
			(paddingTop = "SXS")
			(paddingBottom = "SXS")
			(paddingRight = "S")
			(align = "middle")
		)

		(tf
			(class $TextDefaultBold18NM)
			(style
				(width = 100%)
				(alpha = "TA")
			)
			(text = 'IDS_SHIP_MASTERY_TRIALS_TITLE')
		)

		(element DefaultButton
			_label = 'IDS_SHIP_MASTERY_BUTTON_ABOUT'
			_width = 101px
			_type = "SC.Ui_styles.BUTTON_TYPE.SECONDARY"
			_size = "SIZE.SMALL"
			_focusIndex = 1
			_methods = "[
				{
					type: 'inputMapping.onRequest',
					name: 'showEventRules',
					args: { _rulesType: 'ship_mastery' }
				}
			]"
		)
	)

	(element HorizontalDividerTwoPx)

	(block
		(style
			(width = 100%)
			(paddingTop = "SXS")
			(paddingLeft = "M")
			(paddingRight = "M")
			(bind paddingBottom "!isTrialInProgress ? M : 0")
		)

		(tf
			(bind visible "!isTrialInProgress")
			(class $TextDefaultNM)
			(style
				(width = 100%)
				(marginBottom = "SXS")
				(alpha = "TA")
			)
			(bind text "topStatusText")
		)

		(block
			(tf
				(bind visible "isTrialInProgress")
				(class $TextDefaultNM)
				(style
					(marginBottom = "S")
					(alpha = "TA")
				)
				(text = 'IDS_SSE_TASK_RESTRICTIONS_COLON')
			)

			(block
				(style
					(width = 100%)
					(bind flow "isMaxBattleTypePerRow ? vertical : horizontal")
				)

				(hblock
					(style
						(marginTop = "-XXS")
						(marginRight = "XS")
					)
					(controller $Repeat renderer='TaskBattleTypeRestriction'
						(bind count "battleTypes.length")
						(args
							_battleType = "battleTypes[$index].battleName"
							_isPVEModifierApplied = "battleTypes[$index].hasPVEModifier"
							_customIcon = "battleTypes[$index].customIconName"
							_availabilityState = "battleTypes[$index].availabilityState"
							_requiredLevel = "battleTypes[$index].requiredLevel"
						)
					)
				)

				(block
					(bind visible "!isMaxBattleTypePerRow && isTrialInProgress")
					(style
						(height = 21px)
						(marginRight = "SXS")
					)
					(controller $Instance renderer='VerticalDivider'
						(bind enabled "!isMaxBattleTypePerRow && isTrialInProgress")
					)
				)

				(tf
					(bind visible "isTrialInProgress")
					(class $TextDefaultNM)
					(style
						(alpha = "TC")
						(bind marginTop "isMaxBattleTypePerRow ? 6px : XS")
					)
					(text = 'IDS_SHIP_MASTERY_TRIALS_CONDITION')
				)
			)
		)

		(tf
			(bind visible "!isTrialInProgress")
			(class $TextDefaultNM)
			(style
				(width = 100%)
				(alpha = "TA")
				(leading = -1)
				(styleSheet = "'h3{font-weight:bold}'")
				(marginTop = "SXS")
			)
			(bind htmlText "bottomStatusText")
		)
	)

	(block
		(bind visible "isTrialInProgress")
		(style
			(width = 100%)
			(paddingTop = "{720:S, 1080:SXS}")
			(paddingLeft = "{1280:XS, 1920:S}")
			(paddingRight = "{1280:XS, 1920:S}")
			(paddingBottom = "{720:XS, 1080:S}")
		)
		(block
			(style
				(width = 100%)
				(gap = "XS")
			)
			(controller $Repeat renderer='ShipMasteryTask'
				(bind count "taskEntitiesIDs.length")
				(args
					_entityId = "taskEntitiesIDs[$index]"
					_playerShipId = "_playerShipId"
				)
			)
		)
	)
)

(def element ShipMasteryTask (_entityId:number = 0, _playerShipId:number = 0)
	(scope
		(struct mouseHandler = MOUSE_HANDLER())

		(var shipOwnComponent:dhComponent = "getPrimaryComponent(CC.ownShip, _playerShipId)")
		(var isShipReadyForBattle:bool = "shipOwnComponent.lock == SC.Common.OWN_SHIP_LOCK.DIVISION_IS_READY" (event "shipOwnComponent.evUpdateLock"))
		(var isShipInBalancer:bool = "shipOwnComponent.lock == SC.Common.OWN_SHIP_LOCK.BALANCER" (event "shipOwnComponent.evUpdateLock"))
		(var isShipLocked:bool = "isShipInBalancer || isShipReadyForBattle")

		(var sseConditionEntity:dhEntity = "getEntity(_entityId)")
		(var taskID:number = "sseConditionEntity.shipMasteryTask.id")
		(var isCompleted:bool = "sseConditionEntity.shipMasteryTask.isDone" (event "sseConditionEntity.shipMasteryTask.evIsDoneChanged"))
		(var unifiedStatus:str = "isCompleted ? SC.Ui_styles.UNIFIED_STATUS.CHECK : SC.Ui_styles.UNIFIED_STATUS.DEFAULT")
		(var statusText:str = "isCompleted ? 'IDS_TASK_COMPLETED' : 'IDS_TASK_NOT_DONE'")

		(var resetButtonStatusText:str = "	isShipInBalancer		? 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER' :
											isShipReadyForBattle	? 'IDS_UNABLE_TO_SET_WHILE_READY_FOR_BATTLE'
																	: null")
	)

	(macro STRUCT_MOUSE_DISPATCHER
		_mouseHandler = "mouseHandler"
	)

	(style
		(width = 100%)
		(backgroundColor = 0x1AFFFFFF)
		(borderRadius = "XS")
	)

	(block
		(style
			(width = 100%)
			(paddingTop = "{720:S, 1080:SXS}")
			(paddingBottom = "{720:XS, 1080:S}")
			(paddingLeft = "SXS")
			(paddingRight = "SXS")
		)

		(block
			(style
				(width = 100%)
				(minHeight = 41px)
				(bind alpha "isCompleted ? 0.4 : 1")
			)
			(element SseTaskDescription
				_sseEntityId = "_entityId"
				_conditionId = "sseConditionEntity.id"
				_isShipMasteryTask = true
				_isThirdLevel = true
				_isHeader = true
				_textClass = '$TextDefaultNM'
			)
		)

		(hblock
			(style
				(width = 100%)
				(height = 24px)
				(marginTop = "{720:XS, 1080:SXS}")
				(align = "middle")
				(bind alpha "isCompleted ? 1 : 0.7")
			)

			(element StatusLine
				_unifiedStatus = "unifiedStatus"
				_text = "statusText"
				_textClass = '$TextDefault14NM'
				_width = 100%
			)

			(block
				(controller $Instance renderer='DefaultButton'
					(bind enabled "!isCompleted")
					(args
						_width = 96px
						_size = "SIZE.SMALL"
						_enabled = "!isShipLocked"
						_label = 'IDS_SHIPS_MASTERY_TRIALS_RESET_BUTTON'
						_type = "SC.Ui_styles.BUTTON_TYPE.SECONDARY"
						_methods = "[
										{	type: 'inputMapping.onRequest',
											name: 'resetTrials',
											args: {taskID: taskID}
										}
									]"
					)
				)

				(controller $Tooltip
					(bind enabled "isShipLocked")
					(renderer = 'SimpleStatusTooltip')
					(args
						_text = "resetButtonStatusText"
						_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.WARNING"
					)
					(macro DEFAULT_TOOLTIP_BEHAVIOUR)
				)
			)
		)
	)
)

(def element ShipMasteryProgress (_playerShipId:number = 0)
	(macro DEFAULT_MODAL_WINDOW_SCOPE_EVENTS)
	(scope
		(event evLeagueChanged)
		(event evMasteryEmblemAnimEnded)
		(event evProgressAnimEnded)
		(event evAddedToStage)

		(var shipMasteryComponent:dhComponent = "getPrimaryComponent(CC.shipMastery, _playerShipId)")
		(var status:number = "shipMasteryComponent.status ?: 0" (event "shipMasteryComponent.evStatusChanged"))

		(var rank:number = "shipMasteryComponent.rank ?: 0" (event "shipMasteryComponent.evRankChanged"))
		(var points:number = "shipMasteryComponent.points ?: 0" (event "shipMasteryComponent.evPointsChanged"))
		(var pointsForNextRank:number = "shipMasteryComponent.pointsForNextRank ?: 0" (event "shipMasteryComponent.evPointsForNextRankChanged"))
		(var pointsForCurrentRank:number = "shipMasteryComponent.pointsForCurrentRank ?: 0" (event "shipMasteryComponent.evPointsForCurrentRankChanged"))

		(var prevRank:number = "shipMasteryComponent.prevRank ?: 0" (event "shipMasteryComponent.evPrevRankChanged"))
		(var prevPoints:number = "shipMasteryComponent.prevPoints ?: 0" (event "shipMasteryComponent.evPrevPointsChanged"))
		(var prevPointsForNextRank:number = "shipMasteryComponent.prevPointsForNextRank ?: 0" (event "shipMasteryComponent.evPrevPointsForNextRankChanged"))
		(var prevPointsForCurrentRank:number = "shipMasteryComponent.prevPointsForCurrentRank ?: 0" (event "shipMasteryComponent.evPrevPointsForCurrentRankChanged"))

		(struct currentValue = PROGRESS_COUNT(_pointsForNextRank = "pointsForNextRank" _points = "points" _pointsForCurrentRank="pointsForCurrentRank"))
		(struct previousValue = PROGRESS_COUNT(_pointsForNextRank = "prevPointsForNextRank" _points = "prevPoints" _pointsForCurrentRank="prevPointsForCurrentRank"))

		(var description:str = "status == SC.Common.SHIP_MASTERY_STATUSES.TASKS_AVAILABLE_SOON ||
								status == SC.Common.SHIP_MASTERY_STATUSES.RANK_IN_PROGRESS	? subst('IDS_SHIP_MASTERY_STATUS_1', [],
																								{_pointsNext: currentValue.pointsTillNextRank}, currentValue.pointsTillNextRank)
																							: 'IDS_SHIP_MASTERY_STATUS_' + status")
		(var isTopRank:bool = "rank == SC.Common.SHIP_MASTERY_CONSTANTS.MAX_RANK")

		(struct league = LEAGUE_COUNT(_rank="rank"))
		(struct prevLeague = LEAGUE_COUNT(_rank="prevRank"))

		(var leagueSaved:number = "prevLeague.value" watch=false)
		(bind leagueSaved "league.value" init=false watch=false (bind trigger "_playerShipId") (event "evMasteryEmblemAnimEnded"))

		(var iconName:str = "league.value == TOP_LEAGUE ? 'top_rank' : 'level_' + league.value")

		(var leagueChangeSound:str = "isTopRank ? 'mastery_leveling_final' : 'mastery_leveling'")
	)
	(dispatch evAddedToStage delay=0.4 on='addedToStage')  
	(dispatch evLeagueChanged dir="EventDirection.DOWN" (bind enabled "league.value != leagueSaved") (event "evAddedToStage") (event "shipMasteryComponent.evRankChanged"))
	(bindcall externalCall
		'direct.action'
		"['shipsMastery.setProgressAnimationSeen', { shipID: _playerShipId}]"
		(event "evMasteryEmblemAnimEnded")
		(event "evProgressAnimEnded")
	)
	(bindcall externalCall
		'sound.playSetSoundDirect'
		"['mastery_progressbar', 'start']"
		(event "shipMasteryComponent.evPointsChanged")
	)
	(bindcall externalCall
		'sound.playSetSoundDirect'
		"[leagueChangeSound, 'start']"
		watch=false
		(event "evLeagueChanged")
	)

	(style
		(width = 390px)
		(align = "center")
	)

	(block
		(style
			(position = "absolute")
			(top = 126px)
			(left = 49px)
			(width = 292px)
			(height = 90px)
			(scale9grid = 4)
			(backgroundImage = 'url:../ship_mastery/league_bg.png')
		)

		(block
			(style
				(width = 100%)
				(align = "center")
				(paddingTop = 30px)
				(bind paddingLeft "isTopRank ? 0px : 20px")
				(bind paddingRight "isTopRank ? 0px : 20px")
			)

			(block
				(bind visible "!isTopRank")
				(style
					(width = 100%)
					(marginBottom = "S")
				)
				(controller $Instance renderer='MasteryProgressBar'
					(bind enabled "!isTopRank")
					(args
						_progress = "currentValue.progress"
						_prevProgress = "previousValue.progress"
						_rank = "rank"
						_prevRank = "prevRank"
					)
				)
			)

			(tf
				(class $TextDefaultNM)
				(style
					(width = 100%)
					(textAlign = "center")
					(alpha = "TA")
				)
				(bind text "description")
			)
		)
	)

	(block
		(style
			(width = "LEAGUE_ICON_SIZE")
			(height = "LEAGUE_ICON_SIZE")
		)

		(block
			(class $Fullsize)
			(style (align = "center"))
			
			(block
				(visible = false)
				(class $FullsizeAbsolute)
				(style (alpha = 0))
				(colorTransform = "CT_NONE")

				(element MasteryIconWithRank
					_imagePath = "leagueSaved < TOP_LEAGUE ? 'url:../ship_mastery/league/level_' + leagueSaved + '.png' : ''"
					_rank = "prevRank"
				)

				(controller $Animation
					(bindcall play
						keyframes="[
							{time: 0,	to: {	alpha: 1,
												visible: true,
												colorTransform: CT_NONE}},
							{time: 0.5,	to: {	alpha: 1,
												visible: true,
												colorTransform: CT_NONE}},
							{time: 0.9,	to: {	alpha: 0,
												visible: false,
												colorTransform: MASTERY_EMBLEM_CT_WHITE}}]"
							(event "evLeagueChanged")
					)
					(dispatch evFakeIconAnimStartedWithDelay dir="EventDirection.DOWN" on=evAnimStarted)
				)
			)

			(block
				(style
					(position = "absolute")
					(left = -50px)
					(top = -50px)
					(width = 300px)
					(height = 300px)
				)
				(controller $FxInstance renderer='LeagueChangedAnimation' lifetime=3
					(bindcall create (event "evLeagueChanged"))
				)
			)

			(block
				(class $FullsizeAbsolute)
				(element LeagueIconAnimated
					_league = "league.value"
					_rank = "rank"
					_isHidden = "league.value != leagueSaved"
				)
			)

			(block
				(style
					(position = "absolute")
					(left = "LM")
					(top = 50px)
					(width = 160px)
					(height = 146px)
					(backgroundColor = "NO_COLOR")
				)
				(controller $Tooltip
					(renderer='ShipMasteryLeagueTooltip')
					(args
						_points = "points"
						_currentRank = "rank"
					)
					(macro DEFAULT_TOOLTIP_BEHAVIOUR)
				)
			)
		)

		(block
			(class $MasteryAnimationStyle)
			(style
				(backgroundImage = 'url:../animations/spine/mastery/icon_league.skel')
				(bind alpha "league.value != leagueSaved ? 0 : 1")
			)
			(controller $Spine
				(bind enabled "league.value == leagueSaved")
				(bindcall play sequence="{name: iconName}" init=true (event "startShow"))
				(bindcall play sequence="{name: iconName}" watch=false (event "evMasteryEmblemAnimEnded"))
				(bindcall pause (event "evLeagueChanged"))
			)
		)
	)
)


(def element LeagueChangedAnimation ()
	(class $Fullsize)
	(style (backgroundImage = 'url:../animations/spine/mastery/league_change.skel'))
	(controller $Spine)
)

(def element LeagueIconAnimated (_league:number = 0, _rank:number = 0, _isHidden:bool = false)
	(scope
		(event evLeagueChanged)

		(var iconName:str = "_league == TOP_LEAGUE ? 'top_rank' : 'level_' + _league")
	)
	(colorTransform = "CT_NONE")
	(style
		(width = "LEAGUE_ICON_SIZE")
		(height = "LEAGUE_ICON_SIZE")
		(align = "center")
		(pivotX = 50%)
		(pivotY = 50%)
		(bind alpha "_isHidden ? 0 : 1")
	)

	
	(controller $Animation
		(bindcall play
			easing="Easing.quad_in"
			keyframes="[
				{	time: 0,
					to: {	alpha: 0,
							scaleX: 0,
							scaleY: 0,
							colorTransform: MASTERY_EMBLEM_CT_WHITE}},
				{	time: 0.2,
					to: {	alpha: 0,
							scaleX: 0,
							scaleY: 0,
							colorTransform: MASTERY_EMBLEM_CT_WHITE,
							rotation: -6.5}},
				{	time: 0.3,
					to: {	alpha: 0.3,
							scaleX: 0.5,
							scaleY: 0.5,
							colorTransform: MASTERY_EMBLEM_CT_WHITE}},
				{	time: 0.38,
					to: {	alpha: 1,
							scaleX: 1.2,
							scaleY: 1.2,
							rotation: 0}},
				{	time: 1.05,
					to: {	scaleX: 1,
							scaleY: 1,
							colorTransform: CT_NONE}}]"
				(event "evLeagueChanged")
		)
		(dispatch evMasteryEmblemAnimEnded dir="EventDirection.UP" on=evAnimEnded)
	)

	(element MasteryIconWithRank
		_imagePath = "'url:../ship_mastery/league/' + iconName + '.png'"
		_rank = "_rank"
	)
)

(def element MasteryIconWithRank (_imagePath:str = '', _rank:number = 0)
	(style
		(width = "LEAGUE_ICON_SIZE")
		(height = "LEAGUE_ICON_SIZE")
		(align = "center")
		(backgroundSize = "fill")
		(bind backgroundImage "_imagePath")
	)
	(tf
		(bind visible "_rank != SC.Common.SHIP_MASTERY_CONSTANTS.MAX_RANK")
		(class $TextDefaultBold40NM)
		(style
			(marginLeft = "-XXS")
			(marginTop = 82px)
			(alpha = "TA")
		)
		(bind text "_rank")
	)
)

(def element MasteryProgressBar (_progress:number, _prevProgress:number = 0, _rank:number = 0, _prevRank:number = 0)
	(scope
		(event evAddedToStage)

		(var progressValue:number = "_progress	?	_progress > 1	?	1
																	:	_progress
												:	0")
		(var prevProgressValue:number = "_prevProgress	?	_prevProgress > 1	?	1
																				:	_rank != _prevRank	?	0
																										:	_prevProgress
														:	0")
		(var animatedProgressWidth:number = "progressValue" watch=false)

		(controller $Animation
			(bindcall play	from = "{ animatedProgressWidth: prevProgressValue }"
							to = "{ animatedProgressWidth: progressValue }"
							duration = 0.3
							delay = 0.1
							easing = "Easing.line"
							(bind trigger "_progress")
							(event "evAddedToStage")
			)
			(dispatch evProgressAnimEnded delay=0.4 dir="EventDirection.UP" on=evAnimEnded)
		)
	)
	(style (width = 100%))
	(element DefaultProgressBar
		_progress = "animatedProgressWidth"
		_size = "SIZE.SMALL"
		_width = 100%
	)

	(dispatch evAddedToStage on='addedToStage')
)

(def element ShipMasteryLeagueTooltip (_points:number = 0, _currentRank:number = 0)
	(scope
		(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_SCOPE)
	)
	(style
		(hitTest = false)
		(width = 400px)
	)
	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_MARKUP)

	(element TOOLTIP_SYSTEM_DEFAULT_CONTAINER
		(hblock
			(style (width = 100%))

			(element TooltipSystemHeaderSubheaderText
				_headerText='IDS_SHIP_MASTERY_LEAGUE_TOOLTIP_HEADER'
			)

			(element DefaultDividedCounter
				_curValueTextClass = '$TextDefaultBold20NM'
				_curValue = "_currentRank"
				_maxValue = "SC.Common.SHIP_MASTERY_CONSTANTS.MAX_RANK"
				_doNotAlphaOnZeroCurValue = true
			)
		)

		(element TooltipSystemHorizontalDivider)

		(element TooltipSystemDescriptionText
			_descriptionText = "subst('IDS_SHIP_MASTERY_LEAGUE_TOOLTIP_POINTS',[], {_points: formatSeparator(_points)}, _points)"
		)
	)
)

(def element ShipMasterySelectShipWarning ()
	(style
		(width = 400px)
		(height = 91px)
		(align = "center|middle")
		(scale9grid = 4)
		(backgroundImage = 'url:../ship_mastery/league_bg.png')
	)
	(tf
		(class $TextDefaultBold22NM)
		(style (textColor = "SC.Ui_styles.SERVICE_COLORS.ORANGE"))
		(text = 'IDS_SHIPS_MASTERY_SELECT_SHIP')
	)
)
