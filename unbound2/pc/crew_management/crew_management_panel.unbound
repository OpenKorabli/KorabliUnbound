(def constant CREW_MANAGEMENT_ABILITIES_INSET 0)
(def constant CREW_MANAGEMENT_ASSIGN_INSET 1)

(def element CrewNationSpecializationBlock (_crewId:number = 0, _crewHistoryId:number = 0)
	(scope
		(struct crewReal =		PULL_CREW(_crewId = "_crewId"))
		(struct crewHistory =	PULL_CREW_HISTORY_INFO(_crewHistoryId = "_crewHistoryId"))

		(var crew:dhComponent =		"_crewId ? crewReal.component : crewHistory.component")

		(var crewNation:str =	"crew.nation"	(event "crew.evChanged"))
		(var isNoNation:bool =	"crewNation == SC.Common.NATION.COMMON")
	)

	(style (width = 100%))

	(block
		(style (width = 100%))
		(controller $Instance renderer='StatusLine'
			(bind enabled "isNoNation")
			(args
				_unifiedStatus =	"SC.Ui_styles.UNIFIED_STATUS.INFO"
				_text =				'IDS_NO_NATION_CREW'
			)
		)
	)

	(tf
		(bind visible "!isNoNation")

		(class $TextDefaultNM)
		(style (width = 100%) (marginBottom = "XS") (alpha = "TA"))
		(text = 'IDS_CREW_SPECIALIZATION_TO_NATION')
	)

	(block
		(bind visible "!isNoNation")

		(style
			(flow = "horizontal")
			(align = "middle")
			(marginBottom = -5px)
		)

		(element NationFlagsTiny _shipCountry = "crewNation")

		(tf
			(class $TextDefault18NM)
			(style (marginLeft = "S") (alpha = "TA"))

			(bind text "isNoNation ? '' : tr(toUpper('IDS_' + crewNation))")
		)
	)
)

(def element CrewPanelSpecializationAdoptationBlock (_crewId:number, _crewHistoryId:number = 0, _isShipVisible:bool = false, _isSmallPanel:bool = false)
	(scope
		(struct crewReal =		PULL_CREW(_crewId = "_crewId"))
		(struct crewHistory =	PULL_CREW_HISTORY_INFO(_crewHistoryId = "_crewHistoryId"))

		(var crew:dhComponent = "_crewId ? crewReal.component : crewHistory.component")
		(var retrainingComponent:dhComponent = "crewReal.entity.retraining")

		(var curShipId:number =		"crew.shipID"	(event "crew.evShipChanged"))
		(var isInAdaptation:bool =	"retrainingComponent != null")

		(var label:str = "isInAdaptation	? _isShipVisible	? 'IDS_CREW_IN_ADAPTATION_TO_ANOTHER_SHIP'
																: 'IDS_CREW_IN_ADAPTATION_TO_SELECT_SHIP'
											: 'IDS_CREW_SPECIALIZATION_TO_SELECT_SHIP'")

		(var unifiedStatus:str = "isInAdaptation ? SC.Ui_styles.UNIFIED_STATUS.ATTENTION : SC.Ui_styles.UNIFIED_STATUS.DEFAULT")

		(var adaptationXpBarSpacing:number = "_isSmallPanel ? XS : S")
	)

	(style (width = 100%) (backgroundColor = "NO_COLOR"))

	(controller $Tooltip
		(renderer='CrewSpecializationAdoptationTooltip')
		(args
			_isInAdaptation = "isInAdaptation"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		(align = "top|right")
	)

	(block
		(bind visible "crew.specializationID != curShipId || isInAdaptation")
		(style (width = 100%) (marginBottom = 3px))

		(controller $Instance renderer='ShipWithLabel'
			(bind enabled "crew.specializationID != curShipId || isInAdaptation")
			(args
				_shipId = "_isShipVisible ? crew.specializationID : null"
				_unifiedStatus = "unifiedStatus"
				_label = "label"
			)
		)
	)

	(block
		(bind visible "isInAdaptation")

		(style (width = 100%) (bind marginTop "isInAdaptation ? adaptationXpBarSpacing : 0"))

		(controller $Instance renderer='CrewExperienceBar'
			(bind enabled "isInAdaptation")
			(args
				_crewId = "_crewId"
			)
		)
	)
)

(def element CrewSpecializationAdoptationTooltip (_isInAdaptation:bool)
	(style (width = 320px) (hitTest = false))
	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND)
	
	(element TOOLTIP_SYSTEM_DEFAULT_CONTAINER
		(element TooltipSystemHeaderSubheaderText
			_headerText = "_isInAdaptation ? 'IDS_TOOLTIP_DESC_CREW_IN_ADAPTATION_HEADER' : 'IDS_TOOLTIP_CREW_SPECIALIZATION_HEADER'"
		)

		(element TooltipSystemHorizontalDivider)
		(element TooltipSystemDescriptionText
			_descriptionText = "_isInAdaptation ? 'IDS_TOOLTIP_DESC_CREW_IN_ADAPTATION_DESC_ONE' : 'IDS_TOOLTIP_DESC_CREW_SPECIALIZATION_TO_SELECT_SHIP'"
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemHorizontalDivider' (bind enabled "_isInAdaptation"))
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemDescriptionText'
				(bind enabled "_isInAdaptation")
				(args
					_descriptionText = 'IDS_TOOLTIP_DESC_CREW_IN_ADAPTATION_DESC_TWO'
				)
			)
		)
	)
)

(def element CrewPanel (_currentRoute:str, _crewId:number = 0, _shipId:number = 0, _isCrewInfoModalWindow:bool = false)
	(scope
		(macro STAGE_SIZE)
		(var isSmallPanel:bool = "stageHeight < CREW_MANAGEMENT_SMALL_HEIGHT_THRESHOLD")

		(macro PULL_SHIP_ID)

		(struct crew =			PULL_CREW(_crewId = "_crewId"))
		(struct permissions =	PULL_CREW_PERMISSIONS(_crew = "crew.component"))

		(var isDisabledCrewPanel:bool = 	"permissions.isDisabledBarracks && permissions.isDisabledCrewFire")
		(var skillMatrixId:number =			"crew.component.skillMatrixId ?: 0" (event "crew.component.evChanged"))
		(var isButtonsBlockVisible:bool =	"_crewId > 0 && skillMatrixId")

		(var rendererName:str =		"_crewId > 0 ? 'CrewPanelContent' : 'CrewPanelEmptyContent'")
	)

	(style (width = 100%))

	(block
		(style (width = 100%))

		(controller $Instance
			(bind renderer "rendererName")
			(args
				_crewId =					"_crewId"
				_shipId =					"viewedShipId"
				_isSmallPanel =				"isSmallPanel"
				_isCrewInfoModalWindow =	"_isCrewInfoModalWindow"
			)
		)
	)

	(block
		(style (width = 100%) (bind marginTop "isSmallPanel ? S : SXS"))

		(controller $Instance renderer='CrewPanelEmptyButtons'
			(bind enabled "_crewId == 0")
			(args
				_isSmallPanel =	"isSmallPanel"
			)
		)

		(controller $Instance renderer='CrewPanelCommonButtons'
			(bind enabled "!isDisabledCrewPanel && isButtonsBlockVisible")
			(args
				_currentRoute =	"_currentRoute"
				_isSmallPanel =	"isSmallPanel"
			)
		)

		(controller $Instance renderer='StatusLine'
			(bind enabled "isDisabledCrewPanel && isButtonsBlockVisible")
			(args
				_text = 'IDS_DISABLE_CREW_PANEL'
				_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.ATTENTION"
				_width = "100%"
			)
		)
	)
)

(def element CrewPanelEmptyContent (_shipId:number, _isSmallPanel:bool = false)
	(scope
		(var size:number =				"_isSmallPanel ? SIZE.MEDIUM : SIZE.LARGE")
		(var infoStatusMargin:number =	"_isSmallPanel ? S : SXS")

		(var shipEntity:dhEntity =			"getPrimaryEntity(CC.ownShip, _shipId)")
		(var shipInfo:dhComponent =			"shipEntity.ship" (event "shipEntity.ship.evUpdate"))
		(var isWithoutCrewPenalty:bool =	"shipInfo.isWithoutCrewPenalty")
	)

	(style (width = 100%) (align = "center"))

	(element CrewStereotypeWithName
		_size = "size"
	)

	(tf
		(class $TextDefaultNM)
		(style (width = 100%) (marginTop = "XS") (marginLeft = -6px) (leading = -3) (alpha = "TA"))
		(text = 'IDS_CREW_HIRE_CREW_DESCRIPTION_0')
	)

	(tf
		(class $TextDefaultNM)
		(style (width = 100%) (marginTop = "SXS") (marginLeft = -6px) (leading = -3) (alpha = "TA"))
		(text = 'IDS_CREW_HIRE_CREW_DESCRIPTION_1')
	)

	(block
		(style (width = 100%) (bind marginTop "isWithoutCrewPenalty ? infoStatusMargin : 0"))

		(controller $Instance renderer='HorizontalDividerTwoPx' (bind enabled "isWithoutCrewPenalty"))
	)

	(block
		(style (width = 100%) (bind marginTop "isWithoutCrewPenalty ? infoStatusMargin : 0"))

		(controller $Instance renderer='StatusLine'
			(bind enabled "isWithoutCrewPenalty")
			(args
				_unifiedStatus =	"SC.Ui_styles.UNIFIED_STATUS.INFO"
				_text =				'IDS_NO_SPECIALIZATION_REQUIRED_FOR_SHIP_STATUS_LINE'
				_width =			100%
			)
		)
	)
)

(def element CrewPanelContent (_crewId:number = 0, _shipId:number = 0, _isCrewInfoModalWindow:bool = false, _isSmallPanel:bool = false)
	(scope
		(struct crew =			PULL_CREW(_crewId = "_crewId"))
		(var retrainingComponent:dhComponent = "crew.entity.retraining")

		(var shipEntity:dhEntity = "getPrimaryEntity(CC.ownShip, _shipId)")
		(var ownShipComponent:dhComponent = "shipEntity.ownShip")

		(var shipSubtype:str = "shipEntity.shipComponent.subtype ?: ''")

		(var isMaxLevel:bool =			"crew.component.isMaxLevel"					(event "crew.component.evLevelUp"))
		(var specializationID:number =	"crew.component.specializationID ?: 0"		(event "crew.component.evChanged"))
		(var timeRent:number =			"crew.component.timeRent ?: 0"				(event "crew.component.evTimeRentChanged") (event "crew.component.evChanged"))
		(var skillMatrixId:number =		"crew.component.skillMatrixId ?: 0"			(event "crew.component.evChanged"))
		(var allSkillPoints:number =	"crew.component.allSkillPoints ?: 0"		(event "crew.component.evLevelUp"))
		(var crewNation:str =			"crew.component.nation ?: ''"				(event "crew.component.evChanged"))
		(var rarity:number =			"crew.component.rarity"						(event "crew.component.evRarityChanged"))

		(var isCurrencyDeficit:bool =	"retrainingComponent.allTypesBlocked"		(event "retrainingComponent.evRetrainingUpdated"))

		(var isShipInBalancer:bool =		"ownShipComponent.lock == SC.Common.OWN_SHIP_LOCK.BALANCER"				(event "ownShipComponent.evUpdateLock"))
		(var isShipReadyForBattle:bool =	"ownShipComponent.lock == SC.Common.OWN_SHIP_LOCK.DIVISION_IS_READY"	(event "ownShipComponent.evUpdateLock"))

		(var isInAdaptation:bool =	"retrainingComponent != null")
		(var isXpBarVisible:bool =	"crew.component && !isMaxLevel && !isInAdaptation && skillMatrixId")

		
		(var isCrewSpecialization:bool = "specializationID > 0")
		(var isEmptyCrew:bool = "crewNation == SC.Common.NATION.COMMON")
		(var isCrewNationSpecialization:bool = "!isCrewSpecialization && !isEmptyCrew")

		(var isCrewElite:bool = "rarity == SC.Common.UNIFIED_ITEM_RARITY.ELITE")
		(var canCrewBeUpgradedToElite:bool =	"isIn(rarity, SC.Common.UNIFIED_ITEM_RARITY.COMMANDERS_CAN_BECOME_ELITE)")

		(var hasAnySpecialization:bool = "isCrewSpecialization || isCrewNationSpecialization")

		(var isThisShipSpecDiffersFromCrewShipSpec:bool =	"specializationID != _shipId")
		(var isFastTrainingButtonVisible:bool =				"!(isInAdaptation || isMaxLevel) && skillMatrixId")
		(var isSpecializationAdoptationVisible:bool =		"(isThisShipSpecDiffersFromCrewShipSpec || isInAdaptation) && !isCrewNationSpecialization")
		(var isCrewNationSpecializationBlockVisible:bool =	"_isCrewInfoModalWindow && _shipId == 0 && !isSpecializationAdoptationVisible")
		(var isShipPreparedBlockVisible:bool =				"!isCrewNationSpecializationBlockVisible && isThisShipSpecDiffersFromCrewShipSpec && specializationID != 0 && !isInAdaptation")
		(var isCrewPanelAssignedBlockVisible:bool =			"_isCrewInfoModalWindow && (!isInAdaptation || (isInAdaptation && isThisShipSpecDiffersFromCrewShipSpec))")

		(var isFastTrainingDisabled:bool = "isShipReadyForBattle || isShipInBalancer || isInAdaptation || isEmptyCrew ")

		(var fastTrainingDenyReason:dict = "isShipInBalancer 		? {	text: 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER',
																		unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.WARNING } :
											isShipReadyForBattle	? { text: 'IDS_FAST_TRAINING_DISABLE_REASON_SHIP_IS_IN_FORMATION',
																		unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.NEGATIVE } :
											isInAdaptation			? { text: 'IDS_FAST_TRAINING_DISABLE_REASON_IN_ADAPTATION',
																		unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.NEGATIVE } :
											isEmptyCrew				? { text: 'IDS_FAST_TRAINING_DISABLE_REASON_NATION_COMMON',
																		unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.NEGATIVE }
																	: null")

		(var finishTrainingDenyReason:dict = "	isShipInBalancer 		? {	text: 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER',
																			unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.WARNING } :
												isShipReadyForBattle 	? {	text: 'IDS_RETRAINING_DISABLE_REASON_SHIP_IS_IN_FORMATION',
																			unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.NEGATIVE } :
												isCurrencyDeficit		? {	text: 'IDS_NOT_ENOUGH_FUNDS',
																			unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.NEGATIVE } 
																		: null")

		(var crewStereotypeSize:number = "_isSmallPanel ? SIZE.MEDIUM : SIZE.LARGE")
		(var isRental:bool = "timeRent > 0")

		(var buttonSize:number =	"_isSmallPanel ? SIZE.SMALL : SIZE.MEDIUM")
		(var elemSpacing:number =	"_isSmallPanel ? S : SXS")

		(var levelText:str = "subst(isMaxLevel ? 'IDS_CREW_PANEL_MAX_LEVEL' : 'IDS_CREW_PANEL_LEVEL', [], {crewLevel: allSkillPoints})")
		(var substituteMap:dict = "{	'[el_left_sm]': 'elite_wreath_left_small',
										'[el_right_15_sm]':'elite_wreath_right_15_small' }")

		(var crewDataEntity:dhEntity =	"getSingleEntity(CC.crewData)")
		(var crewData:dhComponent =		"crewDataEntity.crewData")
		(var booksAmount:number =		"crewData.eliteCrewBooksCount ?: 0"		(event "crewData.evEliteCrewBooksCountChanged"))
		(var doesPlayerHaveBook:bool =	"booksAmount > 0")
		(var canConvertIntoElite:bool =	"doesPlayerHaveBook && !isRental && canCrewBeUpgradedToElite")

		(var isCrewInfoLowerDividerVisible:bool = "_isCrewInfoModalWindow && (isCrewElite || canConvertIntoElite)")
		(var isEliteMentorshipNew:bool = "crew.entity.hasComponent(CC.newItem)")

		(var doesPlayerHaveNewEliteBooks:bool =	"crewDataEntity.hasComponent(CC.newItem)")
		(var isNewEliteBookMarkerShown:bool =	"doesPlayerHaveNewEliteBooks && canConvertIntoElite")

		(var isCrewInfoVisible:bool = "!_isCrewInfoModalWindow && skillMatrixId")

		(var crewInfoTooltipData:dict = "	!hasAnySpecialization	? {	text: 'IDS_HINT_CREW_WITHOUT_NATION',
																		unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.ATTENTION }
																	: null")
	)
	(macro UNIFIED_STATUS_TO_COLOR_AND_ALPHA "SC.Ui_styles.UNIFIED_STATUS.ATTENTION" "'attentionTextColor'" "'attentionTextAlpha'")

	(style (width = 100%) (align = "center"))

	(element CrewStereotypeWithName
		_crewId =			"_crewId"
		_shipClass =		"shipSubtype"
		_size =				"crewStereotypeSize"
		_isRentIconHidden =	true
		_hideSkillPoints =	true
	)

	(block
		(bind visible "skillMatrixId && allSkillPoints > 0")
		(style (width = 100%) (marginTop = "SXS"))

		(tf
			(class $TextDefaultNM)
			(name = 'crew_level')
			(style (alpha = "TA"))
			(bindcall substitute imageOffset="6" substitutionMap="substituteMap" sourceText="levelText" postfix='' init=true)
		)
	)


	
	(block
		(bind visible "isXpBarVisible")

		(style
			(width = 100%)
			(marginTop = "S")
			(marginBottom = "XS")
		)

		(block
			(style (width = 100%))

			(controller $Instance renderer='CrewExperienceBar'
				(bind enabled "isXpBarVisible")
				(args
					_crewId = "_crewId"
				)
			)
		)
	)

	(block
		(bind visible "isInAdaptation")

		(style
			(width = 100%)
			(bind marginTop "elemSpacing")
			(marginBottom = "XS")
		)

		(controller $Instance renderer='CrewPanelSpecializationAdoptationBlock'
			(bind enabled "isInAdaptation")
			(args
				_crewId =			"_crewId"
				_isShipVisible =	"isThisShipSpecDiffersFromCrewShipSpec || _isCrewInfoModalWindow"
				_isSmallPanel =		"_isSmallPanel"
			)
		)
	)
	

	
	(block
		(bind visible "isFastTrainingButtonVisible")

		(style (bind marginTop "elemSpacing") (width = 100%))

		(controller $Instance renderer='DefaultButton'
			(bind enabled "isFastTrainingButtonVisible")
			(args
				_size =					"buttonSize"
				_width =				100%
				_label =				'IDS_FAST_TRAINING_BUTTON_LABEL'
				_isTransactionBtn =		true
				_enabled =				"!isFastTrainingDisabled"
				_methods =				"[{ type: 'inputMapping.onRequest', name: CREW_ACTIONS.OPEN_FAST_TRAINING_WINDOW, args: { crewID: _crewId } }]"
				_focusIndex =			0
			)
		)

		(controller $Tooltip
			(renderer='SimpleStatusTooltip')
			(bind enabled "isFastTrainingButtonVisible && isFastTrainingDisabled")
			(args
				_unifiedStatus =	"fastTrainingDenyReason.unifiedStatus"
				_text =				"fastTrainingDenyReason.text"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)

	(block
		(style (width = 100%) (bind marginTop "isInAdaptation ? elemSpacing : 0"))

		(controller $Instance renderer='DefaultButton'
			(bind enabled "isInAdaptation")
			(args
				_label =				'IDS_FINISH_RETRAINING_BUTTON'
				_size =					"buttonSize"
				_width =				220px
				_focusIndex =			0
				_isTransactionBtn =		true
				_enabled =				"!finishTrainingDenyReason"
				_methods =				"[{ type: 'inputMapping.onRequest', name: CREW_ACTIONS.OPEN_CREW_RETRAIN_WINDOW, args: { shipId: _shipId, crewId: _crewId} }]"
			)
		)

		(controller $Tooltip
			(renderer='SimpleStatusTooltip')
			(bind enabled "isInAdaptation && finishTrainingDenyReason")
			(args
				_unifiedStatus =	"finishTrainingDenyReason.unifiedStatus"
				_text =				"finishTrainingDenyReason.text"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)
	

	
	(block
		(bind visible "isCrewInfoVisible")

		(style (width = 100%) (bind marginTop "elemSpacing"))
		(block
			(style (width = 100%))
			(controller $Instance renderer='DefaultButton'
				(bind enabled "isCrewInfoVisible")
				(args
					_enabled =		"hasAnySpecialization"
					_size =			"buttonSize"
					_width =		100%
					_label =		'IDS_PERSONAL_FILE_BUTTON_LABEL'
					_methods =		"[{ type: 'inputMapping.onRequest', name: CREW_ACTIONS.OPEN_CREW_INFO_WINDOW, args: { _crewId: _crewId } }]"
					_focusIndex =	1
				)
			)
		)

		(block
			(style
				(hitTest = false)
				(position = "absolute")
				(bind right "_isSmallPanel ? 74px : XL")
				(bind top "_isSmallPanel ? 0 : XXS")
			)

			(block
				(macro DEFAULT_CONTROL_MARKER_ANIMATION "isEliteMentorshipNew || isNewEliteBookMarkerShown")
				(style
					(position = "absolute")
					(top = -9px)
					(right = "_isSmallPanel ? -74px + M : -XL + M")
				)

				(element MarkerNew)
			)
		)

		(controller $Tooltip
			(renderer='SimpleStatusTooltip')
			(bind enabled "!hasAnySpecialization")
			(args
				_unifiedStatus =	"crewInfoTooltipData.unifiedStatus"
				_text =				"crewInfoTooltipData.text"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)
	

	
	(block
		(style (width = 100%) (bind marginTop "isRental ? SXS : 0"))
		(controller $Instance renderer = 'HorizontalDividerTwoPx' (bind enabled "isRental"))
	)

	(block
		(style (width = 100%) (bind marginTop "isRental ? elemSpacing : 0"))
		(controller $Instance renderer='CrewPanelRentTimer'
			(bind enabled "isRental")
			(args
				_crewId = "_crewId"
			)
		)
	)
	

	
	(block
		(style (width = 100%) (bind marginTop "isCrewNationSpecializationBlockVisible ? elemSpacing : 0"))
		(controller $Instance renderer='HorizontalDividerTwoPx' (bind enabled "isCrewNationSpecializationBlockVisible"))
	)

	(block
		(style (width = 100%) (bind marginTop "isCrewNationSpecializationBlockVisible ? elemSpacing : 0"))
		(controller $Instance renderer='CrewNationSpecializationBlock'
			(bind enabled "isCrewNationSpecializationBlockVisible")
			(args
				_crewId = "_crewId"
			)
		)
	)
	

	
	(block
		(bind visible "isShipPreparedBlockVisible")

		(style
			(width = 100%)
			(marginBottom = 3px)
			(bind marginTop "elemSpacing")
		)

		(block
			(bind visible "isShipPreparedBlockVisible")
			(style
				(width = 100%)
				(bind marginBottom "elemSpacing")
			)
			(controller $Instance renderer='HorizontalDividerTwoPx' (bind enabled "isShipPreparedBlockVisible"))
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='ShipWithLabel'
				(bind enabled "isShipPreparedBlockVisible")
				(args
					_shipId =	"specializationID"
					_label =	'IDS_CREW_SPECIALIZATION_TO_SELECT_SHIP'
				)
			)
		)

		(controller $Tooltip
			(renderer='CrewSpecializationAdoptationTooltip')
			(args
				_isInAdaptation = "isInAdaptation"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
			(align = "top|right")
		)
	)
	

	
	(block
		(style
			(width = 100%)
			(bind marginTop "isCrewPanelAssignedBlockVisible ? elemSpacing : 0")
		)

		(controller $Instance renderer='CrewPanelAssignedBlock'
			(bind enabled "isCrewPanelAssignedBlockVisible")
			(args
				_shipId =		"_shipId"
				_isSmallPanel =	"_isSmallPanel"
			)
		)
	)
	

	(block
		(style
			(width = 100%)
			(bind marginTop "(skillMatrixId && !_isCrewInfoModalWindow) || isCrewInfoLowerDividerVisible ? elemSpacing : 0")
		)

		(controller $Instance renderer = 'HorizontalDividerTwoPx' (bind enabled "(skillMatrixId && !_isCrewInfoModalWindow) || isCrewInfoLowerDividerVisible"))
	)
)

(def element CrewPanelAssignedBlock (_shipId:number = 0, _isSmallPanel:bool = false)
	(scope
		(macro PULL_SHIP_ID)
		(var isFromBarracksStatusVisible:bool =		"_shipId == 0")
		(var isToProceedToSkillsBtnVisible:bool =	"_shipId > 0 && _shipId != playerShipId")
	)

	(style (width = 100%))

	(element HorizontalDividerTwoPx)

	(block
		(bind visible "_shipId > 0")

		(style
			(width = 100%)
			(marginBottom = 3px)
			(bind marginTop "_isSmallPanel ? S : SXS")
		)

		(controller $Instance renderer='ShipWithLabel'
			(bind enabled "_shipId > 0")
			(args
				_shipId = "_shipId"
				_label = 'IDS_CREW_ASSIGNED_TO_SELECT_SHIP'
			)
		)
	)

	(block
		(bind visible "isToProceedToSkillsBtnVisible")

		(style (width = 100%) (bind marginTop "_isSmallPanel ? S : SXS"))

		(controller $Instance renderer='DefaultButton'
			(bind enabled "isToProceedToSkillsBtnVisible")
			(args
				_type =		"SC.Ui_styles.BUTTON_TYPE.SECONDARY"
				_size =		"SIZE.SMALL"
				_width =	96px
				_label =	'IDS_TO_ABILITIES_BUTTON'
				_methods =	"[	{ type: 'inputMapping.onAction', name: 'selectShip', args: { shipId: _shipId } },
								{ type: 'inputMapping.onRequest', name: CREW_ACTIONS.CLOSE_SKILLS_INFO_WINDOW, args: {} } ]"
			)
		)
	)

	(block
		(bind visible "isFromBarracksStatusVisible")

		(style
			(width = 100%)
			(bind marginTop "isFromBarracksStatusVisible	? _isSmallPanel ? S : SXS
															: 0")
		)

		(controller $Instance renderer='StatusLine'
			(bind enabled "isFromBarracksStatusVisible")
			(args
				_text = 'IDS_CREW_IN_BARRACKS'
			)
		)
	)
)

(def element CrewPanelCommonButtons (_currentRoute:str, _isSmallPanel:bool = false)
	(scope
		(macro PULL_SHIP_ID)

		(var shipEntity:dhEntity = "getPrimaryEntity(CC.ownShip, playerShipId)")
		(var ownShipComponent:dhComponent = "shipEntity.ownShip")

		(var isShipReadyForBattle:bool =	"ownShipComponent.lock == SC.Common.OWN_SHIP_LOCK.DIVISION_IS_READY"	(event "ownShipComponent.evUpdateLock"))
		(var isShipInBalancer:bool =		"ownShipComponent.lock == SC.Common.OWN_SHIP_LOCK.BALANCER"				(event "ownShipComponent.evUpdateLock"))

		(var crewId:number = "ownShipComponent.crewId" (event "ownShipComponent.evCrewChanged"))

		(var isCrewDemobilizationAccess:bool = "!isShipInBalancer && !isShipReadyForBattle")

		(struct crew =			PULL_CREW(_crewId = "crewId"))
		(struct permissions =	PULL_CREW_PERMISSIONS(_crew = "crew.component"))

		(var isDisabledCrewPanel:bool =			"permissions.isDisabledBarracks && permissions.isDisabledCrewFire")

		(var crewData:dhComponent =			"getSingleComponent(CC.crewData)")
		(var freeBarracksSlots:number =		"crewData.freeBarracksSlots ?: 0"	(event "crewData.evFreeBarracksSlotsChanged"))
		(var canDisassignCrew:bool =		"freeBarracksSlots > 0")

		(var isDisassignButtonEnabled:bool = "!isShipInBalancer && !isShipReadyForBattle && canDisassignCrew")

		(var disassignDisableTooltipText:str =	"	isShipInBalancer		? 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER' :
													isShipReadyForBattle	? 'IDS_DISASSIGN_CREW_DENY_REASON_IN_FORMATION' :
													!canDisassignCrew		? 'IDS_ASSIGN_NEW_CREW_DISABLE_REASON_FULL_BARRACKS'
																			: ''")


		(var fireCrewTooltipText:str =	"	isShipInBalancer		? 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER' :
											isShipReadyForBattle	? 'IDS_FIRE_CREW_DENY_REASON_IN_FORMATION'
																	: ''")

		(var disassignDisableTooltipStatus:str =	"isShipInBalancer ? SC.Ui_styles.UNIFIED_STATUS.WARNING : SC.Ui_styles.UNIFIED_STATUS.NEGATIVE")
		(var fireCrewTooltipStatus:str = 			"isShipInBalancer ? SC.Ui_styles.UNIFIED_STATUS.WARNING : SC.Ui_styles.UNIFIED_STATUS.NEGATIVE")

		(var isCrewAbilitiesInset:bool =	"_currentRoute == SC.Ui_windows.ROUTE.CREW_ABILITIES_MANAGEMENT")
		(var crewManagementInset:number =	"isCrewAbilitiesInset ? CREW_MANAGEMENT_ASSIGN_INSET : CREW_MANAGEMENT_ABILITIES_INSET")

		(var buttonSize:number =	"_isSmallPanel ? SIZE.SMALL : SIZE.MEDIUM")
		(var buttonMargin:number =	"_isSmallPanel ? S : SXS")
	)

	(style (width = 100%))

	(block
		(bind visible "!permissions.isDisabledBarracks")

		(style
			(width = 100%)
			(bind marginBottom "!permissions.isDisabledBarracks ? buttonMargin : 0")
		)

		(controller $Instance renderer='DefaultButton'
			(bind enabled "!permissions.isDisabledBarracks")
			(args
				_type =				"SC.Ui_styles.BUTTON_TYPE.SECONDARY"
				_name =				'CrewDisassignButton'
				_label =			'IDS_CREW_TO_BARRACKS'
				_size =				"buttonSize"
				_width =			100%
				_enabled =			"isDisassignButtonEnabled"
				_methods =			"[{ type: !disassignDisableTooltipText ? 'inputMapping.onAction' : '', name: CREW_ACTIONS.DISASSIGN, args: { crewId: crewId } }]"
				_isTransactionBtn =	true
				_focusIndex =		2
			)
		)

		(controller $Tooltip
			(bind enabled "disassignDisableTooltipText != ''")
			(renderer = 'SimpleStatusTooltip')
			(args
				_unifiedStatus =	"disassignDisableTooltipStatus"
				_text =				"disassignDisableTooltipText"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)

	(block
		(bind visible "!permissions.isDisabledCrewFire")

		(style
			(width = 100%)
			(bind marginBottom "!permissions.isDisabledCrewFire ? buttonMargin : 0")
		)

		(controller $Instance renderer='DefaultButton'
			(bind enabled "!permissions.isDisabledCrewFire")
			(args
				_type =				"SC.Ui_styles.BUTTON_TYPE.SECONDARY"
				_name =				'CrewFireButton'
				_label =			'IDS_CREW_FIRE'
				_size =				"buttonSize"
				_width =			100%
				_enabled =			"isCrewDemobilizationAccess"
				_methods =			"[{ type: 'inputMapping.onRequest', name: CREW_ACTIONS.OPEN_FIRE_CREW_WINDOW, args: { crewId: crewId } }]"
				_isTransactionBtn =	true
				_focusIndex =		3
			)
		)

		(controller $Tooltip
			(bind enabled "fireCrewTooltipText != ''")
			(renderer = 'SimpleStatusTooltip')
			(args
				_unifiedStatus =	"fireCrewTooltipStatus"
				_text =				"fireCrewTooltipText"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)

	(block
		(style (width = 100%))

		(controller $Instance renderer='DefaultButton'
			(bind enabled "!permissions.isDisabledBarracks")
			(args
				_label =			"isCrewAbilitiesInset ? 'IDS_ALL_CREW_BUTTON' : 'IDS_TO_ABILITIES_BUTTON'"
				_size =				"buttonSize"
				_width =			100%
				_focusIndex =		4
				_defaultFocused =	false
				_methods =			"[{ type: 'inputMapping.onAction', name: 'navigateTo', args: { route: isCrewAbilitiesInset	? SC.Ui_windows.ROUTE.CREW_ASSIGNMENTS_MANAGEMENT
																																: SC.Ui_windows.ROUTE.CREW_ABILITIES_MANAGEMENT } }]"
				_name =				'btn_replace_crew'
			)
		)
	)
)


(def element CrewPanelEmptyButtons (_isSmallPanel:bool = false)
	(scope
		(macro PULL_SHIP_ID)

		(var shipEntity:dhEntity = "getPrimaryEntity(CC.ownShip, playerShipId)")
		(var ownShipComponent:dhComponent = "shipEntity.ownShip")
		(var shipComponent:dhComponent = "shipEntity.ship")

		(var crewData:dhComponent =		"getSingleComponent(CC.crewData)")
		(var freeBarracksSlots:number =	"crewData.freeBarracksSlots ?: 0" (event "crewData.evFreeBarracksSlotsChanged"))

		(var lastBoardedCrewId:number =	"shipComponent.lastBoardedCrewId ?: 0"	(event "shipComponent.evLastBoardedCrewIdChanged")
																				(event "shipComponent.evUpdate"))

		(var isDemoWithoutStats:bool =		"shipComponent.group == SC.Ships.SHIP_GROUPS.DEMO_WITHOUT_STATS || shipComponent.group == SC.Ships.SHIP_GROUPS.DEMO_WITHOUT_STATS_PREM")
		(var isWithoutCrewPenalty:bool =	"shipComponent.isWithoutCrewPenalty" (event "shipComponent.evUpdate"))

		(var isShipInBalancer:bool =		"ownShipComponent.lock == SC.Common.OWN_SHIP_LOCK.BALANCER"				(event "ownShipComponent.evUpdateLock"))
		(var isShipReadyForBattle:bool =	"ownShipComponent.lock == SC.Common.OWN_SHIP_LOCK.DIVISION_IS_READY"	(event "ownShipComponent.evUpdateLock"))

		(var crewId:number =			"ownShipComponent.crewId"			(event "ownShipComponent.evCrewChanged"))
		(var ownShipTimeRent:number =	"ownShipComponent.timeRent ?: 0"	(event "ownShipComponent.evUpdateDockState"))

		(struct crew =		PULL_CREW(_crewId = "lastBoardedCrewId"))
		(var hasLastBoardedCrew:bool =					"crew.entity != null")
		(var otherShipId:number =						"crew.component.shipID"					(event "crew.component.evShipChanged"))
		(var lastBoarderCrewSpecializationId:number =	"crew.component.specializationID ?: 0"	(event "crew.component.evChanged"))
		(var isReturnLastCrewButtonVisible:bool =		"crewId == 0 && lastBoardedCrewId != 0 && hasLastBoardedCrew")

		(var otherShipEntity:dhEntity =	"getPrimaryEntity(CC.ownShip, otherShipId)")
		(var otherShipComponent:dhComponent = "otherShipEntity.ownShip")

		(var isOtherShipExist:bool =	"otherShipEntity != null")
		(var isInBalancerOtherShip:bool = "otherShipComponent.lock == SC.Common.OWN_SHIP_LOCK.BALANCER"				(event "otherShipComponent.evUpdateLock"))
		(var isInDivisionOtherShip:bool = "otherShipComponent.lock == SC.Common.OWN_SHIP_LOCK.DIVISION_IS_READY"	(event "otherShipComponent.evUpdateLock"))

		(var isLastBoardedCrewLocked:bool =		"isOtherShipExist && (isInBalancerOtherShip || isInDivisionOtherShip)")
		(var canAssignWithoutRetrain:bool =		"lastBoarderCrewSpecializationId == playerShipId || isWithoutCrewPenalty")
		(var isReturnButtonDisabled:bool =		"isShipInBalancer || isShipReadyForBattle || isLastBoardedCrewLocked")

		(var methodType:str =	"canAssignWithoutRetrain ? 'inputMapping.onAction' : 'inputMapping.onRequest'")
		(var methodName:str =	"canAssignWithoutRetrain ? CREW_ACTIONS.ASSIGN_TO_SHIP : CREW_ACTIONS.OPEN_CREW_RETRAIN_WINDOW")

		(var isRentalOwnShip:bool = "ownShipTimeRent > 0")

		(var lockRecruitReasonStatus:dict = "	isShipInBalancer								? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.WARNING,
																									text: 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER' } :
												(freeBarracksSlots <= 0) && isRentalOwnShip		? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.NEGATIVE,
																									text: 'IDS_UNABLE_HIRE_CREW_NO_PLACE_IN_BARRACKS_TOOLTIP' } :
												isDemoWithoutStats								? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.ATTENTION,
																									text: 'IDS_RECRUIT_CREW_DENY_REASON_CURRENT_SHIP_IS_DEMO_WITHOUT_STATS' } :
												isShipReadyForBattle							? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.ATTENTION,
																									text: 'IDS_ASSIGN_CREW_DENY_REASON_CURRENT_SHIP_IN_FORMATION' }
																								: null")


		(struct activeTip =			PULL_ACTIVE_GUIDING_TIP())
		(struct checkedTipId =		SAFE_CHECK_ACTIVE_TIP_ID(_tipId = "activeTip.tipId"		_validValues = "[	SC.Context_guiding_tip.TIP_TYPE.CREW_HIRE_NEW,
																												SC.Context_guiding_tip.TIP_TYPE.CREW_HIRE_NEW_REPEAT ]"))


		(var buttonSize:number =	"_isSmallPanel ? SIZE.SMALL : SIZE.MEDIUM")
		(var buttonMargin:number =	"_isSmallPanel ? S : SXS")
	)

	(style (width = 100%))


	(element HorizontalDividerTwoPx)

	(block
		(style (bind marginTop "isReturnLastCrewButtonVisible ? buttonMargin : 0"))

		(controller $Instance renderer='DefaultButton'
			(bind enabled "isReturnLastCrewButtonVisible")
			(args
				_label =			'IDS_CREW_HIRE_LAST_CREW'
				_width =			220px
				_size =				"buttonSize"
				_enabled =			"!isReturnButtonDisabled"
				_isTransactionBtn =	true
				_focusIndex =		0
				_methods =			"[{ type: methodType, name: methodName, args: { crewId: lastBoardedCrewId, shipId: playerShipId } }]"
			)
		)

		(controller $Tooltip
			(bind enabled "isReturnLastCrewButtonVisible")
			(renderer='CrewTooltip')
			(args
				_crewId =					"lastBoardedCrewId"
				_targetShipId =				"playerShipId"
				_noContextMenuInstruction =	true
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)

	(block
		(style (bind marginTop "buttonMargin"))

		(element DefaultButton
			_label =			'IDS_HIRE_NEW_CREW'
			_type =				"SC.Ui_styles.BUTTON_TYPE.SECONDARY"
			_width =			220px
			_size =				"buttonSize"
			_enabled =			"!lockRecruitReasonStatus"
			_isTransactionBtn =	true
			_focusIndex =		1
			_methods =			"[{ type: 'inputMapping.onRequest', name: CREW_ACTIONS.OPEN_HIRE_WINDOW, args: {} }]"
			_name =				'recruit'
		)

		(controller $Tooltip
			(renderer = 'SimpleStatusTooltip')
			(bind enabled "lockRecruitReasonStatus != null")
			(args
				_unifiedStatus =	"lockRecruitReasonStatus.unifiedStatus"
				_text =				"lockRecruitReasonStatus.text"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)

		(controller $Instance renderer='GuidingTipHub'
			(bind enabled "checkedTipId.value")
			(args
				_tipId =			"checkedTipId.value"
				_tipPositioning =	"TIP_POSITION_RIGHT"
				_offsetX =			"XS"
				_pointerOffset =	-118
				_modalWindowName =	"SC.Ui_windows.WINDOWS.DOCK"
			)
		)
	)
)
