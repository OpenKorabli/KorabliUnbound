(def constant BATTLES_COUNT_TO_COLLAPSED_ALL_BANNER 15)
(def constant DARK_BANNER_COLOR 0x20000000)

(def macro ACCOUNT_LEVEL_BANNER_STATUS_ANIM (_eventName:expression, _visibleResult:bool, _dispatchName:expression = "''")
	(controller $Animation
		(bindcall play
			duration = 0.1
			from = 	{ alpha: 0, visualOffsetY: -10px }
			to = 	{ alpha: 1, visualOffsetY: 0px }
			easing = "Easing.quad_in"
			watch = false
			reverse = "!_visibleResult"
			(event "_eventName")
		)
		(dispatch "_dispatchName" on='evAnimEnded')
	)
)

(def macro ACCOUNT_LEVEL_BANNER_HIDDEN_ELEMENT (_eventName:expression, _dispatchName:expression)
	(controller $Animation
		(bindcall play
			duration = 0.1
			to = "{ alpha: 0, visualOffsetY: -10px }"
			easing = "Easing.quad_out"
			(event "_eventName")
		)
		(dispatch "_dispatchName" on='evAnimEnded')
	)
)

(def macro ACCOUNT_LEVEL_BANNER_SHOW_ELEMENT (_eventName:expression, _dispatchName:expression = "''", _alpha:number = 1)
	(controller $Animation
		(bindcall play
			duration = 0.1
			from = 	"{ visualOffsetY: 10px,	alpha: 0 }"
			to = 	"{ visualOffsetY: 0px, 	alpha: _alpha }"
			easing = "Easing.quad_in"
			(event "_eventName")
		)
		(dispatch "_dispatchName" on='evAnimEnded')
	)
)


(def element AccountLevelBanner (_size:number = "SC.Ui_common.TILE_SIZE.M")
	(scope
		(macro MOUSE_HANDLER_SCOPE)

		(event evPlayNextVoicePromptPart)
		(event changePointsToShowAnimation)
		(event evBlickShown)
		(event evBannerAnimationStart)
		(event evImageHid)
		(event evTitleHid)
		(event evProgressHid)
		(event evStatusLineHid)
		(event evImageShown)
		(event evTitleShown)
		(event evProgressShown)

		(event AudioPromptHid)
		(event BannerCountTaskHid)

		(var accountLevelEntity:dhEntity = "getSingleEntity(CC.accountLevel)")
		(var accountLevelComponent:dhComponent = "accountLevelEntity.accountLevel")
		(var curAccountLevel:number = "accountLevelComponent.level" (event "accountLevelComponent.evLevelChanged"))

		(var currentLevelStepComponent:dhComponent = 	"getPrimaryEntity(CC.accountLevelingStep, curAccountLevel).accountLevelingStep")
		(var nextLevelStepComponent:dhComponent = 		"getPrimaryEntity(CC.accountLevelingStep, curAccountLevel + 1).accountLevelingStep")
		(var lastLevelStepComponent:dhComponent = 		"getPrimaryEntity(CC.accountLevelingStep, curAccountLevel - 1).accountLevelingStep")

		(var accountStepPoints:number =	"currentLevelStepComponent.thisStepPoints ?: 0")
		(var nextStepPoints:number = 	"nextLevelStepComponent.thisStepPoints ?: 0")
		(var lastStepMinPoints:number =	"lastLevelStepComponent.thisStepPoints ?: 0")

		(var currentStepFeatures:number =	"currentLevelStepComponent.features")
		(var nextStepFeatures:number =		"nextLevelStepComponent.features")

		(var lastStepsCount:number = "accountStepPoints - lastStepMinPoints")

		
		

		
		(var battleAmountPerStep:number = "nextStepPoints > 0 ? nextStepPoints - accountStepPoints : 0" watch=false (event "accountLevelComponent.evLevelChanged"))

		(var levelPointsEntity:dhEntity = "getSingleEntity(CC.accountLevelPoints)")
		(var levelPointsComponent:dhComponent = "levelPointsEntity.accountLevelPoints")
		(var currentPoints:number = "levelPointsComponent.currentLevelPoints ?: 0" (event "levelPointsComponent.evCurrentLevelPointsChanged"))

		(var pointsToShowAnimation:number = "levelPointsComponent.lastSeenAccountLevelPoints" (event "levelPointsComponent.evLastSeenAccountLevelPointsChanged"))

		(var doneCountSteps:number = "currentPoints - accountStepPoints")
		(var lineProgress:number = "battleAmountPerStep ? doneCountSteps / battleAmountPerStep : null")

		(var isLastStepJustFinished:bool = "currentPoints == accountStepPoints")
		(var isAnimationUnwatched:bool = "currentPoints != pointsToShowAnimation")
		(var isShowLastStep:bool = "isLastStepJustFinished && isAnimationUnwatched")

		(var battleAmountPerStepAnimation:number = "isShowLastStep && accountStepPoints ? lastStepsCount : battleAmountPerStep")

		(var accountLevelNumber:number = "isShowLastStep ? curAccountLevel : curAccountLevel + 1")
		(var battlesToStep:number = "isShowLastStep ? 1 : nextStepPoints - currentPoints")

		(var feature:number = "isShowLastStep ? currentStepFeatures : nextStepFeatures")
		(var accountFeatureEntity:dhEntity = "getPrimaryEntity(CC.accountFeature, feature)")
		(var accountFeatureComponent:dhComponent = "accountFeatureEntity.accountFeature")
		(var featureIndex:number ="accountFeatureComponent.featureIndex" (event "accountFeatureComponent.evStateChanged"))
		(var imageUrl:str = "'url:../accountLevel/unlocks/icon_' + featureIndex + '.png'")

		(var titleFeature:str = "'IDS_UNLOCKS_TITLE_' + featureIndex")

		(var accountSelfEntity:dhEntity = "getSingleEntity(CC.accountSelf)")
		(var accountInfoComponent:dhComponent = "accountSelfEntity.accountInfo")
		(var abuseStatus:number = "accountInfoComponent.abuseStatus" (event "accountInfoComponent.evAbuseStatusChanged"))
		(var isAbuseStatusConfirmed:bool = "abuseStatus == SC.Common.ABUSE_STATUS.CONFIRMED")

		(var splitRunTestEntity:dhEntity = "getPrimaryEntity(CC.splitRunTest, 'Promoreward_Research')")
		(var splitRunTestComponent:dhComponent = "splitRunTestEntity.splitRunTest")
		(var battlesToMinimize:number = "splitRunTestComponent.data.battlesToMinimize ?: BATTLES_COUNT_TO_COLLAPSED_ALL_BANNER" (event "splitRunTestComponent.evDataChanged"))

		(macro PULL_CURRENT_TOP_WINDOW_NAME)
		(var isOnTop:bool = "currentTopWindowName == 'Dock'")
		(struct mainRoute = PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.ACTIVITIES"))
		(var isSceneReadyForAnimation:bool = "isOnTop && mainRoute.isActive")
		(var isHeaderBannerMotion:bool = "isShowLastStep && isSceneReadyForAnimation")

		(var voicePromptEntity:dhEntity = "getSingleEntity(CC.voicePrompt)")
		(var voicePrompt:dhComponent = "voicePromptEntity.voicePrompt")
		(var isAudioVisible:bool = "false")
		(bind isAudioVisible "true" init=false (event "voicePrompt.evPlay"))
		(bind isAudioVisible "false" init=false (event "AudioPromptHid"))

		(var isMediumSize:bool = "_size == SC.Ui_common.TILE_SIZE.M")
	)
	(name = 'account_level_banner')

	(bindcall externalCall "'inputMapping.onAction'" "['setLastSeenAccountLevelPoints', { 'points': currentPoints } ]" init=false watch=false (event "changePointsToShowAnimation"))
	(bindcall externalCall "'inputMapping.onAction'" "['playVoiceNext', { } ]" init=false (event "evPlayNextVoicePromptPart"))

	
	
	(dispatch "isHeaderBannerMotion ? 'evPlayNextVoicePromptPart' : ''" delay=0.2 (bind trigger "isHeaderBannerMotion"))
	(dispatch changePointsToShowAnimation (bind enabled "!isLastStepJustFinished") (event "evBlickShown"))
	(dispatch changePointsToShowAnimation (event "evStatusLineHid"))

	(dispatch evBannerAnimationStart (bind enabled "isLastStepJustFinished") (event "evBlickShown"))
	(class $Fullsize)
	(style
		(flow = "horizontal")
		(backgroundColor = "NO_COLOR")
	)

	(macro MOUSE_HANDLER_BANNER
		_methods = "[{
			type: 'inputMapping.onAction',
			name: 'navigateTo',
			args: {	route: SC.Ui_windows.ROUTE.ACCOUNT_LEVELING,
					data: { isPortBannerClicked: true } }
		}]"
	)

	(controller $Tooltip
		(renderer = 'AccountLevelBannerTooltip')
		(macro DEFAULT_TOOLTIP_BEHAVIOUR "0")
	)

	(controller $Tooltip
		(bind enabled "isAbuseStatusConfirmed")
		(renderer = 'AbuseStatusProfileTooltip')
		(args
			_mouseInstructionText = 'IDS_GO_TO_ACCESS_LEVEL_MOUSE_INSTRUCTION'
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR "1")
	)

	(block
		(class $Fullsize)
		(style
			(paddingRight = "SXS")
			(paddingLeft = "M")
			(paddingTop = "M")
			(paddingBottom = "M")
		)
		(block
			(style
				(width = 100%)
				(minWidth = 192px)
				(minHeight = 18px)
				(marginBottom = "XS")
			)

			(controller $Animation
				(bindcall play
					duration = 0.2
					from = { alpha: 0, visualOffsetY: -10px }
					to = { alpha: 1, visualOffsetY: 0px }
					easing = "Easing.quad_in"
					watch = false
					(bind trigger "accountLevelNumber")
				)
			)
			(element EventBannerTitle
				_title = "subst('IDS_DOCK_BANNER_ACCESS_LEVEL', [], {_level: accountLevelNumber})"
				_textClass = '$TextDefaultBold20NM'
				_isWordWrap = "_size != SC.Ui_common.TILE_SIZE.L"
				_isMultiline = false
				_isElide = false
			)
		)
		(block
			(bind visible "isAudioVisible")
			(style
				(height = 20px)
				(bind alpha "isAudioVisible")
				(bind visualOffsetY "isAudioVisible ? 0px : -10px")
			)
			(macro ACCOUNT_LEVEL_BANNER_STATUS_ANIM
				_eventName = "voicePrompt.evStop"
				_visibleResult = false
				_dispatchName = "'AudioPromptHid'"
			)
			(macro ACCOUNT_LEVEL_BANNER_STATUS_ANIM
				_eventName = "BannerCountTaskHid"
				_visibleResult = true
			)
			(mc audio_prompt)
		)

		(block
			(bind visible "isAbuseStatusConfirmed")

			(class $Fullsize)
			(style (align = "bottom"))

			(tf
				(class $TextDefaultNM)
				(style
					(width = 100%)
					(textColor = "SC.Ui_styles.SERVICE_COLORS.ORANGE")
				)
				(text = 'IDS_ACCOUNT_PROGRESS_ABUSED_TOOLTIP_AL_BANNER')
			)
		)

		(block
			(bind visible "!isAbuseStatusConfirmed")
			(class $Fullsize)
			(style (align = "bottom"))

			(block
				(style
					(width = 100%)
					(marginBottom = "S")
				)

				(macro ACCOUNT_LEVEL_BANNER_HIDDEN_ELEMENT
					_eventName = "evImageHid"
					_dispatchName = "'evTitleHid'"
				)

				(macro ACCOUNT_LEVEL_BANNER_SHOW_ELEMENT
					_eventName = "evImageShown"
					_dispatchName = "'evTitleShown'"
					_alpha = 0.9
				)

				(tf
					(class $TextDefaultBoldNM)
					(style
						(width = 100%)
						(leading = -4)
						(alpha = "TA")
					)
					(bind text "titleFeature")
				)
			)

			(block
				(style
					(width = 100%)
					(marginBottom = 6px)
				)

				(macro ACCOUNT_LEVEL_BANNER_HIDDEN_ELEMENT
					_eventName = "evTitleHid"
					_dispatchName = "'evProgressHid'"
				)

				(macro ACCOUNT_LEVEL_BANNER_SHOW_ELEMENT
					_eventName = "evTitleShown"
					_dispatchName = "'evProgressShown'"
				)

				(element ProgressBarAlBannerSteps
					_size = "_size"
					_stepsCount = "battleAmountPerStepAnimation"
					_isLastStepAnimation = "isLastStepJustFinished"
					_lastBarStepCount = "lastStepsCount"
					_doneCountSteps = "doneCountSteps"
					_isAnimationUnwatched = "isAnimationUnwatched"
					_isSceneReadyForAnimation = "isSceneReadyForAnimation"
				)
			)

			(block
				(style (width = 100%))

				(macro ACCOUNT_LEVEL_BANNER_HIDDEN_ELEMENT
					_eventName = "evProgressHid"
					_dispatchName = "'evStatusLineHid'"
				)

				(macro ACCOUNT_LEVEL_BANNER_SHOW_ELEMENT
					_eventName = "evProgressShown"
					_alpha = 0.9
				)

				(controller $Instance renderer='BannerItemDescription'
					(bind enabled "!isAbuseStatusConfirmed")
					(args
						_description = "subst('IDS_BATTLES_TO_NEXT_STEP', [], {battles: battlesToStep}, battlesToStep)"
					)
				)
			)
		)
	)

	(block
		(style
			(align = "middle|center")
			(height = 160px)
			(bind width "isMediumSize ? 80px : 160px")
		)
		(block
			(style
				(height = 100%)
				(backgroundSize = "crop")
				(bind width "isMediumSize ? 80px : 160px")
				(bind backgroundImage "imageUrl")
			)

			(macro ACCOUNT_LEVEL_BANNER_HIDDEN_ELEMENT
				_eventName = "evBannerAnimationStart"
				_dispatchName = "'evImageHid'"
			)

			
			(controller $Animation
				(bindcall play
					delay=0.05
					keyframes="[
						{ time: 0.0,	to: { scaleX: 1.9, scaleY: 1.9, visualOffsetY: 0px, alpha: 0 } },
						{ time: 0.3,	to: { scaleX: 0.98, scaleY: 0.98, visualOffsetY: 0px, alpha: 1 } },
						{ time: 0.4,	to: { scaleX: 1.08, scaleY: 1.08 } },
						{ time: 0.5,	to: { scaleX: 1, scaleY: 1 } }]"
					(event "evStatusLineHid")
				)
				(dispatch "evImageShown" on='evAnimEnded')
			)
		)
	)
)

(def element ProgressBarAlBannerSteps (	_stepsCount:number, _isLastStepAnimation:bool, _lastBarStepCount:number, _doneCountSteps:number,
										_isAnimationUnwatched:bool, _isSceneReadyForAnimation:bool, _size:number = "SC.Ui_common.TILE_SIZE.M")
	(scope
		(var bannerWidth:number = "	_size == SC.Ui_common.TILE_SIZE.S	? EVENT_BANNER_WIDTH.SMALL :
									_size == SC.Ui_common.TILE_SIZE.M	? EVENT_BANNER_WIDTH.MEDIUM
																		: EVENT_BANNER_WIDTH.LARGE")
		(var iconWidth:number = "_size == SC.Ui_common.TILE_SIZE.M	? 80 : 160")
		(var widthAlSteps:number = "bannerWidth - M*2 - iconWidth")
		(var gapVal:number = "XXS")
		(var accessWidth:number = "widthAlSteps - gapVal * (_stepsCount - 1)")
		(var stepWidth:number = "_stepsCount ? floor(accessWidth /_stepsCount) : 0")
		(var pixelDeficit:number = "accessWidth - stepWidth * _stepsCount")
	)

	(style
		(flow = "horizontal")
		(gap = "gapVal")
		(height = 2px)
	)
	(controller $Repeat renderer='StepsProgressItem'
		(bind count "_stepsCount")
		(args
			_width = "$index < pixelDeficit ? stepWidth + 1 : stepWidth"
			_isAnimateStep = "_isLastStepAnimation 	? ($index == _lastBarStepCount - 1)	&& _isAnimationUnwatched
													: ($index == _doneCountSteps - 1) 	&& _isAnimationUnwatched"

			_isStepDone = "	_isLastStepAnimation 	? (($index < _lastBarStepCount - 1) && _isAnimationUnwatched) :
							_isAnimationUnwatched 	? ($index <= _doneCountSteps - 2)
													: ($index <= _doneCountSteps - 1)"

			_isSceneReadyForAnimation = "_isSceneReadyForAnimation"
		)
	)
)

(def element StepsProgressItem (_width:number, _isAnimateStep:bool, _isStepDone:bool, _isSceneReadyForAnimation:bool)
	(style
		(height = 100%)
		(bind width "_width")
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(bind backgroundColor "_isStepDone ? SC.Ui_styles.SERVICE_COLORS.ACCENT_BLUE : SC.Ui_styles.SERVICE_COLORS.DARK_BLUE")
			(bind alpha "_isStepDone ? 1 : 0.2")
		)
	)

	(controller $Instance renderer='AccountLevelingStepsAnimation'
		(bind enabled "_isSceneReadyForAnimation && _isAnimateStep")
		(args
			_width = "_width"
		)
	)
)

(def element AccountLevelingStepsAnimation (_width:number)
	(bindcall externalCall 'sound.playSetSoundDirect' "['levelUpAnimation', 'AccountLevelUpLineProgress']" delay=0.1 on='addedToStage')

	(class $FullsizeAbsolute)

	(block
		(class $FullsizeAbsolute)
		(style (backgroundColor = "SC.Ui_styles.SERVICE_COLORS.ACCENT_BLUE"))

		(controller $Animation
			(bindcall play
				keyframes="[
					{ time: 0,		to: { scaleX: 0 } },
					{ time: 0.3,	to: { scaleX: 0,	colorTransform: { redOffset: 255, greenOffset: 255, blueOffset: 255 } } },
					{ time: 0.9,	to: { scaleX: 1,	colorTransform: { redOffset: 0, greenOffset: 0, blueOffset: 0 } } } ]"
				easing = "Easing.quad_out"
				on = 'addedToStage'
			)
		)
	)

	(block
		(class $ZeroSize)

		(style
			(position = "absolute")
			(top = 50%)
			(align = "center|middle")
		)

		(block
			(style
				(width = 112px)
				(height = 200px)
				(hitTest = false)
				(backgroundImage = 'url:../accountLevel/progressBarIcons/big_blink.png')
				(backgroundSize = "fill")
			)

			(controller $Animation
				(bindcall play
					keyframes="[
						{ time: 0,		to: { alpha: 0, scaleX: 0,		scaleY: 0,		visualOffsetX: 0 } },
						{ time: 0.3,	to: { alpha: 1, scaleX: 1,		scaleY: 1,		visualOffsetX: 0 } },
						{ time: 0.9,	to: { alpha: 1, scaleX: 0.4,	scaleY: 0.4,	visualOffsetX: _width } },
						{ time: 0.95,	to: { alpha: 0 } } ]"
					easing = "Easing.quad_out"
					on = 'addedToStage'
				)
				(dispatch "'evBlickShown'" dir="EventDirection.UP" init=false on='evAnimEnded')
			)
		)
	)
)