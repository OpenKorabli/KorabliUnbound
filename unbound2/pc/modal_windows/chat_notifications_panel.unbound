(def element ChatNotificationsPanel ()
	(macro MODAL_WINDOW_INIT)
	(scope
		(struct shipyardRoute = 		PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.SHIPYARD"))
		(struct strategicActionsRoute =	PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.STRATEGIC_ACTIONS"))

		(var isInDivision:bool = "getSingleEntity(CC.division) != null")

		(var windowManager:dhComponent = "getSingleComponent(CC.windowManager)")
		(var windowQueue:array = "windowManager.windowQueue ?: []" (event "windowManager.evWindowQueueChanged"))
		(var isChatNotificationsPanelVisibile:bool = "!isIn('ModalWindowSse', windowQueue)")

		(struct voiceChatEnabledPref = GET_PREF_BOOL(_option="'sound.voice.chat.enabled'"))
		(var isVoiceChatIconVisible:bool = "isInDivision && voiceChatEnabledPref.value")

		(var selfPlayerEntity:dhEntity = "getSingleEntity(CC.accountSelf)")
		(var selfPlayerName:str = "selfPlayerEntity.accountName.name" (event "selfPlayerEntity.accountName.evChanged"))

		(var playerVoiceChatEntity:dhEntity = "getPrimaryEntity(CC.playerVoiceState, selfPlayerName)")
		(var isSpeaking:bool = "playerVoiceChatEntity.playerVoiceState.isSpeaking" (event "playerVoiceChatEntity.playerVoiceState.evIsSpeakingChanged"))

		(var hasShips:bool = "getCollection(CC.ownShip).length > 0")
		(var portElementsVisibility:dhComponent =	"getSingleComponent(CC.portElementsVisibility)")

		(struct repairDockRoute =	PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.REPAIR_DOCK"))
		(struct bargeRoute =		PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.LOOTBOXES"))

		(var isShipsCarouselAtRepairDockVisible:bool = "repairDockRoute.isActive && getCollection(CC.shipComponent).length > 0")

		(struct carouselAreaHeightPref = GET_PREF_NUMBER(_option = "'ui.carousel.carouselAreaHeight'"))
		(var isCarouselVisible:bool = "hasShips && portElementsVisibility.carouselVisible" (event "portElementsVisibility.evCarouselVisibleChanged"))

		(var systemNotificationOffset:number = "isCarouselVisible || isShipsCarouselAtRepairDockVisible || bargeRoute.isActive ? carouselAreaHeightPref.value : 40px")

		(var verifiedSystemNotificationOffset:number = "systemNotificationOffset" watch=false)

		(controller $Animation
			(bindcall play
				delay = 0.1
				duration = 0.15
				to = "{ verifiedSystemNotificationOffset: systemNotificationOffset }"
				easing = "Easing.line"
				action = "kill"
				watch = false
				(bind trigger "systemNotificationOffset")
			)
		)
	)
	(macro HIDE_UI_ON_SHIPOVERVIEW)
	(style (align = "bottom"))

	(element DeclareBlurLayer)

	(block
		(class $FullsizeAbsolute)

		(controller $Tooltip
			(renderer = 'SystemNotificationContainer')
			(args
				_systemNotificationOffset = "systemNotificationOffset"
			)

			(bindcall show animation =	{	duration:	0.1,
											easing:		"Easing.cubic_out",
											from:		{ alpha: 0 },
											to:			{ alpha: 1 }} on='addedToStage')

			(bindcall hide animation =	{	duration:	0.11,
											easing:		"Easing.cubic_out",
											from:		{ alpha: 1 },
											to:			{ alpha: 0 }} on='removedFromStage')

			(hideAnimation = {	duration:	0.1,
								easing:		"Easing.cubic_out",
								from:		{ alpha: 1 },
								to:			{ alpha: 0} })

			(screenBoundsOffset = 0px)

			(align = "center|middle")
			(position = "border")
			(tooltipType = "interactive")
		)
	)

	(hblock
		(style
			(width = 100%)
			(height = 30px)
		)

		(controller $Animation
			(bindcall play
				delay =		"isChatNotificationsPanelVisibile ? 0.1 : 0"
				duration =	"isChatNotificationsPanelVisibile ? 0.15 : 0.03"
				to =		"isChatNotificationsPanelVisibile ? { alpha: 0, visualOffsetY: 10px } : {  alpha: 1, visualOffsetY: 0px }"
				easing =	"Easing.quad_in"
				action =	"kill"
				(bind trigger "isChatNotificationsPanelVisibile")
			)
		)

		(hblock
			(bind visible "!shipyardRoute.isActive && !strategicActionsRoute.isActive")
			(class $Fullsize)
			(style
				(paddingLeft = "S")
				(paddingRight = "S")
			)

			(element ContactsAndChannelsInfotipButton)

			(block
				(visible = "isVoiceChatIconVisible")
				(style
					(marginTop = 3px)
					(ubScaleX = "isVoiceChatIconVisible ? 1 : 0")
					(alpha = "isVoiceChatIconVisible ? 1 : 0")
				)

				(controller $Animation
					(bindcall play
						delay = 1.5
						duration = 0.15
						to = "isVoiceChatIconVisible ? { ubScaleX: 1, alpha: 1, visible: true } : { ubScaleX: 0, alpha: 0, visible: false }"
						easing = "Easing.quad_in"
						action = "kill"
						(bind trigger "isVoiceChatIconVisible")
					)
				)

				(block
					(style 
						(paddingLeft = "SXS")
						(paddingTop = "3px")
					)
					(element VoiceChatOutgoingIcon _isSpeaking = "isSpeaking")
				)
			)

			(block
				(style
					(width = 100%)
					(paddingLeft = "SXS")
					(paddingRight = "SXS")
					(marginTop = "-XXS")
				)
				(element OpenChannelList)
			)

			(element NotificationPanel)
		)
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(align = "center|bottom")
			(bind paddingBottom "verifiedSystemNotificationOffset")
		)

		(element InformerLogContainer)
	)
)