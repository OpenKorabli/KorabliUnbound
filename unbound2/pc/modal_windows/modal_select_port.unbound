(def constant PORT_ITEM_WIDTH 304px)
(def constant PORT_ITEM_HEIGHT 154px)

(def element BackgroundModalWindowPort ()
	(macro MODAL_WINDOW_INIT)
	(macro MODAL_WINDOW_BG)
)

(def element ModalWindowSelectPort ()
	(macro MODAL_WINDOW_INIT)

	(scope
		(event evChangeSelectedPortId)
		(event evSetPortPreset)

		(var divisionDataEntity:dhEntity = 	"getSingleEntity(CC.division)")
		(var isDivisionReady:bool = 		"divisionDataEntity.division.isReady")

		(var portsCollection:dhCollection = "getCollectionByPath(CC.port, 'visible.sorted')")
		(var currentPortEntity:dhEntity = 	"getCollectionByPath(CC.port, 'current')[0]")
		(var selectedPortId:str = 			"$event.selectedPortId ?: currentPortEntity.port.id" (event "evChangeSelectedPortId"))
		(var selectedPortEntity:dhEntity = 	"getPrimaryEntity(CC.port, selectedPortId)")
		(var isCurrentSelected:bool = 		"currentPortEntity.port.id == selectedPortEntity.port.id")
	)

	(bindcall externalCall 'inputMapping.onAction' "['setPortPreset', {portId: $event.portId}]" (event "evSetPortPreset"))

	(style (align = "middle|center"))

	(block
		(macro DEFAULT_MODAL_WINDOW_ANIMATION 1)

		(class $Fullsize)

		(element ModalWindowHeaderFullSize
			_windowName 	= 'IDS_CHOOSE_PORT_HEADER'
			_paddingRight 	= "M"
			_paddingLeft 	= "M"
		)

		(block 
			(macro DEFAULT_MODAL_WINDOW_ANIMATION 1.5)

			(style (width = 100%))

			(block
				(style
					(align = "middle|center")
					(width = 100%)
					(height = "{720: 48px, 1440: 80px}")
				)

				(tf
					(class $TextDefault20NM)
					(style
						(marginTop = "S")
						(alpha = "TC")
					)

					(text = 'IDS_CLICK_TO_SET_PORT')
				)
			)

			(element HorizontalDividerTwoPx)
		)

		(scrollArea 
			(macro DEFAULT_MODAL_WINDOW_ANIMATION 2)

			(class $Fullsize)
			(style
				(paddingRight = "SXS")
				(paddingLeft = "SXS")
				(backgroundColor = "NO_COLOR")
			)

			(macro DEFAULT_VERTICAL_SCROLL_PARAMS)

			(repeatController = 'portContainer')
			(scrollPerItem = true)

			(content
				(style
					(align = "center")
					(width = 100%)
				)

				(htile
					(style
						(maxWidth = "{ 1280:1000px, 1920:1600px }")
						(paddingTop = "MS")
						(paddingBottom = "MS")

						(hgap = "{ 1280:XS, 1920:S }")
						(vgap = "{ 720:M, 1080:S }")
					)

					(controller $DynamicRepeat renderer='PortSelectionItem' name='portContainer'
						(bind count "portsCollection.length")
						(args
							_portEntity 	= "portsCollection[$index]"
							_selectedPortId = "selectedPortId"
						)
						(itemWidth 	= "PORT_ITEM_WIDTH")
						(itemHeight = "PORT_ITEM_HEIGHT")
						(itemOffset = "PORT_ITEM_HEIGHT")
					)
				)
			)
		)

		(block 
			(macro DEFAULT_MODAL_WINDOW_ANIMATION 3)

			(style
				(align = "center")
				(width = 100%)
			)

			(element HorizontalDividerTwoPx)

			(block
				(style
					(align = "center")
					(marginTop = "{ 720:MS, 1440:XL }")
					(marginBottom = "{ 720:MS, 1440:XL }")
					(gap = "M")
				)

				(block
					(controller $Instance renderer='StatusLine'
						(bind enabled "isDivisionReady")
						(args
							_text 			= 'IDS_CHANGE_PORT_HINT_DIVISION'
							_unifiedStatus 	= "SC.Ui_styles.UNIFIED_STATUS.ATTENTION"
							_textClass 		= '$TextDefault20NM'
						)
					)
				)

				(hblock 
					(macro DEFAULT_MODAL_WINDOW_ANIMATION 4)

					(block
						(style
							(width = "isCurrentSelected ? 0px : 190px")
							(alpha = "isCurrentSelected ? 0 : 1")

							(bind marginRight "isCurrentSelected ? 0px : MS")
						)

						(controller $Animation
							(bindcall play
								duration 	= 0.15
								from 		= "{alpha: 0, width: 0px}"
								to			= "{alpha: 1, width: 190px}"
								reverse 	= "isCurrentSelected"
								(bind trigger "isCurrentSelected")
							)
						)

						(element DefaultButton
							_label 			= 'IDS_SAVE_CHANGES'
							_width 			= 190px
							_name 			= 'btn_ok'
							_enabled 		= "!isDivisionReady && !isCurrentSelected"
							_dispatchedEv 	= 'evSetPortPreset'
							_dispatchParams = "{portId: selectedPortId}"
							_focusIndex 	= 0
							_defaultFocused = true
						)
					)

					(element DefaultButton
						_label = 'IDS_CLOSE_UPPER_CASE'
						_name = 'btn_cancel'
						_focusIndex = 1
					)
				)
			)
		)
	)
)

(def constant PORT_BUTTON_ALPHA {
	SC.Ui_styles.BUTTON_STATE.SELECTED: 0,
	SC.Ui_styles.BUTTON_STATE.DOWN: 0,
	SC.Ui_styles.BUTTON_STATE.OVER: 0,
	SC.Ui_styles.BUTTON_STATE.UP: 1
})

(def element PortSelectionItem (_selectedPortId:str, _portEntity:dhEntity)
	(scope
		(macro MOUSE_HANDLER_SCOPE)

		(var isPortNew:bool = 	"_portEntity.hasComponent(CC.newItem)")

		(var portId:str = 		"_portEntity.port.id")
		(var portNameIds:str = 	"_portEntity.port.nameIds")

		(var isPortSelected:bool = 		"portId == _selectedPortId")
		(var isIconCheckShown:bool = 	"!isPortNew && isPortSelected")

		(var state:number = "	isPortSelected	? SC.Ui_styles.BUTTON_STATE.SELECTED :
								mouseDown		? SC.Ui_styles.BUTTON_STATE.DOWN :
								rollOver		? SC.Ui_styles.BUTTON_STATE.OVER
												: SC.Ui_styles.BUTTON_STATE.UP")

		(var hoverAlpha:number = "PORT_BUTTON_ALPHA[state]")
		(var portImageAlpha:number = "	isPortSelected																		?	1 :
										state == SC.Ui_styles.BUTTON_STATE.OVER || state == SC.Ui_styles.BUTTON_STATE.DOWN	?	0.9
																															:	0.5")
		(var portNameAlpha:number = "isPortSelected ? TA : TS")
		(var gradientAlpha:number = "isPortSelected ? 0.5 : 1")
	)

	(bind name "isPortSelected ? 'port_' + portId + '_selected' : 'port_' + portId")

	(macro MOUSE_EVENTS_DISPATCHER)
	(macro SOUND_HANDLER "'button_port'")

	(bindcall externalCall 'inputMapping.onAction' "['makeSeen', {entityId: _portEntity.id}]" watch=false on='leftClick')
	(dispatch evChangeSelectedPortId args="{selectedPortId: portId}" dir="EventDirection.UP" on='leftClick')

	(style
		(width = "PORT_ITEM_WIDTH")
		(height = "PORT_ITEM_HEIGHT")
		(padding = "isPortSelected ? -XXS : S")
	)

	(controller $Animation
		(bindcall play
			duration 	= 0.1
			from 		= "{padding: -XXS}"
			to 			= "{padding: S}"
			reverse 	= "isPortSelected"
			(bind trigger "isPortSelected")
		)
	)

	
	(block
		(class $FullsizeAbsolute)

		(block
			(class $Fullsize)
			(style
				(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.INNER_PANEL")
				(alpha = "PORT_BUTTON_ALPHA[state]")
				(borderRadius = "isPortSelected ? S : XS")
			)

			(controller $Animation
				(bindcall play
					duration 	= 0.15
					from 		= "{ borderRadius: XS }"
					to 			= "{ borderRadius: S }"
					watch 		= false
					reverse 	= "!isPortSelected"
					(bind trigger "isPortSelected")
				)
			)

			(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA "state" "hoverAlpha" "0.15")
		)
	)

	
	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundSize = "cover")
			(borderRadius = "isPortSelected ? S : XS")
			(alpha = "portImageAlpha")
			(bind backgroundImage "'url:../ports/' + portId + '.jpg'")
		)

		(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA "state" "portImageAlpha" "0.15")

		(controller $Animation
			(bindcall play
				duration 	= 0.15
				from 		= "{ borderRadius: XS }"
				to 			= "{ borderRadius: S }"
				watch 		= false
				reverse 	= "!isPortSelected"
				(bind trigger "isPortSelected")
			)
		)

		(controller $Tooltip
			(renderer = 'DescriptionStatusLineTooltip')
			(args
				_unifiedStatus 		= "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
				_statusText 		= 'IDS_SELECT_PORT'
				_descriptionText 	= "portNameIds + '_TOOLTIP'"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)

	
	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundSize = "cover")
			(backgroundImage = "'url:../ports/port_gradient.png'")
			(borderRadius = "isPortSelected ? S : XS")
			(alpha = "gradientAlpha")
		)

		(controller $Animation
			(bindcall play
				duration 	= 0.15
				from 		= "{ borderRadius: XS }"
				to 			= "{ borderRadius: S }"
				watch 		= false
				reverse 	= "!isPortSelected"
				(bind trigger "isPortSelected")
			)
		)

		(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA "isPortSelected" "gradientAlpha" "0.15")
	)

	
	(hblock
		(style
			(position = "absolute")
			(height = 30px)
			(width = 100%)
			(bottom = 0px)
		)

		(hblock
			(class $Fullsize)
			(style
				(align = "middle")
				(paddingLeft = "SXS")
				(paddingTop = "S")
				(paddingBottom = "S")
			)

			(tf
				(class $TextDefaultBold18NM)
				(style
					(hitTest = false)
					(width = 100%)
					(textAlign = "left")
					(bind alpha "portNameAlpha")
				)
				(bind text "portNameIds")
			)

			(block
				(bind visible "isPortSelected")
				(style
					(hitTest = false)
					(width = 19px)
					(height = 19px)
					(backgroundImage = 'url:../service_kit/unified_status_icons/icon_check.png')
				)
			)
		)
	)

	
	(block
		(macro DEFAULT_CONTROL_MARKER_ANIMATION _isVisible="isPortNew" _showDelay=0.15)
		(style
			(position = "absolute")
			(right = "LS")
			(top = "XS")
		)

		(element MarkerNew)
	)
)