(def element ModalWindowPremiumAccountChoosePeriod (isFromPBS:bool=false)
	(macro MODAL_WINDOW_INIT)
	(macro MODAL_WINDOW_BG)
	(scope
		(event selectedItemChanged)
		(var entityId:number = "'entityId' in $event ? $event.entityId : 0" watch=false (event "selectedItemChanged"))
		(var realmConstantsEntity:dhEntity = "getSingleEntity(CC.realmConstants)")
		(var currentRegion:str = "realmConstantsEntity.realmConstants.currentRegion")
		(var premiumPeriodsCollection:dhCollection = "getCollectionByPath(CC.premiumItem, 'byPremiumType.' + SC.Common.PREMIUM_TYPE.WOWS)")
		(var premItemEntity:dhEntity = "getEntity(entityId)")
		(var premid:str = "premItemEntity.premiumItem.id ?: ''" (event "premItemEntity.premiumItem.evChanged"))
		(var resourceEntity:dhEntity = "getSingleEntity(CC.accountResource)")
		(var accountGold:number = "resourceEntity.accountResource.gold" (event "resourceEntity.accountResource.evChangedGold"))
		(var gold:number = "premItemEntity.premiumItem.gold ?: 0" (event "premItemEntity.premiumItem.evChanged"))
		(var cashbackGold:number = "premItemEntity.premiumItem.cashbackGold ?: 0" (event "premItemEntity.premiumItem.evChanged"))
		(var loginEntity:dhEntity = "getSingleEntity(CC.loginData)")
		(var isEGSClient:bool = "loginEntity.loginData.isEGS" (event "loginEntity.loginData.evUpdate"))
		(var enoughResources:bool = "entityId && accountGold >= gold")
		(var currenciesPanelPrices:array = "[{currency: SC.Common.CURRENCIES.GOLD, finalPrice: enoughResources ? -gold : 0}]")
		(struct priceInfo = PULL_PRICE(_entityId = "premid"	_actionId = "SC.Common.PRICE_ACTION.BUY"))
	)

	(block
		(class $EyeLevelAligned)
		(style
			(align = "center")
			(width = "DEFAULT_MODAL_WINDOW_WIDTH")
		)

		(block
			(macro DEFAULT_MODAL_WINDOW_ANIMATION 1)
			(style (width = 100%))

			(element ModalWindowShortHeader _header = 'IDS_MODAL_WINDOW_TITLE_PREMIUM_ACCOUNT_PURCHASE')
		)
		(block
			(style
				(align = "center")
				(width = 520px)
			)

			(block
				(macro DEFAULT_MODAL_WINDOW_ANIMATION 2)
				(element CurrenciesPanel
					_priceInfo = "currenciesPanelPrices"
					_width = 520px
				)
			)

			(block
				(macro DEFAULT_MODAL_WINDOW_ANIMATION 2)
				(style
					(align = "center")
					(width = 100%)
					(marginTop = "M")
					(marginBottom = "MS")
				)
				(tf
					(class $TextDefault18NM)
					(style
						(width = 100%)
						(textAlign = "center")
						(alpha = "TA")
					)
					(text = 'IDS_PREMIUM_ACCOUNT_SUBHEADER')
				)
			)

			(block
				(macro DEFAULT_MODAL_WINDOW_ANIMATION 2.5)
				(style (width = 100%))
				(block
					(class $FullsizeAbsolute)
					(style
						(backgroundImage = 'url:../service_kit/panel_backgrounds/background_green.png')
						(backgroundSize = "fill")
					)
				)

				(block
					(style
						(width = 100%)
						(marginTop = -3px)
					)
					(element HorizontalDividerTwoPx)
				)

				(block
					(style
						(width = 100%)
						(padding = "XS")
						(vgap = 3px)
					)
					(controller $Repeat renderer='PremiumAccountDateString'
						(bind count "premiumPeriodsCollection ? premiumPeriodsCollection.length : 0")
						(args
							_premItemEntity = "premiumPeriodsCollection.getEntityAtIndex($index)"
						)
					)
				)
			)

			(block
				(macro DEFAULT_MODAL_WINDOW_ANIMATION 5)
				(bind visible "isFromPBS")
				(style (marginTop = 33px))

				(controller $Instance renderer='StatusLine'
					(bind enabled "isFromPBS")
					(args
						_unifiedStatus =	"SC.Ui_styles.UNIFIED_STATUS.ATTENTION"
						_text =				'IDS_PURCHASE_PREMIUM_WARNING_NEXT_BATTLE'
						_textClass =		'$TextDefault18NM'
					)
				)
			)

			(block
				(macro DEFAULT_MODAL_WINDOW_ANIMATION 5)
				(bind visible "enoughResources")
				(style (marginTop = "L"))
				(controller $Instance renderer='PriceTagWithQuestion'
					(bind enabled "enoughResources")
					(args
						_questionText = 'IDS_PURCHASE_MK_ACCOUNT_FOR'
						_priceInfo = "priceInfo.info"
					)
				)
			)

			(hblock
				(macro DEFAULT_MODAL_WINDOW_ANIMATION 5)
				(bind visible "cashbackGold > 0 && enoughResources")
				(style (marginTop = "M"))
				(tf
					(class $TextDefault18NM)
					(text = 'IDS_COMPENSATION_PRICE_INFO')
				)
				(block
					(style (marginLeft = 6px))
					(controller $Instance renderer='PriceTag'
						(bind enabled "cashbackGold > 0 && enoughResources")
						(args
							_priceInfo = "{finalPrice: cashbackGold, currency: SC.Common.CURRENCIES.GOLD}"
							_size = "SIZE.MEDIUM"
						)
					)
				)
			)

			(block
				(macro DEFAULT_MODAL_WINDOW_ANIMATION 5)
				(bind visible "!enoughResources")
				(style (marginTop = 37px))

				(controller $Instance renderer='StatusLine'
					(bind enabled "!enoughResources")
					(args
						_unifiedStatus =	"SC.Ui_styles.UNIFIED_STATUS.ATTENTION"
						_text =				'IDS_NOT_ENOUGH_GOLD_TO_BUY_PREMIUM_MK'
						_textClass =		'$TextDefault18NM'
					)
				)
			)

			(hblock
				(macro DEFAULT_MODAL_WINDOW_ANIMATION 5.5)
				(style (marginTop = "L"))

				(block
					(visible = "enoughResources")
					(style
						(alpha = "enoughResources ? 1 : 0")
						(ubScaleX = "enoughResources ? 1 : 0")
						(marginRight = "enoughResources ? L : 0")
					)

					(element DefaultButton
						_width =			150px
						_enabled =			"enoughResources"
						_name =				"'Modal_window_action_Button' + 'IDS_PURCHASE_UPPER_CASE'"
						_isTransactionBtn =	true
						_label =			'IDS_PURCHASE_UPPER_CASE'
						_focusIndex =		1
						_defaultFocused =	true
						_methods =			"[{	type:	'inputMapping.onRequest',
												name:	'buyPremiumAccount',
												args:	{ premId: premid }}]"
					)
					(controller $Animation
						(bindcall play
							duration =	0.15
							delay =		0.1
							from =		"{ alpha: 0, ubScaleX:0, marginRight:0px, visible:false }"
							to	 =		"{ alpha: 1, ubScaleX:1, marginRight:L, visible:true }"
							easing =	"Easing.quad_out"
							action =	"kill"
							reverse =	"!enoughResources"
							(bind trigger "enoughResources")
						)
					)
				)

				(block
					(element DefaultButton
						_width =		150px
						_label =		'IDS_CANCEL_UPPER_CASE'
						_name =			'btn_cancel'
						_focusIndex =	2
						_methods =		"[{	type:	'inputMapping.onRequest',
											name:	'btn_cancel',
											args:	{}}]"
					)
				)

				(block
					(bind visible "currentRegion != 'CN' && !isEGSClient")
					(style
						(position = "absolute")
						(right = "{ 1280:-270px, 1920:-370px }")
					)
					(controller $Instance renderer='DefaultButton'
						(bind enabled "!isFromPBS")
						(args
							_type = "SC.Ui_styles.BUTTON_TYPE.SECONDARY"
							_label = 'IDS_BUY_PREMIUM_IN_METASHOP'
							_enabled = true
							_methods = "[	{	type:	'inputMapping.onRequest',
												name:	'openMetashop',
												args:	{url: SC.Ui_windows.GUI_URL.BUY_TOTAL_PREMIUM_IN_GAME}}]"
						)
					)
				)
			)
		)
	)
)

(def element PremiumAccountDateString (_premItemEntity:dhEntity)
	(scope
		(macro MOUSE_HANDLER_SCOPE)
		(event selectedItemChanged)
		(var resourceEntity:dhEntity = "getSingleEntity(CC.accountResource)")
		(var accountGold:number = "resourceEntity.accountResource.gold" (event "resourceEntity.accountResource.evChangedGold"))

		(var premiumItemComponent:dhComponent = "_premItemEntity.premiumItem")
		(var premid:str = "premiumItemComponent.id" (event "premiumItemComponent.evChanged"))
		(var duration:number = "premiumItemComponent.duration" (event "premiumItemComponent.evChanged"))
		(var isSelected:bool = "premiumItemComponent.isSelected" (event "premiumItemComponent.evChanged"))
		(var gold:number = "premiumItemComponent.gold" (event "premiumItemComponent.evChanged"))
		(var cashbackGold:number = "premiumItemComponent.cashbackGold" (event "premiumItemComponent.evChanged"))
		(var isInactive:bool = "accountGold < gold")

		(struct priceInfo = PULL_PRICE(_entityId = "premid"	_actionId = "SC.Common.PRICE_ACTION.BUY"))

		(var state:number = "	isInactive			? SC.Ui_styles.BUTTON_STATE.DISABLED :
								mouseDown			? SC.Ui_styles.BUTTON_STATE.DOWN :
								rollOver			? SC.Ui_styles.BUTTON_STATE.OVER :
								isSelected			? SC.Ui_styles.BUTTON_STATE.SELECTED
													: SC.Ui_styles.BUTTON_STATE.UP")
	)
	(dispatch selectedItemChanged args="{entityId: _premItemEntity.id}" dir="EventDirection.UP" (bind enabled "isSelected") (bind trigger "isSelected"))
	(dispatch selectedItemChanged args="{entityId: _premItemEntity.id}" dir="EventDirection.UP" on=addedToStage (bind enabled "isSelected"))
	(bindcall externalCall 'inputMapping.onAction' "['premiumSelectionChanged', {id: premid}]" watch=false on='leftClick' (bind enabled "accountGold >= gold"))

	(macro SOUND_HANDLER "'button_gold'")
	(macro MOUSE_EVENTS_DISPATCHER)

	(style
		(align = "middle")
		(width = 100%)
		(height = "SHIP_ROW_HEIGHT")
	)

	(block
		(class $FullsizeAbsolute)
		(style (backgroundColor = "NO_COLOR"))

		(element MenuItemBackground
			_state = "state"
		)
	)

	(block
		(class $Fullsize)
		(style (align = "middle"))

		(block
			(style
				(position = "absolute")
				(width = 100%)
				(bottom = -1px)
			)
			(element HorizontalDividerTwoPx)
		)

		(block
			(bind visible "isSelected")
			(style
				(marginLeft = 10px)
				(width = 19px)
				(height = 19px)
				(backgroundSize = "cover")
				(backgroundImage = 'url:../service_kit/unified_status_icons/icon_check.png')
			)
		)

		(hblock
			(style 
				(position = "absolute")
				(align = "middle")
				(width = 100%)
				(height = 48px)
				(bind alpha "accountGold >= gold ? 1 : 0.3")
			)

			(block
				(style (marginLeft = 35px))
				(bind name "'PremiumAccountPeriod_' + duration")
				(tf
					(class $TextDefault18NM)
					(style (alpha = "TA"))
					(bind text "'IDS_PREMIUM_PERIOD_' + duration")
				)
			)

			(hblock
				(style
					(position = "absolute")
					(align = "middle")
					(right = "SXS")
					(height = 100%)
				)
				
				(block
					(bind visible "cashbackGold > 0")
					(style 
						(align = "middle")
						(marginRight = "S")
					)
					(controller $Instance renderer='CashbackItem'
						(bind enabled "cashbackGold > 0")
						(args
							_entityId = "_premItemEntity.id"
						)
					)
				)

				(block
					(bind name "'PremiumAccountPeriod_' + duration")
					(style (align = "middle"))
					(element PriceTag
						_priceInfo = "priceInfo.info"
						_showDiscountTag = true
						_size = "SIZE.MEDIUM"
					)
				)
			)
		)
	)
)

(def element CashbackItem (_entityId:number = 0)
	(block
		(style
			(width = 23px)
			(height = 20px)
			(backgroundSize = "cover")
			(bind backgroundImage 'url:../service_kit/icons/cashback.png')
		)
	)

	(controller $Tooltip
		(renderer='CashbackItemTooltip')
		(args
			_entityId = "_entityId"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR "1")
	)
)

(def element CashbackItemTooltip (_entityId:number)
	(scope
		(var premItemEntity:dhEntity = "getEntity(_entityId)")
		(var cashbackDays:number = "premItemEntity.premiumItem.cashbackDays ?: 0" (event "premItemEntity.premiumItem.evChanged"))
		(var cashbackGold:number = "premItemEntity.premiumItem.cashbackGold ?: 0" (event "premItemEntity.premiumItem.evChanged"))
	)

	(style (width = 360px))
	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND)
	(element TOOLTIP_SYSTEM_DEFAULT_CONTAINER
		(element TooltipSystemHeaderSubheaderText 
			_headerText='IDS_COMPENSATION' 
		)

		(element TooltipSystemHorizontalDivider)

		(element TooltipSystemDescriptionText
			_descriptionText='IDS_COMPENSATION_DESCR'
		)

		(element TooltipSystemHorizontalDivider)

		(block
			(style (width = 100%))
			(macro TOOLTIP_SYSTEM_INNER_PANEL_BACKGROUND)
			(element TOOLTIP_SYSTEM_ELEMENTS_GROUP

				(element TOOLTIP_SYSTEM_GROUP_ELEMENT
					(element TooltipSystemPriceTagLine
						_title =		'IDS_COMPENSATION_PRICE'
						_priceInfo =	"{finalPrice: cashbackGold, currency: SC.Common.CURRENCIES.GOLD}"
					)
				)

				(element TOOLTIP_SYSTEM_GROUP_ELEMENT
					(element TooltipSystemParamTextLine 
						_text = 'IDS_COMPENSATION_INTERSECTION'
						_value = "subst('IDS_COMPENSATION_DAYS', [], {days: cashbackDays}, cashbackDays)"
						_valueClass = '$TextDefaultBoldNM'
						_isValueAlignRight = true
					)
				)
			)
		)
	)
)