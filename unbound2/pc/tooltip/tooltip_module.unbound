(def element ModuleTooltip (_moduleEntity:dhEntity, _noMouseInstructions:bool=false, _isInteractiveSlot:bool = false, _isClickableSlot:bool = false)
	(scope
		(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_SCOPE)

		(var moduleComponent:dhComponent = "_moduleEntity.module")
		(var moduleComponentId:number = "moduleComponent.id ?: 0" (event "moduleComponent.evUpdated"))

		(var moduleType:str = "moduleComponent.type ?: ''" (event "moduleComponent.evUpdated"))

		(var nextShipId:number = "moduleComponent.nextShipId")
		(var hasNextShipId:bool = "toBool(nextShipId)")

		(var canBuy:bool = "moduleComponent.canBuy" (event "moduleComponent.evUpdated"))

		(var isExplored:bool = "moduleComponent.isExplored" (event "moduleComponent.evUpdated"))
		(var isPurchased:bool = "moduleComponent.isPurchased" (event "moduleComponent.evUpdated"))

		(var isExplorationLocked:bool = "!canBuy && !isPurchased")

		(struct purchasePrice =	PULL_PRICE(_entityId = "toString(moduleComponentId)"	_actionId = "SC.Common.PRICE_ACTION.BUY"))
		(struct researchPrice =	PULL_PRICE(_entityId = "toString(moduleComponentId)"	_actionId = "SC.Common.PRICE_ACTION.RESEARCH"))

		(macro PULL_SHIP_ID)
		(var shipEntity:dhEntity = "getPrimaryEntity(CC.ship, viewedShipId)")
		(var upgradableShipInfo:dhComponent = "shipEntity.upgradableShipInfo")

		(var ownShipEntity:dhEntity = "getPrimaryEntity(CC.ownShip, viewedShipId)")
		(var isShipInBalancer:bool = "ownShipEntity.ownShip.lock == SC.Common.OWN_SHIP_LOCK.BALANCER" (event "ownShipEntity.ownShip.evUpdateLock"))
		(var isShipReadyForBattle:bool = "ownShipEntity.ownShip.lock == SC.Common.OWN_SHIP_LOCK.DIVISION_IS_READY" (event "ownShipEntity.ownShip.evUpdateLock"))

		(var isNeedRepair:bool = "ownShipEntity ? ownShipEntity.ownShip.isNeedRepair : false" (event "ownShipEntity.ownShip.evUpdateDockState"))

		(var isOwned:bool = "ownShipEntity != null")
		(var isInstalled:bool = "_moduleEntity.hasComponent(CC.installedModule) && isOwned")
		(var isStockModule:bool = "_moduleEntity.hasComponent(CC.stockModule)")

		(var headerIconPath:str = "	'url:../modules/icon_module' +	moduleType +	(isPurchased	? '' :
																					isExplored		? '_researched'
																									: '_not_owned') + '.png'")

		(var headerText:str = "moduleComponent.nameText ?: ''" (event "moduleComponent.evUpdated"))
		(var subheaderText:str = "moduleComponent.subTypeIDS ?: toUpper('IDS_MODULE_TYPE' + moduleType)" (event "moduleComponent.evUpdated"))

		(var isResearchPriceVisible:bool = "!isExplored && (!isStockModule || (isStockModule && upgradableShipInfo.isExplored)) && !isExplorationLocked && (researchPrice.info.finalPrice > 0)")
		(var isBuyPriceVisible:bool = "!isPurchased && (!isStockModule || (isStockModule && isOwned)) && !isExplorationLocked && (purchasePrice.info.finalPrice > 0)")

		(var moduleStateInfo:dict = "	isExplorationLocked								? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.LOCK,
																							text: 'IDS_MODULE_STATE_CANNOT_BUY' } :
										isInstalled										? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.CHECK,
																							text: 'IDS_MODULE_STATE_INSTALLED' } :
										isPurchased										? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.INFO,
																							text: 'IDS_MODULE_STATE_AVAILABLE' } :
										isExplored && isBuyPriceVisible && !isOwned		? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.INFO,
																							text: 'IDS_MODULE_STATE_RESEARCHED_SHIP_NOT_OWNED' } :
										isExplored && isBuyPriceVisible					? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.INFO,
																							text: 'IDS_MODULE_STATE_RESEARCHED' } :
										isStockModule									? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.INFO,
																							text: 'IDS_STOCK_MODULE_INFO' }
																						: null")

		(var mouseInstruction:dict = "	_noMouseInstructions										? null :
										_isClickableSlot											? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT,
																										text: 'IDS_OPEN_MODULES_LIST_MOUSE_INSTRUCTION' } :
										_isInteractiveSlot && isShipInBalancer 						? { unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.WARNING,
																										text: 'IDS_UNABLE_TO_SET_WHILE_IN_BALANCER' } :
										_isInteractiveSlot && isShipReadyForBattle					? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.ATTENTION,
																										text: 'IDS_SET_UNREADY_DIVISION_FIRST_TO_MANAGE_SHIP' } :
										_isInteractiveSlot && isNeedRepair							? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.ATTENTION,
																										text: 'IDS_SERVICE_SHIP_TO_MANAGE_SHIP' } :
										!isOwned || isInstalled || isExplorationLocked				? null :
										isResearchPriceVisible										? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT,
																										text: 'IDS_DO_RESEARCH_MODULE_TOOLTIP' } :
										isBuyPriceVisible											? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT,
																										text: 'IDS_DO_BOUGHT_MODULE_TOOLTIP' } :
										isPurchased													? {	unifiedStatus: SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT,
																										text: 'IDS_MOUSE_INSTRUCTION_INSTALL_MODULE' }
																									: null")
	)
	(bindcall externalCall 'direct.action' "['makeModuleParams', { moduleId: moduleComponentId }]" init=false watch=false (event "evStartShow"))
	(style
		(width = 340px)
		
		(hitTest = false)
	)

	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_MARKUP)
	(element TOOLTIP_SYSTEM_DEFAULT_CONTAINER
		(element TooltipSystemHeaderWithIconAndText
			_imageUrl =			"headerIconPath"
			_imageWidth =		60px
			_imageHeight =		60px
			_headerText =		"headerText"
			_subheaderText =	"subheaderText"
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemHorizontalDivider' (bind enabled "moduleStateInfo"))
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemStatusLine'
				(bind enabled "moduleStateInfo")
				(args
					_unifiedStatus = "moduleStateInfo.unifiedStatus"
					_text = "moduleStateInfo.text"
				)
			)
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemHorizontalDivider' (bind enabled "isResearchPriceVisible"))
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemAlterablePriceTagLine'
				(bind enabled "isResearchPriceVisible")
				(args
					_title = 'IDS_RESEARCH_COST'
					_priceInfo = "researchPrice.info"
				)
			)
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemHorizontalDivider' (bind enabled "isBuyPriceVisible"))
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemAlterablePriceTagLine'
				(bind enabled "isBuyPriceVisible")
				(args
					_title = 'IDS_PURCHASE_COST'
					_priceInfo = "purchasePrice.info"
				)
			)
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemHorizontalDivider' (bind enabled "hasNextShipId"))
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemShipWithTitle'
				(bind enabled "hasNextShipId")
				(args
					_title = 'IDS_MODULES_SHIP_CROSS_RESEARCH'
					_shipId = "nextShipId"
					_withFlag = true
				)
			)
		)

		(element TooltipSystemHorizontalDivider)

		(element ModuleParametersAdapter
			_ttxDescriptor = "moduleType"
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemHorizontalDivider' (bind enabled "mouseInstruction"))
		)

		(block
			(style (width = 100%))
			(controller $Instance renderer='TooltipSystemStatusLine'
				(bind enabled "mouseInstruction")
				(args
					_unifiedStatus = "mouseInstruction.unifiedStatus"
					_text = "mouseInstruction.text"
				)
			)
		)
	)
)

(def element ModulesInfotip (_modulesByTypeCollection:dhCollection)
	(style (width = 360px))

	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND _isInfotip = "true")

	(element INFOTIP_SYSTEM_DEFAULT_CONTAINER _hasInsideOffset = true
		(style
			(width = 100%)
			(vgap = "XXS")
		)

		(controller $Repeat renderer='ModuleSlotInfotipItem'
			(bind count "_modulesByTypeCollection.length")
			(args
				_moduleEntity = "_modulesByTypeCollection.getEntityAtIndex($index)"
				_modulesInSlotLen = "_modulesByTypeCollection.length"
			)
		)
	)
)

(def element ModuleSlotInfotipItem (_moduleEntity:dhEntity, _modulesInSlotLen:number)
	(scope
		(var accountResource:dhComponent = "getSingleComponent(CC.accountResource)")
		(var isOperationsAccountLocked:bool = "accountResource.operationsLocked" (event "accountResource.evOperationsLockChanged"))

		(var moduleInfo:dhComponent = "_moduleEntity.module" autoUpdate=false)
		(var isModuleExplored:bool = "moduleInfo.isExplored" (event "moduleInfo.evUpdated"))
		(var isModulePurchased:bool = "moduleInfo.isPurchased" (event "moduleInfo.evUpdated"))
		(var canBuy:bool = "moduleInfo.canBuy" (event "moduleInfo.evUpdated"))
		(var explorationLocked:bool = "!canBuy && !isModuleExplored && !isModulePurchased")

		(var nextShipId:number = "moduleInfo.nextShipId")
		(var hasNextShipId:bool = "toBool(nextShipId)")

		(var moduleType:str = "moduleInfo.type" (event "moduleInfo.evUpdated"))
		(var moduleDepth:number = "moduleInfo.depth" (event "moduleInfo.evUpdated"))
		(var modulePK:str = "moduleType + '_' + moduleDepth")

		(var isInstalled:bool = "_moduleEntity.hasComponent(CC.installedModule)")	
		(var moduleId:number = "moduleInfo.id" (event "moduleInfo.evUpdated"))
		(var expDeficit:number = "moduleInfo.expDeficit ?: 0" (event "moduleInfo.evUpdated"))
		(var creditsDeficit:number = "moduleInfo.creditsDeficit ?: 0" (event "moduleInfo.evUpdated"))

		(struct moduleExplorePrice =	PULL_PRICE(_entityId = "toString(moduleId)" _actionId = "SC.Common.PRICE_ACTION.RESEARCH"))
		(struct moduleBuyPrice =		PULL_PRICE(_entityId = "toString(moduleId)" _actionId = "SC.Common.PRICE_ACTION.BUY"))

		(var isDeficit:bool = "!isModuleExplored	?	expDeficit > 0
													:	creditsDeficit > 0")
		(var priceInfo:dict = "!isModuleExplored	? moduleExplorePrice.info
													: moduleBuyPrice.info")

		
		(macro PULL_SHIP_ID)
		(var shipEntity:dhEntity = "getPrimaryEntity(CC.ship, viewedShipId)")
		(var upgradableShipInfo:dhComponent = "shipEntity.upgradableShipInfo")

		(var ownShipEntity:dhEntity = "getPrimaryEntity(CC.ownShip, viewedShipId)")
		(var ownShipInfo:dhComponent = "shipEntity.ownShip")
		(var isShipOwned:bool = "ownShipEntity != null")
		(var isNeedRepair:bool = "ownShipInfo.isNeedRepair" (event "ownShipInfo.evUpdateDockState"))

		(var isShipExplored:bool = "upgradableShipInfo.isExplored" (event "upgradableShipInfo.evUpdate"))
		(var isModulePriceVisible:bool = "(isShipExplored && !isModuleExplored) || (isShipOwned && !isModulePurchased)")

		(var isExploreLocked:bool = "isNeedRepair || isOperationsAccountLocked || explorationLocked")
		(var isManagementOperationsLocked:bool = "isExploreLocked && isModulePurchased")
		

		
		(var iconPath:str = "'url:../modules/icon_module' +	moduleType + (	isModulePurchased	? '' :
																			isModuleExplored	? '_researched'
																								: '_not_owned') + '.png'")

		(var headerText:str = "moduleInfo.nameText ?: ''" (event "moduleInfo.evUpdated"))

		(var subheaderText:str = "moduleInfo.subTypeIDS != ''	? moduleInfo.subTypeIDS
																: toUpper('IDS_MODULE_TYPE' + moduleType)" (event "moduleInfo.evUpdated"))

		(macro MOUSE_HANDLER_SCOPE)

		(var isClickableSlot:bool = "(isModulePriceVisible || isShipOwned) && !(isManagementOperationsLocked || isInstalled)")

		(var infotipItemBGState:number = "	isInstalled			? SC.Ui_styles.BUTTON_STATE.SELECTED :
											!isClickableSlot	? SC.Ui_styles.BUTTON_STATE.DISABLED :
											mouseDown			? SC.Ui_styles.BUTTON_STATE.DOWN :
											rollOver			? SC.Ui_styles.BUTTON_STATE.OVER
																: SC.Ui_styles.BUTTON_STATE.UP")
	
	
		(var moduleIndex:number = "$index")
	)

	(bind name "'module_infotip_item_' + moduleInfo.name")

	(dispatch evHideInfotip dir="EventDirection.UP" delay=0.15 (bind enabled "isInstalled") (bind trigger "isInstalled"))
	(style (width = 100%))

	(block
		(style
			(width = 100%)
			(backgroundColor = "NO_COLOR")
		)

		(controller $Tooltip
			(renderer = 'ModuleTooltip')
			(args
				_moduleEntity = "_moduleEntity"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR "0")
		)

		(element MenuItemBackground
			_state = "infotipItemBGState"
		)

		(hblock
			(style
				(width = 100%)
				(align = "middle")
				(paddingTop = "S")
				(paddingBottom = "S")
				(paddingLeft = "SXS")
				(paddingRight = "SXS")
				(hitTest = false)
			)

			(block
				(style
					(align = "middle")
					(width = 70px)
					(minHeight = 70px)
					(height = 100%)
				)

				(block
					(style
						(width = 60px)
						(height = 60px)
						(bind backgroundImage "iconPath")
						(backgroundSize = "cover")
					)

					(block
						(style
							(position = "absolute")
							(vgap = "XS")
							(hitTest = false)
							(top = "XS")
						)

						(controller $Repeat renderer='ShipModuleStateIcon'
							(bind count "_modulesInSlotLen")
							(args
								_isActive = "moduleIndex == $index"
							)
						)
					)
				)
			)

			
			(block
				(style (width = 170px))

				(tf
					(class $TextDefaultBoldNM)
					(style
						(width = 100%)
						(leading = -2)
						(alpha = "TA")
					)

					(bind text "headerText")
				)

				(hblock
					(style (marginTop = "SXS"))

					(tf
						(class $TextDefaultNM)
						(style (alpha = "TC"))
						(bind text "subheaderText")
					)
				)
			)

			
			(block
				(style
					(position = "absolute")
					(align = "middle")
					(right = 0px)
					(height = 100%)
				)

				(block
					(controller $Instance renderer='PriceTag'
						(bind enabled "isModulePriceVisible")
						(args
							_priceInfo =		"priceInfo"
							_showDiscountTag =	true
						)
					)
				)

				(block
					(bind visible "isInstalled && isShipOwned")
					(style
						(marginRight = "-XXS")
						(width = 19px)
						(height = 19px)
						(backgroundSize = "cover")
						(backgroundImage = 'url:../service_kit/unified_status_icons/icon_check.png')
					)
				)
			)
		)

		(macro MOUSE_HANDLER
			_enabled = "isClickableSlot"
			_soundSet =	"'button_signal'"
			_methods =	"[ {
									type:	!isModuleExplored || !isModulePurchased 	? 'inputMapping.onRequest'
																						: 'inputMapping.onAction',

									name:	!isModuleExplored		? 'openResearchModuleWindow' :
											!isModulePurchased		? 'openPurchaseAndInstallModuleWindow'
																	: 'installModule',
									args:	!isModuleExplored || !isModulePurchased	?	{ modulePK: modulePK }
																					:	{ shipId: viewedShipId, moduleId: moduleInfo.id }
								}]"
		)
	)

	(block
		(style
			(width = 100%)
			(bind marginTop "hasNextShipId ? XS : 0px")
		)
		(controller $Instance renderer='HorizontalDividerTwoPx' (bind enabled "hasNextShipId"))
	)

	(block
		(bind visible "hasNextShipId")
		(style
			(width = 100%)
			(paddingTop = "SXS")
			(paddingBottom = "SXS")
			(paddingLeft = "SXS")
			(paddingRight = "SXS")
		)
		(controller $Instance renderer='TooltipSystemShipWithTitle'
			(bind enabled "hasNextShipId")
			(args
				_title = 'IDS_SLOT_MODULES_SHIP_CROSS_RESEARCH'
				_shipId = "nextShipId"
				_withFlag = true
			)
		)
	)
)