(def constant TIP_POSITION_TOP			'top')
(def constant TIP_POSITION_BOTTOM		'bottom')
(def constant TIP_POSITION_LEFT			'left')
(def constant TIP_POSITION_RIGHT		'right')

(def constant POINTER_DIRECTION_UP		'up')
(def constant POINTER_DIRECTION_DOWN	'down')
(def constant POINTER_DIRECTION_LEFT	'left')
(def constant POINTER_DIRECTION_RIGHT	'right')

(def css $ContextGuidingTipTextPaddings ()
	(width = 100%)
	(paddingRight = "M")
	(paddingLeft = "M")
	(paddingTop = "M")
	(paddingBottom = "SXS")
)

(def element GuidingTipPointer ()
	(style
		(width = 1px)
		(height = 1px)
		(align = "center|middle")
		(hitTest = false)
	)

	(block
		(style
			(width = 58px)
			(height = 58px)
			(backgroundImage = 'url:../animations/spine/guiding_tip_pin/guiding_tip_pin.skel')
			(alpha = 1.3)
			(hitTest = false)
			(scaleX = 1.3)
			(scaleY = 1.3)
		)
		(colorTransform = "COLOR_TRANSFORM_ACCENT_BLUE")

		(controller $Spine
			(bind speed "0.8")
		)
	)
)

(def element ContextGuidingTip (_tipId:number, _direction:str, _pointerOffset:number, _alongPointerOffset:number, _noPointer:bool, _tipDescription:str, _tipHeader:str, _hasNextButton:bool, _hasFinishButton:bool)
	(scope
		
		(struct highContrast = HIGH_CONTRAST_INFO())
		(var isHighContrast:bool = "highContrast.isEnabled")
		(var hasButtonsBlock:bool = "_hasNextButton || _hasFinishButton")

		(var isHorizontalDirection:bool = "isIn(_direction, [ POINTER_DIRECTION_LEFT, POINTER_DIRECTION_RIGHT ])")
	)

	(macro HIDE_UI_ON_SHIPOVERVIEW)
	(block
		(class $FullsizeAbsolute)
		(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_MARKUP
			_isInfotip = "true"
		)
	)

	(style (width = 340px))

	
	(block
		(class $FullsizeAbsolute)
		(style
			(bind align	"_direction	==	POINTER_DIRECTION_LEFT	? left|middle :
						 _direction	==	POINTER_DIRECTION_RIGHT	? right|middle :
						 _direction	==	POINTER_DIRECTION_UP	? top|center
																: bottom|center")

			(bind visualOffsetY	"isHorizontalDirection	? _alongPointerOffset
														: _pointerOffset")
			(bind visualOffsetX	"isHorizontalDirection	? _pointerOffset
														: _alongPointerOffset")
		)

		(controller $Instance renderer='GuidingTipPointer'
			(bind enabled "!_noPointer")
			(args
				_noPointer =			"_noPointer"
				_pointerOffset =		"_pointerOffset"
				_alongPointerOffset =	"_alongPointerOffset"
			)
		)
	)
	

	
	(block
		(style (width = 100%))

		
		(block
			(class $FullsizeAbsolute)
			(style
				(backgroundImage = 'url:../service_kit/guiding_tip/background.png')
				(backgroundSize = "fill")
				(borderRadius = "XS")
			)
			(colorTransform = "COLOR_TRANSFORM_ACCENT_BLUE")
		)
		
	
		
		(block
			(name = 'contextGuidingTip')

			(style (width = 100%))

			(block
				(name = 'contextGuidingTipHeader')

				(class $ContextGuidingTipTextPaddings)

				(tf
					(class $TextDefaultBold20NM)
					(style (width = 100%))

					(text = "_tipHeader")
				)
			)

			(element HorizontalDividerTwoPx)
		)
		

		
		(block
			(style (width = 100%))
			
			(block
				(class $FullsizeAbsolute)
				(style
					(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.INNER_PANEL")

					(borderRadiusBottomLeft = "hasButtonsBlock ? 0 : XS")
					(borderRadiusBottomRight = "hasButtonsBlock ? 0 : XS")
				)
			)

			(block
				(name = 'contextGuidingTipDescription')

				(class $ContextGuidingTipTextPaddings)

				(tf
					(class $TextDefault18NM)
					(style
						(width = 100%)
						(marginBottom = "S")
						(multiline = true)
						(alpha = "TC")
						(leading = -3)
						(styleSheet = '.p_spacing { font-size: 8px; }')
					)

					(htmlText = "_tipDescription")
				)
			)

			(block
				(bind visible "hasButtonsBlock")
				(style (width = 100%))
				(element HorizontalDividerTwoPx)
			)
		)
		

		
		(block
			(bind name "'btnCloseTip'")

			(style
				(position = "absolute")
				(top = 17px)
				(right = 15px)
			)

			
			(element CloseButton
				_methods = "[{ type: 'inputMapping.onAction', name: 'deactivateCurrentTipChain', args: { tip_id: _tipId } }]"
			)
		)

		(block
			(bind visible "_hasNextButton")

			(style
				(align = "center|middle")
				(width = 100%)
				(padding = "M")
			)
			
			(element DefaultButton
				_width = 120
				_size = "SIZE.SMALL"
				_label = 'IDS_NEWBIE_QUESTS_TOOLTIP_BUTTON_NEXT'
				_methods = "[{ type: 'inputMapping.onAction', name: 'nextTipButton', args: {} }]"
			)
		)

		(block
			(bind visible "_hasFinishButton")

			(style
				(align = "center|middle")
				(width = 100%)
				(padding = "M")
			)

			(element DefaultButton
				_width = 120
				_size = "SIZE.SMALL"
				_label = 'IDS_NEWBIE_QUESTS_TOOLTIP_BUTTON_FINISH'
				_methods = "[{ type: 'inputMapping.onAction', name: 'deactivateCurrentTipChain', args: { tip_id: _tipId } }]"
			)
		)
		
	)
	

	
	(block
		(class $FullsizeAbsolute)
		(style
			(hitTest = false)
			(backgroundImage = 'url:../service_kit/panel_backgrounds/stroke_one_px_with_br4.png')
			(scale9grid = 4)
		)
		
		(colorTransform = "COLOR_TRANSFORM_ACCENT_BLUE")
	)
	
)



(def element GuidingTipHub (_tipId:number,
							_tipType:str,
							_modalWindowName:str,
							_offsetX:number=0,
							_offsetY:number=0,
							_tipPositioning:str='no_item',
							_noPointer:bool=false,
							_pointerOffset:number=0,
							_alongPointerOffset:number=0,
							_tipChainId:number=null,
							_hasNextButton:bool=false,
							_hasFinishButton:bool=false,
							_onShowDelay:number=0,
							_keepOnNotFit:bool=false,
							_screenOffsetLeft:number=0,
							_screenOffsetTop:number=0,
							_screenOffsetRight:number=0,
							_screenOffsetBottom:number=0,
							_isHideOnBounds:bool = false)
	(scope
		(var reasonOnStage:bool = false)
		(bind reasonOnStage "true" init=false watch=false on='addedToStage')
		(bind reasonOnStage "false" init=false watch=false on='removedFromStage')

		(macro PULL_CURRENT_TOP_WINDOW_NAME)
		(var isOnTop:bool = "currentTopWindowName == _modalWindowName")

		(event evGuidingTipOpen)
		(event evGuidingTipClose)
		
		(var tipEntity:dhEntity =		"getPrimaryEntity(CC.newGuidingTip, _tipId)")
		(var tipComponent:dhComponent =	"tipEntity.newGuidingTip")

		(var header:str =		"tipComponent.header	?: ''"		(event "tipComponent.evChanged"))
		(var desc:str =			"tipComponent.desc		?: ''"		(event "tipComponent.evChanged"))
		(var isActive:bool =	"tipComponent.isActive	?: false"	(event "tipComponent.evChanged"))
		(var targetID:str =		"tipComponent.targetID	?: ''"		(event "tipComponent.evChanged"))
		
		(var isTipVisible:bool = "tipComponent != null && isOnTop && isActive && reasonOnStage")

		(var direction:str = "	_tipPositioning == TIP_POSITION_TOP		?	POINTER_DIRECTION_DOWN	:
								_tipPositioning == TIP_POSITION_BOTTOM	?	POINTER_DIRECTION_UP	:
								_tipPositioning == TIP_POSITION_LEFT	?	POINTER_DIRECTION_RIGHT	:
								_tipPositioning == TIP_POSITION_RIGHT	?	POINTER_DIRECTION_LEFT
																		:	'no_item'")
	)

	(bind name "'NewGuidingTip_' + _tipId")

	(dispatch evGuidingTipOpen	dir="EventDirection.NONE" (bind enabled "isTipVisible") (bind trigger "isTipVisible"))
	(dispatch evGuidingTipClose	dir="EventDirection.NONE" (bind enabled "!isTipVisible") (bind trigger "isTipVisible"))

	(class $FullsizeAbsolute)

	(block
		(bind visible "_tipType == 'panel'")

		(class $Fullsize)
		(style
			(hitTest = false)
			(padding = "-XS")
		)

		(block
			(class $Fullsize)
			(style
				(backgroundImage = 'url:../service_kit/panel_backgrounds/new_tip_sector.png')
				(scale9grid = 6)
			)
		)
	)
	
	(controller $Tooltip
		(renderer = 'ContextGuidingTip')
		(args
			_tipId =				"_tipId"
			_tipHeader =			"tr(header)"
			_tipDescription =		"tr(desc)"
			_direction =			"direction"
			_pointerOffset = 		"_pointerOffset"
			_alongPointerOffset =	"_alongPointerOffset"
			_tipChainId =			"_tipChainId"
			_hasNextButton =		"_hasNextButton"
			_hasFinishButton =		"_hasFinishButton"
			_noPointer =			"_noPointer"
		)

		(macro GUIDING_TIP_BEHAVIOUR)
	)
)

(def macro GUIDING_TIP_BEHAVIOUR ()
	(bindcall show
			animation =	{
				duration:	0.3,
				delay:		"_onShowDelay ? _onShowDelay : 0.5",
				easing:		"Easing.cubic_out",
				from:		{ alpha: 0, top: 10 },
				to:			{ alpha: 1, top: 0 }
			}
			(event "evGuidingTipOpen")
	)

	(bindcall hide
			animation = {
				duration:	0.15,
				delay:		0,
				easing:		"Easing.cubic_out",
				from:		{ alpha: 1, top: 0 },
				to:			{ alpha: 0, top: -5 }
			}
			(event "evGuidingTipClose")
	)
	(hideAnimation = {	duration:	0.15,
						delay:		0,
						easing:		"Easing.cubic_out",
						from:		{ alpha: 1, top: 0 },
						to:			{ alpha: 0, top: -5} })

	(bind offset "{ x: _offsetX, y: _offsetY }")

	(bind screenBoundsOffset "{	left:	_screenOffsetLeft,
								top:	_screenOffsetTop,
								right:	_screenOffsetRight,
								bottom:	_screenOffsetBottom }")

	(bind align "	_tipPositioning == TIP_POSITION_TOP		?	top|center :
					_tipPositioning == TIP_POSITION_BOTTOM	?	bottom|center :
					_tipPositioning == TIP_POSITION_RIGHT	?	right|middle
															:	left|middle")
	(position="border")
	(tooltipType = "guiding")
	(bind hideOnBounds "_isHideOnBounds")
)
