(def constant TTX_EXPAND_CONTAINER_HEADER_HEIGHT 40px)

(def element DockTTXWidget (_isTTXWidgetVisible:bool)
	(scope
		(macro MOUSE_HANDLER_SCOPE)
		(macro USER_PREF_DATA)
		(var comparisonComponent:dhComponent = "getSingleComponent(CC.comparison)")
		(var panelTTX:dict = "comparisonComponent.panelTTX ?: {}" (event "comparisonComponent.evPanelTTXChanged"))
	)
	(class $TTXWidgetContainer)
	(style (maxHeight = 100%))

	(block
		(class $FullsizeAbsolute)

		(element TTX_WIDGET_EXPAND_CONTAINER _isExpanded="_isTTXWidgetVisible"
			(class $Fullsize)
			(element DockWidgetBackground)
		)
	)

	(block
		(style
			(width = 100%)
			(maxHeight = 100%)
		)

		(block
			(class $FullsizeAbsolute)
			(style
				(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.WHITE")
				(borderRadius = "XS")
			)
			(isMask = true)
		)

		(element TTX_WIDGET_EXPAND_CONTAINER _isExpanded="_isTTXWidgetVisible"
			(style (width = 100%))

			(block
				(style
					(width = 100%)
					(backgroundColor = "NO_COLOR")
				)
				(macro MOUSE_EVENTS_DISPATCHER)
				(macro SOUND_HANDLER _soundSet = "'dropdown'")
				(bindcall externalCall "'inputMapping.onAction'" "['setUserPref', { name: 'shipPanelExpanded', value: !userPrefs.shipPanelExpanded }]" watch=false on='leftClick')

				(hblock
					(class $Fullsize)
					(style
						(width = 100%)
						(height = "TTX_EXPAND_CONTAINER_HEADER_HEIGHT")
						(paddingLeft = "M")
						(paddingRight = "S")
						(align = "middle")
						(hitTest = false)
					)

					(tf
						(class $TextDefaultBold18NM)
						(style
							(width = 100%)
							(alpha = "TA")
						)
						(text = 'IDS_TTX_WIDGET_HEADER')
					)

					(element ButtonExpand
						_expanded = "userPrefs.shipPanelExpanded"
						_isInOverState = "rollOver"
						_isInDownState = "mouseDown"
					)
				)

				(block
					(style (width = 100%) (alpha = "userPrefs.shipPanelExpanded ? 1 : 0"))
			
					(controller $Animation
						(bindcall play
							delay = "userPrefs.shipPanelExpanded ? 0 : 0.1"
							duration = 0.15
							to = "userPrefs.shipPanelExpanded ? { alpha:1 } : { alpha:0 }"
							easing = "Easing.line"
							(bind trigger "userPrefs.shipPanelExpanded")
						)
					)

					(element HorizontalDividerTwoPx)
				)
			)
		)

		(scrollArea
			(style
				(width = 100%)
				(maxHeight = 100%)
				(backgroundColor = "NO_COLOR")
			)

			(macro DEFAULT_VERTICAL_SCROLL_PARAMS
				_singleStep = "150"
				_wheelScrollAcceleration = "0.8"
				_isContrastScrollBar = "true"
				_hasVerticalBorderOffset = "true"
			)

			(content
				(style (width = 100%))

				(element TTX_WIDGET_EXPAND_CONTAINER _isExpanded="userPrefs.shipPanelExpanded && _isTTXWidgetVisible"
					(style (width = 100%))

					(controller $Instance renderer='ShipTTX'
						(bind enabled "panelTTX != null")
						(args
							_shipTTX = "panelTTX"
						)
					)
				)
			)
		)
	)
)

(def css $TTXSecondaryPanel ()
	(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.INNER_PANEL")
	(paddingLeft = 36px)
	(paddingRight = 18px)
	(paddingTop = "XS")
	(paddingBottom = "XS")
)

(def element ShipTTX (_shipTTX:dict, _isExpanded:bool=true)
	(style (width = 100%))

	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_DURABILITY'			_elementName='DurabilityTTX' _module="_shipTTX.durability" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_AVIATION'				_elementName='SquadronsTTX' _module="_shipTTX.squadrons" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_WEAPONRY'				_elementName='ArtilleryTTX' _module="_shipTTX.artillery" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_PINGER'				_elementName='PingerTTX' _module="_shipTTX.pinger" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_TORPEDY'				_elementName='TorpedoesTTX'_module= "_shipTTX.torpedoes" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_TORPEDY'				_elementName='TorpedoGroupsTTX'_module= "_shipTTX.torpedoGroups" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_WAVES'					_elementName='WavesTTX'_module= "_shipTTX.waves" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_DEPTH_CHARGE'			_elementName='DepthChargesTTX' _module="_shipTTX.depthCharges" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_AIRSUPPORT'			_elementName='AirSupportTTX' _module="_shipTTX.airSupport" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_AIR_DEFENSE'			_elementName='AirDefenseTTX' _module="_shipTTX.airDefense" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_BATTERY'				_elementName='BatteryTTX' _module="_shipTTX.battery" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_MOBILITY'				_elementName='MobilityTTX' _module="_shipTTX.mobility" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_UNDERWATER_MOBILITY'	_elementName='UnderwaterMobilityTTX' _module="_shipTTX.underwaterMobility" _isExpanded="_isExpanded")
	(macro TTXRowInstance _shipTTX="_shipTTX" _title='IDS_SHIP_PARAM_VISIBILITY'			_elementName='VisibilityTTX' _module="_shipTTX.visibility" _isExpanded="_isExpanded")
)

(def macro TTXRowInstance (_shipTTX:expression, _title:str, _elementName:str, _module:expression, _isExpanded:expression="false")
	(block
		(style (width = 100%))
		(controller $Instance renderer='ShipTTXRow'
			(bind enabled "_module != null")
			(args _shipTTX="_shipTTX" _title="_title" _module="_module" _elementName="_elementName" _isExpanded="_isExpanded")
		)
	)
)

(def constant SHIP_TTX_SIMPLE_CONFIG "
	[
		{ _title: 'IDS_SHIP_PARAM_DURABILITY',			_module: 'durability'			},
		{ _title: 'IDS_SHIP_PARAM_AVIATION',			_module: 'squadrons'			},
		{ _title: 'IDS_SHIP_PARAM_WEAPONRY',			_module: 'artillery'			},
		{ _title: 'IDS_SHIP_PARAM_PINGER',				_module: 'pinger'				},
		{ _title: 'IDS_SHIP_PARAM_TORPEDY',				_module: 'torpedoes'			},
		{ _title: 'IDS_SHIP_PARAM_TORPEDY',				_module: 'torpedoGroups'		},
		{ _title: 'IDS_SHIP_PARAM_WAVES',				_module: 'waves'				},
		{ _title: 'IDS_SHIP_PARAM_DEPTH_CHARGE',		_module: 'depthCharges'			},
		{ _title: 'IDS_SHIP_PARAM_AIRSUPPORT',			_module: 'airSupport'			},
		{ _title: 'IDS_SHIP_PARAM_AIR_DEFENSE',			_module: 'airDefense'			},
		{ _title: 'IDS_SHIP_PARAM_BATTERY',				_module: 'battery'				},
		{ _title: 'IDS_SHIP_PARAM_MOBILITY',			_module: 'mobility'				},
		{ _title: 'IDS_SHIP_PARAM_UNDERWATER_MOBILITY',	_module: 'underwaterMobility'	},
		{ _title: 'IDS_SHIP_PARAM_VISIBILITY',			_module: 'visibility'			}
	]
")

(def element TooltipSystemShipTTX (_shipTTX:dict, _showOnlyDiff:bool=false)
	(style (width = 100%))

	(macro TOOLTIP_SYSTEM_INNER_PANEL_BACKGROUND)

	(block
		(style
			(width = 100%)
			(vgap = 6px)
		)

		(controller $Repeat renderer='SimpleShipTTXRowWrapper'
			(bind count "SHIP_TTX_SIMPLE_CONFIG.length")
			(args
				_title = "SHIP_TTX_SIMPLE_CONFIG[$index]._title"
				_module = "_shipTTX[SHIP_TTX_SIMPLE_CONFIG[$index]._module]"
				_hasDiff = "_shipTTX.hasDiff"
				_showOnlyDiff = "_showOnlyDiff"
			)
		)
	)
)

(def element SimpleShipTTXRowWrapper (_title:str, _module:dict, _hasDiff:bool=false, _showOnlyDiff:bool=false)
	(style (width = 100%))

	(controller $Instance renderer='SimpleShipTTXRow'
		(bind enabled "_module != null && (_showOnlyDiff ? _module.integralValue.delta != 0 : true)")
		(args
			_title = "_title"
			_integralValue = "_module.integralValue"
			_hasDiff = "_hasDiff"
		)
	)
)

(def element ShipIntegralParams (_showOnlyDiff:bool = true)
	(scope
		(var comparison:dhComponent = "getSingleComponent(CC.comparison)")
		(var modalTTX:dict =		"comparison.modalTTX"				(event "comparison.evModalTTXChanged"))
		(var hasModalDiff:bool =	"comparison.hasModalIntegralDiff"	(event "comparison.evModalTTXChanged"))
		
		(var panelTTX:dict =		"comparison.panelTTX" (event "comparison.evPanelTTXChanged"))

		(var paramsToShow:dict =	"_showOnlyDiff ? modalTTX : panelTTX")
		(var showParamsBlock:bool =	"_showOnlyDiff ? hasModalDiff : true")
	)
	(style (width = 100%))

	(controller $Instance renderer='ShipIntegralParamsInfo'
		(bind enabled "showParamsBlock")
		(args
			_shipTTX = "paramsToShow"
			_showOnlyDiff = "_showOnlyDiff"
		)
	)
)

(def element ShipIntegralParamsInfo (_shipTTX:dict, _showOnlyDiff:bool)
	(style (width = 100%))

	(block
		(style
			(width = 100%)
			(marginBottom = "S")
			(paddingLeft = "M")
		)
		(element StatusLine
			_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.DEFAULT"
			_text = 'IDS_AFTER_MOUNT'
			_width = 100%
		)
	)

	(element SimpleShipTTX
		_shipTTX = "_shipTTX"
		_showOnlyDiff = "_showOnlyDiff"
	)

	(block
		(style
			(width = 100%)
			(marginTop = "S")
			(marginBottom = "M")
		)
		(element HorizontalDividerTwoPx)
	)
)

(def element SimpleShipTTX (_shipTTX:dict, _showOnlyDiff:bool=false)
	(style
		(width = 100%)
		(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.INNER_PANEL")
		(borderRadius = "XS")
		(vgap = 6px)
		(paddingLeft = "M")
		(paddingRight = "M")
		(paddingTop = "SXS")
		(paddingBottom = "SXS")
	)

	(controller $Repeat renderer='SimpleShipTTXRowWrapper'
		(bind count "SHIP_TTX_SIMPLE_CONFIG.length")
		(args
			_title = "SHIP_TTX_SIMPLE_CONFIG[$index]._title"
			_module = "_shipTTX[SHIP_TTX_SIMPLE_CONFIG[$index]._module]"
			_hasDiff = "_shipTTX.hasDiff"
			_showOnlyDiff = "_showOnlyDiff"
		)
	)
)