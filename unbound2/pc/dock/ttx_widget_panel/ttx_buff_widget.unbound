(def element BuffWidget ()
	(scope
		(var portBuffCollection:dhCollection = "getCollectionByPath(CC.portBuff, 'sorted')")
		(var portBuffLen:number = "portBuffCollection.length ?: 0")

		(var isOnePortBuff:bool = "portBuffLen == 1")
		(var portBuffEntity:dhEntity = "portBuffCollection.getEntityAtIndex(0)")
		(var isNewPortBuff:bool = " portBuffEntity.hasComponent(CC.newItem)")
		(var firstPortBuffComponent:dhComponent = "portBuffEntity.portBuff")
		(var firstPortBuffState:str = "toLower(SC.Common.PORT_BUFF_STATE.VALUE_TO_NAME[firstPortBuffComponent.state])")

		(struct activeTip =			PULL_ACTIVE_GUIDING_TIP())
		(struct checkedTipId =		SAFE_CHECK_ACTIVE_TIP_ID(_tipId = "activeTip.tipId"		_validValues = "[	SC.Context_guiding_tip.TIP_TYPE.PORT_BUFF_FOR_EVENT_TTX_MODIFIERS_NEXT,
																												SC.Context_guiding_tip.TIP_TYPE.PORT_BUFF_FOR_EVENT_TTX_MODIFIERS_FINAL ]"))

		(struct qualityGraphicsPref = GET_PREF_STR(_option="'graphics.preset'"))
		(var qualityGraphics:str = "qualityGraphicsPref.value")
		(var isStatic:bool = "isIn(qualityGraphics, [SC.Ui_prefs.GRAPHICS_PRESET.LOW, SC.Ui_prefs.GRAPHICS_PRESET.MINIMUM])")
	)

	(class $TTXWidgetContainer)
	(style (height = 76px))

	(block
		(class $FullsizeAbsolute)

		(element BlurMapRoundedWithContrastPanel
			_roundSize = "SIZE.SMALL"
		)
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundSize = "cover")
			(borderRadius = "XS")
			(bind backgroundImage "'url:../bg/animated/buffs_consumables_bg/buffs_bg.skel'")
		)
		(controller $Spine
			(mergeLayers = true)
			(bindcall pause init=true	(bind enabled "isStatic"))
			(bindcall resume			(bind enabled "!isStatic"))
		)
	)

	(block
		(class $Fullsize)
		(style (bind paddingLeft "isOnePortBuff ? L : 0"))

		
		(block
			(macro DEFAULT_CONTROL_MARKER_ANIMATION "isNewPortBuff")
			(style
				(position = "absolute")
				(top = 6px)
				(right = -6px)
			)
			(element MarkerNew)
		)

		(hblock
			(class $Fullsize)
			(style (bind align "isOnePortBuff ? left|middle : center|middle"))

			(hblock
				(controller $Repeat renderer='BuffItem'
					(bind count "portBuffLen")
					(args
						_buffEntity = "portBuffCollection.getEntityAtIndex($index)"
						_isNewPortBuff = "isNewPortBuff"
					)
				)
			)

			(block
				(bind visible "isOnePortBuff")

				(style (width = 100%))

				(tf
					(class $TextDefaultBold18NM)
					(style
						(alpha = "TA")
						(width = 100%)
						(marginRight = "MS")
						(leading = -3)
					)

					(bind text "firstPortBuffComponent.header")
				)

				(tf
					(class $TextDefaultNM)
					(style
						(alpha = "TA")
						(marginTop = "S")
					)

					(bind text "tr('IDS_BUFF_' + SC.Common.PORT_BUFF_STATE.VALUE_TO_NAME[firstPortBuffComponent.state])")
				)
			)
		)
	)

	(controller $Instance renderer='GuidingTipHub'
		(bind enabled "checkedTipId.value")
		(args
			_tipId =			"checkedTipId.value"
			_tipPositioning =	"TIP_POSITION_LEFT"
			_offsetX =			"XS"
			_noPointer =		true
			_hasNextButton =	"checkedTipId.value == SC.Context_guiding_tip.TIP_TYPE.PORT_BUFF_FOR_EVENT_TTX_MODIFIERS_NEXT"
			_hasFinishButton =	"checkedTipId.value == SC.Context_guiding_tip.TIP_TYPE.PORT_BUFF_FOR_EVENT_TTX_MODIFIERS_FINAL"
			_modalWindowName =	"SC.Ui_windows.WINDOWS.DOCK"
		)
	)
)

(def element BuffItem (_buffEntity:dhEntity, _isNewPortBuff:bool = false)
	(scope
		(var portBuffIcon:str = "_buffEntity.portBuff.iconPath")
		(var state:number = "_buffEntity.portBuff.state")
	)

	(bindcall externalCall "_isNewPortBuff ? 'inputMapping.onAction' : ''" "['makeAllPortBuffCollectionSeen', {}]" watch=false on='rollOver')

	(style
		(width = 44px)
		(height = 44px)
		(marginRight = "SXS")
		(bind backgroundImage "'url:../powerups/modifiers/' + portBuffIcon + '_small.png'")

	)

	(bind colorTransform "BUFF_COLOR_TRANSFORMS[SC.Common.PORT_BUFF_STATE.VALUE_TO_NAME[state]]")

	(controller $Tooltip
		(renderer='ShipEventModifierTooltip')
		(args
			_buffEntityId = "_buffEntity.id"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)


(def element EventBuffBackground (_maxSpineWidth:number = 320, _borderRadius:number = 0)
	(scope
	
		
		(struct qualityGraphicsPref = GET_PREF_STR(_option="'graphics.preset'"))
		(var qualityGraphics:str = "qualityGraphicsPref.value")
		(var isStatic:bool = "isIn(qualityGraphics, [SC.Ui_prefs.GRAPHICS_PRESET.LOW, SC.Ui_prefs.GRAPHICS_PRESET.MINIMUM])")
	)

	(class $Fullsize)

	
	(block
		(class $FullsizeAbsolute)

		(element BlurMapRoundedWithContrastPanel
			_roundSize = "SIZE.MEDIUM"
		)
	)

	(block
		(style
			(width = "_maxSpineWidth")
			(height = 100%)
			(backgroundSize = "cover")
			(bind backgroundImage "'url:../bg/animated/buffs_consumables_bg/consumables_bg.skel'")
		)
		(controller $Spine
			(mergeLayers = true)
			(bindcall pause init=true	(bind enabled "isStatic"))
			(bindcall resume			(bind enabled "!isStatic"))
		)
	)

	
	
	
	
	
	

	
	
	
	
	
	
	
	
	

	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundColor = 0xffffffff)
			(borderRadius = "_borderRadius")
		)
		(isMask = true)
	)
)