(def constant PORT_MAIN_INSETS "{
	SC.Ui_windows.ROUTE.ACTIVITIES:			'ActivitiesMainInset',
	SC.Ui_windows.ROUTE.SHIP:				'ShipMainInset',
	SC.Ui_windows.ROUTE.CLAN:				'ClanMainInset',
	SC.Ui_windows.ROUTE.RESEARCH:			'ShipResearchMainInset'
}")

(def constant ACTIVITIES_INSET_PAGES "{
	SC.Ui_windows.ROUTE.WAFFENTRAGER: 		'WaffentragerMainInset',
	SC.Ui_windows.ROUTE.EVENTS:				'EventsDockMainInset',
	SC.Ui_windows.ROUTE.SSE:				'SseMainInset',
	SC.Ui_windows.ROUTE.LOOTBOXES:			'BargeMainInset',
	SC.Ui_windows.ROUTE.SHIP_MASTERY:		'ShipMasteryMainInset'
}")

(def constant SHIP_INSET_PAGES "{
	SC.Ui_windows.ROUTE.OVERVIEW:  			'ShipManagementMainInset',
	SC.Ui_windows.ROUTE.UPGRADES:  			'ShipManagementMainInset',
	SC.Ui_windows.ROUTE.CREW_MANAGEMENT:	'CrewManagementMainInset',
	SC.Ui_windows.ROUTE.ECOBOOSTS:			'EconomicsManagementMainInset',
	SC.Ui_windows.ROUTE.CAMOUFLAGE:			'CamouflageMainInset',
	SC.Ui_windows.ROUTE.ENSIGN:				'EnsignDockMainInset'
}")

(def css $DockInsetPageContent ()
	(extends $FullsizeAbsolute)
	(paddingTop = "DOCK_HEADER_HEIGHT + SECONDARY_DOCK_TAB_HEIGHT")
)

(def css $DockInsetPageSecondaryTabOffset ()
	(paddingTop = "-SECONDARY_DOCK_TAB_HEIGHT")
)

(def css $DockInsetPageHeaderOffset ()
	(extends $FullsizeAbsolute)
	(paddingTop = "-(DOCK_HEADER_HEIGHT + SECONDARY_DOCK_TAB_HEIGHT)")
)

(def struct PULL_RENDER_PAGE_ITEM (_route:str, _map:dict = {})
	(var rootRouteEntity:dhEntity = "getPrimaryEntity(CC.route, SC.Ui_windows.WINDOWS.DOCK)")
	(var previousLeaf:str = "rootRouteEntity.rootRoute.previousLeaf" (event "rootRouteEntity.rootRoute.evActiveLeafChanged"))
	
	(var routeEntity:dhEntity = 		"getPrimaryEntity(CC.route, _route)")
	(var componentRoute:dhComponent =	"routeEntity.route")
	(var activeChild:str =				"componentRoute.activeChild" (event "componentRoute.evActiveChildChanged"))

	(var activeChildRoute:str = "activeChild" watch=false)
	(bind activeChildRoute "activeChild ?: activeChildRoute" init=false watch=false (event "rootRouteEntity.rootRoute.evActiveLeafChanged"))

	(var renderItem:str = "_map[activeChildRoute] ?: ''" watch=false)
	(bind renderItem "_map[activeChildRoute] ?: renderItem" init=false watch=false (bind trigger "activeChildRoute"))
)

(def element Dock ()
	(macro MODAL_WINDOW_INIT)
	(scope
		(event evDockInsetShow)
		(event evDockInsetHide)

		(var dockData:dhComponent = "getSingleComponent(CC.dockData)")

		(struct portRoute = PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.PORT"))
		(struct armoryRoute = PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.ARMORY"))
		(struct eventsRoute = PULL_FULL_ROUTE(_id = "SC.Ui_windows.ROUTE.EVENTS"))

		(var isActivePortRoute:bool = "portRoute.isActive && !armoryRoute.isActive && !(eventsRoute.isActive && eventsRoute.activeChild != SC.Ui_windows.ROUTE.EVENTS_PORT)")
	
		
		(var referralCollection:dhCollection = "getCollection(CC.referral)")
		(var isRefSysParticipant:bool = "referralCollection.length > 0")

		(var sessionPrefs:dhComponent = "getSingleComponent(CC.sessionPreference)")
		(var dockReady:bool = "sessionPrefs.dockReady" (event "sessionPrefs.evDockReadyChanged"))
	)
	(dispatch evDockInsetShow dir="EventDirection.NONE" (bind enabled "isActivePortRoute") (bind trigger "isActivePortRoute"))
	(dispatch evDockInsetHide dir="EventDirection.NONE" (bind enabled "!isActivePortRoute") (bind trigger "isActivePortRoute"))

	(bindcall externalCall "!dockReady ? 'inputMapping.onRequest' : ''" "['dockReady', {}]" watch=false on='addedToStage')

	(bindcall externalCall 'direct.action' "['setSessionPref', { prefName: 'dockReady', newValue: true }]"	on='addedToStage')
	(bindcall externalCall 'direct.action' "['setSessionPref', { prefName: 'dockReady', newValue: false }]"	on='removedFromStage')

	(bindcall externalCall "isRefSysParticipant ? 'inputMapping.onAction' : ''" "['ReferralProgramProxy.requestReferralPoints', {}]" on='addedToStage')

	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.BLACK")
			(alpha = 0)
			(hitTest = false)
		)

		(controller $Animation
			(controllerEvents evSpaceHided)
			(bindcall externalCall "'inputMapping.onAction'" "['onHideSpace', {}]" on='evSpaceHided')

			(bindcall play
				duration = 0.15
				to = "{ alpha: 1 }"
				action = "kill"
				onEndedEvent = 'evSpaceHided'
				(event "dockData.evHideSpace")
			)

			(bindcall play
				duration = 0.15
				to = "{ alpha: 0 }"
				action = "kill"
				(event "dockData.evShowSpace")
			)
		)
	)

	(element DeclareBlurLayer)

	(block
		(visible = "isActivePortRoute")
		(alpha = "isActivePortRoute ? 1 : 0")

		(class $FullsizeAbsolute)

		(controller $Animation
			(bindcall play
				delay = 0.1
				duration = 0.3
				to = "isActivePortRoute ? { alpha: 1, visible: true } : { alpha: 0, visible: false }"
				easing = "Easing.quad_out"
				action = "kill"
				watch = false
				(bind trigger "isActivePortRoute")
			)
		)

		(element MainDockInset)
	)

	(block
		(class $FullsizeAbsolute)

		(element ArmorTooltipHub)
	)
)

(def element MainDockInset ()
	(scope
		(struct portInsetData = PULL_RENDER_PAGE_ITEM( _route = "SC.Ui_windows.ROUTE.PORT" _map = "PORT_MAIN_INSETS"))
		
		(struct carouselAreaHeightPref = GET_PREF_NUMBER(_option = "'ui.carousel.carouselAreaHeight'"))

		(var windowManager:dhComponent = "getSingleComponent(CC.windowManager)")
		(var topWindowNodeName:str = "windowManager.topWindowNodeName ?: ''" (event "windowManager.evTopWindowNodeNameChanged"))
		(var isDockHeaderHidden:bool = "isIn(topWindowNodeName, SC.Ui_windows.MODAL.DOCK_HEADER_HIDDEN)")
	)
	(class $Fullsize)
	(macro HIDE_UI_ON_SHIPOVERVIEW)
	(bind name "portInsetData.renderItem")

	(block
		(class $DockInsetPageContent)

		(controller $Instance
			(bind renderer "portInsetData.renderItem")
			(args
				_previousRoute = "portInsetData.previousLeaf"
			)
			(reuseElement = true)
		)
	)

	(element DeclareBlurLayer)

	(block
		(style (width = 100%))

		(macro CONTROL_VISIBLE_STATE_ANIMATION
			_isTrigger = "!isDockHeaderHidden"
		)

		(element DockNavigationPanel)
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(align = "center|bottom")
			(bind paddingBottom "carouselAreaHeightPref.value")
		)

		(element InformerLogContainer)
	)
)

(def element ClanMainInset ()
	(bindcall externalCall 'sound.playSetSoundDirect' "['dock_inset', 'clan']" on='addedToStage')
	(class $Fullsize)
)

(def element ActivitiesMainInset ()
	(scope
		(struct activitiesInsetData = PULL_RENDER_PAGE_ITEM( _route = "SC.Ui_windows.ROUTE.ACTIVITIES" _map = "ACTIVITIES_INSET_PAGES"))
	)
	(bind name "activitiesInsetData.renderItem")
	(class $Fullsize)

	(controller $Instance
		(bind renderer "activitiesInsetData.renderItem")
		(args
			_previousRoute = "activitiesInsetData.previousLeaf"
		)
		(reuseElement = true)
	)
)

(def element ShipMainInset ()
	(scope
		(struct shipInsetData = PULL_RENDER_PAGE_ITEM( _route = "SC.Ui_windows.ROUTE.SHIP" _map = "SHIP_INSET_PAGES"))
	)
	(bind name "shipInsetData.renderItem")
	(class $Fullsize)

	(controller $Instance
		(bind renderer "shipInsetData.renderItem")
		(args
			_previousRoute = "shipInsetData.previousLeaf"
		)
		(reuseElement = true)
	)
)
