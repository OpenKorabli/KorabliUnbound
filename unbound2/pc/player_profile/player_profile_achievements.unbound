(def element PlayerProfileAchievementsPage ()
	(scope
		(event ItemChooser_achievementsSortSelected)
		(macro USER_PREF_DATA)
		(macro STAGE_SIZE)

		(var selectedSortingType:number = "userPrefs.achievementsSortOrder ?: 0")

		(var containerWidth:number = "	stageWidth > 1550	? 1056 :
										stageWidth > 1200	? 944
															: 872")
		
	)

	(name = 'PlayerProfileAchievements')
	(class $Fullsize)
	(style
		(align = "center")
		(paddingLeft = "{ 1280:100px, 1920:0px }")
		(paddingRight = 40px)
	)

	(bindcall externalCall "'inputMapping.onAction'" "['setUserPref', { name: 'achievementsSortOrder', value: $event.selectedIndex }]" init=false watch=false (event "ItemChooser_achievementsSortSelected"))

	(block
		(style
			(bind width "containerWidth") 
			(height = 100%) 
			(paddingTop = "{ 720:MS, 1080:LS }")
			(paddingBottom = "LM")
		)

		(block
			(macro DEFAULT_CACHED_SHOW_ANIMATION 1)
			(style
				(width = 100%)
				(align = "right")
				(marginBottom = "MS")
			)

			(element ItemChooser
				_items = "['IDS_SORT_BY_DEFAULT',  'IDS_SORT_BY_DATE', 'IDS_SORT_BY_AMOUNT']"
				_choosedItemRenderer = 'DefaultItemChooserPickedItemRenderer'
				_listItemRenderer = 'TextListItemRenderer'
				_curIndex = "selectedSortingType"
				_onItemSelectedEvent = 'achievementsSortSelected'
				_itemChooserTooltipUnifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
				_itemChooserTooltipText = 'IDS_HINT_ACHIEVEMENTS_SORT'
				_dropDownWidth = 180
			)
		)

		(block
			(macro DEFAULT_CACHED_SHOW_ANIMATION 2)
			(class $Fullsize)

			(scrollArea
				(class $Fullsize)
				(style (backgroundColor = "NO_COLOR"))

				(macro DEFAULT_VERTICAL_SCROLL_PARAMS
					_singleStep = "150"
					_wheelScrollAcceleration = "0.8"
				)

				(content
					(style
						(width = 100%)
						(vgap = "S")
					)

					(controller $Repeat renderer='AchievementGroup'
						(count = "SC.Achievements_classifications.ACHIEVEMENT_GROUP.SORT_ORDER.length")
					)
				)
				(bindcall scrollToDirection horDir="ScrollDirection.LEFT" vertDir="ScrollDirection.TOP"	animated="false" on='addedToStage')
			)
		)
	)
)


(def element AchievementGroup ()
	(scope
		(event evGroupClick)
		(macro MOUSE_HANDLER_SCOPE "'btn_'")
		(var selectedGroup:str = "SC.Achievements_classifications.ACHIEVEMENT_GROUP.SORT_ORDER[$index]")
		(var groupCollectionString:str = "'all_achievements.' + selectedGroup")
		(var achievementGroupName:str = "toUpper(selectedGroup) + '_ACHIEVEMENT'")

		(var achievementCollection:gfx = "$datahub.getCollection(CC.achievement)")
		(var groupCollection:gfx = "achievementCollection.getChildByPath(groupCollectionString)")
		(var groupArray:array = "groupCollection.items" (event "groupCollection.evAdded"))

		(var userPrefsComponent:gfx = "$datahub.getSingleComponent(CC.userPrefs)")
		(var userPrefs:dict = "userPrefsComponent.userPrefs" (event "userPrefsComponent.evUserPrefsChanged"))
		(var isExpanded:bool = "userPrefs['achievementsGroupExpand'][achievementGroupName]" (event "userPrefsComponent.evUserPrefsChanged"))

		(var subGroupSortOrder:array = "SC.Achievements_classifications[achievementGroupName].SUBGROUP_SORT_ORDER")

		(var newMarkerEntity:gfx = "$datahub.getPrimaryEntity(CC.newContent,  SC.Common.CONTENT_CATEGORY[achievementGroupName])")
		(var newContentCounter:number = "newMarkerEntity ? newMarkerEntity.newContent.count : 0" (event "newMarkerEntity.newContent.evCountChanged"))
		(var showMarkerCounter:bool = "newContentCounter > 0 && !isExpanded")
	)

	(bind visible "!groupArray.empty")
	(bind name "selectedGroup + '_achievements'")
	(style
		(marginBottom = "XS")
		(width = 100%)
		(backgroundColor = "NO_COLOR")
	)

	(bindcall externalCall 'inputMapping.onAction' "['setUserPref', {name: 'achievementsGroupExpand', subName: achievementGroupName, value: !isExpanded}]" init=false watch=false (event "evGroupClick"))

	(block
		(style
			(width = 100%)
			(backgroundColor = "NO_COLOR")
			(marginBottom = "XS")
		)

		(hblock
			(style
				(height = "LS")
				(align = "middle")
				(marginLeft = 13px)
			)

			(block
				(style (marginRight = 18px))

				(element ButtonExpand
					_isInOverState = "btn_rollOver && !btn_mouseDown"
					_isInDownState = "btn_rollOver && btn_mouseDown"
					_expanded = "isExpanded"
				)
			)

			(tf
				(class $TextDefaultBold28NM)
				(style (alpha = "TA"))
				(bind text "'IDS_ACHIEVEMENT_GROUP_' + toUpper(selectedGroup)")
			)

			(block
				(macro DEFAULT_CONTROL_MARKER_ANIMATION "showMarkerCounter")
				(style
					(position = "absolute")
					(right = -7px)
				)

				(element MarkerNew
					_newContentCounter = "newContentCounter"
				)
			)
		)

		(macro MOUSE_HANDLER
			_prefix = "'btn_'"
			_dispatchedEv = "'evGroupClick'"
			_soundSet = "'dropdown'"
		)
	)

	(element HorizontalDividerTwoPx)

	(block
		(style
			(width = "100%")
			(marginLeft = 44px)
			(alpha = "isExpanded ? 1 : 0")
			(ubScaleY = "isExpanded ? 1 : 0")
		)
		(visible = "isExpanded")

		(block
			(class $FullsizeAbsolute)
			(isMask = true)
			(style (backgroundColor = 0xFFFFFFFF))
		)

		(controller $Animation
			(bindcall play to="{ubScaleY:0}" duration=0.5 easing="Easing.quint_out" action="kill" (bind enabled "!isExpanded"))
			(bindcall play to="{ubScaleY:1}" duration=0.5 easing="Easing.quint_out" action="kill" (bind enabled "isExpanded"))
		)

		(controller $Animation
			(bindcall play to="{alpha:0, visible:false}" delay=0.1 duration=0.3 easing="Easing.quint_out" action="kill" (bind enabled "!isExpanded"))
			(bindcall play to="{alpha:1, visible:true}" duration=0.3 easing="Easing.quint_out" action="kill" (bind enabled "isExpanded"))
		)

		(block
			(style
				(width = 100%)
				(marginTop = "-S")
			)

			(controller $Repeat renderer='AchievementSubgroup'
				(bind count "subGroupSortOrder.length")
				(args
					_groupName = "selectedGroup"
					_subGroupSortOrder = "subGroupSortOrder"
				)
			)
		)
	)
)


(def element AchievementSubgroup (_groupName:str, _subGroupSortOrder:array)
	(scope
		(var userPrefsComponent:gfx = "$datahub.getSingleComponent(CC.userPrefs)")
		(var userPrefs:dict = "userPrefsComponent.userPrefs" (event "userPrefsComponent.evUserPrefsChanged"))
		(var selectedSortingType:number = "userPrefs['achievementsSortOrder'] ? userPrefs['achievementsSortOrder'] : 0" (event "userPrefsComponent.evUserPrefsChanged"))

		(var sortOrder:str = "	selectedSortingType == 0	? '.byDefault' :
								selectedSortingType == 1	? '.byTime'
															: '.byAmount'")

		(var selectedSubGroup:str = "_subGroupSortOrder[$index]")
		(var subgroupName:str = "toUpper(_groupName + '_' + selectedSubGroup)")

		(var achievementCollection:dhCollection = "getCollectionByPath(CC.achievement, 'all_achievements.' + _groupName + '.bySubgroup.' + selectedSubGroup + sortOrder)")
	)

	(bind visible "achievementCollection.length > 0")
	(bind name "'group_' + _groupName + '_subgroup_' + selectedSubGroup")

	(style
		(width = 100%)
		(marginTop = "LM")
	)

	(tf
		(class $TextDefaultBold24NM)
		(style
			(marginBottom = "L")
			(alpha = "TA")
		)
		(bind text "'IDS_ACHIEVEMENT_SUBGROUP_' + subgroupName")
	)

	(htile
		(style
			(width = 100%)
			(marginBottom = "M")
			(gap = "L")
		)

		(controller $DynamicRepeat renderer='AchievementListItem'
			(bind items "achievementCollection")
			(args
				_achievementEntity = "$item"
			)

			(itemWidth = 80px)
			(itemHeight = 80px)
			(itemOffset = 160px)
			(sharedCache = true)
		)
	)
)

(def element AchievementListItem (_achievementEntity:dhEntity)
	(scope
		(var amount:number = "_achievementEntity.achievement.amount ?: 0" (event "_achievementEntity.achievement.evChanged"))
	)
	(element AchievementIcon
		_id = "_achievementEntity.achievement.id"
		_progressWidth = 50
		_amount = "amount"
		_isDesaturated = "amount == 0"
		_showProgress = true
		_showMarkerNew = true
	)
)