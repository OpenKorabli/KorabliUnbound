(def constant EMOJI_TOOLTIP_WIDTH 384px)
(def constant EMOJI_SIZE {
	SMALL	: 28px,
	MEDIUM	: 52px,
})

(def constant EMOJI_ICON_SIZE {
	SMALL	: 24px,
	MEDIUM	: 48px,
})

(def constant EVALUATION_TYPES {
	DENUNCIATION: 0,
	PRAISE		: 1,
})

(def constant EMOJI_STATES {
	DEFAULT	: 0,
	ACTIVE	: 1,
	SELECTED: 2,
	APPLIED	: 3,
})

(def constant EMOJI_BACKGROUND_ALPHA_STATES {
	"EMOJI_STATES.DEFAULT": {
		SC.Ui_styles.BUTTON_STATE.UP	: 0,
		SC.Ui_styles.BUTTON_STATE.OVER	: 0.1,
		SC.Ui_styles.BUTTON_STATE.DOWN	: 0.05,
	},
	"EMOJI_STATES.ACTIVE": {
		SC.Ui_styles.BUTTON_STATE.UP	: 0.2,
		SC.Ui_styles.BUTTON_STATE.OVER	: 0.45,
		SC.Ui_styles.BUTTON_STATE.DOWN	: 0.35,
	},
	"EMOJI_STATES.APPLIED": {
		SC.Ui_styles.BUTTON_STATE.UP	: 0,
		SC.Ui_styles.BUTTON_STATE.OVER	: 0.1,
		SC.Ui_styles.BUTTON_STATE.DOWN	: 0.05,
	},
	"EMOJI_STATES.SELECTED": {
		SC.Ui_styles.BUTTON_STATE.UP	: 0.1,
		SC.Ui_styles.BUTTON_STATE.OVER	: 0.2,
		SC.Ui_styles.BUTTON_STATE.DOWN	: 0.15,
	},
})

(def constant EMOJI_ICON_ALPHA_STATES {
	"EMOJI_STATES.DEFAULT": {
		SC.Ui_styles.BUTTON_STATE.UP	: 0.5,
		SC.Ui_styles.BUTTON_STATE.OVER	: 1,
		SC.Ui_styles.BUTTON_STATE.DOWN	: 1,
	},
	"EMOJI_STATES.ACTIVE": {
		SC.Ui_styles.BUTTON_STATE.UP	: 1,
		SC.Ui_styles.BUTTON_STATE.OVER	: 1,
		SC.Ui_styles.BUTTON_STATE.DOWN	: 1,
	},
	"EMOJI_STATES.APPLIED": {
		SC.Ui_styles.BUTTON_STATE.UP	: 1,
		SC.Ui_styles.BUTTON_STATE.OVER	: 1,
		SC.Ui_styles.BUTTON_STATE.DOWN	: 1,
	},
	"EMOJI_STATES.SELECTED": {
		SC.Ui_styles.BUTTON_STATE.UP	: 1,
		SC.Ui_styles.BUTTON_STATE.OVER	: 1,
		SC.Ui_styles.BUTTON_STATE.DOWN	: 1,
	},
})


(def element EmojiSelector (_ownerId:number,
							_evaluationLimits:number,
							_reactionsDisabledReason:str,
							_emojiByOwnerIdCollection:dhCollection)
	(scope
		(event evEmojiSelected)
		(event evBattleStatsHidden)

		(var firstEmojiComponent:dhComponent = "_emojiByOwnerIdCollection.getEntityAtIndex(0).emoji")
		(var isAppliedByMe:bool = "firstEmojiComponent.isAppliedByMe" (event "firstEmojiComponent.evIsAppliedByMeChanged"))

		(var isActive:bool = false)
		(var hasDisabledReason:bool = "toBool(_reactionsDisabledReason)")

		(struct mouseHandler = MOUSE_HANDLER())
		(var mouseState:number = "	mouseHandler.mouseDown && !hasDisabledReason 	? SC.Ui_styles.BUTTON_STATE.DOWN :
									mouseHandler.rollOver && !hasDisabledReason 	? SC.Ui_styles.BUTTON_STATE.OVER
																					: SC.Ui_styles.BUTTON_STATE.UP"
		)
		(var selectorState:number = "	isActive 			? EMOJI_STATES.ACTIVE :
										isAppliedByMe 		? EMOJI_STATES.SELECTED :
										firstEmojiComponent ? EMOJI_STATES.APPLIED
															: EMOJI_STATES.DEFAULT"
		)
	)

	(macro STRUCT_MOUSE_DISPATCHER
		_mouseHandler = "mouseHandler"
	)

	(style
		(width = "EMOJI_SIZE.SMALL")
		(height = "EMOJI_SIZE.SMALL")
	)

	
	(block
		(class $FullsizeAbsolute)
		(style (padding = "-XXS"))

		(block
			(class $Fullsize)
			(style (backgroundColor = "NO_COLOR"))
		)
	)

	
	(block
		(class $FullsizeAbsolute)
		(style
			(borderRadius = "XS")
			(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.WHITE")

			(alpha = "EMOJI_BACKGROUND_ALPHA_STATES[selectorState][mouseState]")
		)

		(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA
			_trigger = "[selectorState, mouseState]"
			_alpha	 = "EMOJI_BACKGROUND_ALPHA_STATES[selectorState][mouseState]"
		)
	)

	
	(block
		(class $FullsizeAbsolute)
		(style (align = "center|middle"))

		(block
			(style
				(alpha = "EMOJI_ICON_ALPHA_STATES[selectorState][mouseState]")
				(backgroundSize = "fill")

				(bind width "firstEmojiComponent ? EMOJI_ICON_SIZE.SMALL : 21px")
				(bind height "firstEmojiComponent ? EMOJI_ICON_SIZE.SMALL : 21px")
				(bind backgroundImage "firstEmojiComponent ? firstEmojiComponent.imagePath : 'swf:../service_kit/battle_results_svg/battle_results_svg.swf:icon_emoji'")
			)

			(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA
				_trigger = "[selectorState, mouseState]"
				_alpha	 = "EMOJI_ICON_ALPHA_STATES[selectorState][mouseState]"
			)
		)
	)

	(controller $Tooltip
		(renderer = 'EmojiStatusTooltip')
		(args
			_emojiByOwnerIdCollection 	= "_emojiByOwnerIdCollection"
			_reactionsDisabledReason 	= "_reactionsDisabledReason"
			_isAppliedByMe 				= "isAppliedByMe"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)

	(controller $Tooltip
		(renderer = 'EmojiSelectorInfotip')
		(bind enabled "!hasDisabledReason")
		(args
			_ownerId 		= "_ownerId"
			_reactionsLeft 	= "_evaluationLimits"
			_isAppliedByMe 	= "isAppliedByMe"
		)
		(macro DEFAULT_INFOTIP_BEHAVIOUR "1")
		(offset = {x: "S", y: "-MS"})

		(bind isActive "true" init=false on='evStartShow')
		(bind isActive "false" init=false on='evStartHide')
		(macro TOOLTIP_HIDE_ON_EVENT "evEmojiSelected")
		(macro TOOLTIP_HIDE_ON_EVENT "evBattleStatsHidden")
	)
)

(def element EmojiStatusTooltip (	_emojiByOwnerIdCollection:dhCollection,
									_reactionsDisabledReason:str,
									_isAppliedByMe:bool,
									_isSelfStatus:bool = false)
	(scope
		(var emojiCollectionByOwnerIdLength:number = "_emojiByOwnerIdCollection.length ?: 0")

		(var hasDisabledReason:bool = "toBool(_reactionsDisabledReason)")
	)

	(style (maxWidth = "EMOJI_TOOLTIP_WIDTH"))
	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND)

	(element TOOLTIP_SYSTEM_DEFAULT_CONTAINER _width=auto
		(htile
			(bind visible "emojiCollectionByOwnerIdLength != 0")

			(style
				(maxWidth = "EMOJI_TOOLTIP_WIDTH")
				(minWidth = 100%)
				(gap = "S")
			)
			(macro TOOLTIP_SYSTEM_INNER_PANEL_BACKGROUND)

			(controller $Repeat renderer='EmojiViewItem'
				(bind count "emojiCollectionByOwnerIdLength")
				(args
					_emojiComponent = "_emojiByOwnerIdCollection.getEntityAtIndex($index).emoji"
				)
			)
		)

		(block
			(style (width = 100%))

			(controller $Instance renderer='TooltipSystemHorizontalDivider'
				(bind enabled "emojiCollectionByOwnerIdLength != 0 && !_isSelfStatus")
			)
		)

		(block
			(controller $Instance renderer='StatusLine'
				(bind enabled "!_isSelfStatus")
				(args
					_text 			= "hasDisabledReason ? _reactionsDisabledReason : 'IDS_HINT_CHOOSE_EMOJI'"
					_unifiedStatus 	= "hasDisabledReason ? SC.Ui_styles.UNIFIED_STATUS.ATTENTION : SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
					_maxWidth 		= "EMOJI_TOOLTIP_WIDTH"
				)
			)
		)
	)
)

(def element EmojiSelectorInfotip (	_ownerId:number,
									_reactionsLeft:number,
									_isAppliedByMe:bool)
	(scope
		(event evEmojiSelected)

		(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_SCOPE)

		(var defaultPositiveEmojis:dhCollection = "getCollectionByPath(CC.ownedEmoji, 'byEvaluationType.' + EVALUATION_TYPES.PRAISE)")
		(var defaultNegativeEmojis:dhCollection = "getCollectionByPath(CC.ownedEmoji, 'byEvaluationType.' + EVALUATION_TYPES.DENUNCIATION)")

		(var frozenOwnerId:number = "_ownerId" watch=false)

		(var isApplyEnabled:bool = true)  
		(bind isApplyEnabled "false" init=false (event "evEmojiSelected"))
	)

	(style (maxWidth = "EMOJI_TOOLTIP_WIDTH"))

	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_MARKUP _isInfotip="true")

	(element TOOLTIP_SYSTEM_DEFAULT_CONTAINER _width=auto
		(element TooltipSystemHeaderSubheaderText
			_headerText = 'IDS_EMOJI_REACTIONS'
		)

		(element TooltipSystemHorizontalDivider)

		
		(htile
			(style
				(maxWidth = "EMOJI_TOOLTIP_WIDTH")
				(minWidth = 100%)
				(gap = "S")
			)
			(macro TOOLTIP_SYSTEM_INNER_PANEL_BACKGROUND)

			(controller $Repeat renderer='EmojiApplyItem'
				(bind count "defaultPositiveEmojis.length")
				(args
					_ownerId 				= "frozenOwnerId"
					_ownedEmojiComponent 	= "defaultPositiveEmojis.getEntityAtIndex($index).ownedEmoji"
					_isAppliedByMe 			= "_isAppliedByMe"
					_isApplyEnabled 		= "isApplyEnabled"
				)
			)
		)

		(element TooltipSystemHorizontalDivider)

		(element TooltipSystemHeaderSubheaderText
			_headerText = 'IDS_EMOJI_COMPLAIN'
		)

		(element TooltipSystemHorizontalDivider)

		
		(htile
			(style
				(maxWidth = "EMOJI_TOOLTIP_WIDTH")
				(minWidth = 100%)
				(gap = "S")
			)
			(macro TOOLTIP_SYSTEM_INNER_PANEL_BACKGROUND)

			(controller $Repeat renderer='EmojiApplyItem'
				(bind count "defaultNegativeEmojis.length")
				(args
					_ownerId 				= "frozenOwnerId"
					_ownedEmojiComponent 	= "defaultNegativeEmojis.getEntityAtIndex($index).ownedEmoji"
					_isAppliedByMe 			= "_isAppliedByMe"
					_isApplyEnabled 		= "isApplyEnabled"
				)
			)
		)

		
		

		
		
		
	)
)

(def element EmojiApplyItem (	_ownerId:number,
								_ownedEmojiComponent:dhComponent,
								_isAppliedByMe:bool,
								_isApplyEnabled:bool = true)
	(scope
		(event evEmojiSelected)

		(var emojiPackId:number = "_ownedEmojiComponent.emojiPackId")
		(var emojiName:str = "_ownedEmojiComponent.emojiName")

		(var appliedEmojiComponent:dhComponent = "getPrimaryComponent(CC.emoji, emojiPackId + '_' + emojiName + '_' + _ownerId)")
		(var isCurrentAppliedByMe:bool = "appliedEmojiComponent.isAppliedByMe" (event "appliedEmojiComponent.evIsAppliedByMeChanged"))

		(struct mouseHandler = MOUSE_HANDLER())
		(var mouseState:number = "	mouseHandler.mouseDown 	? SC.Ui_styles.BUTTON_STATE.DOWN :
									mouseHandler.rollOver 	? SC.Ui_styles.BUTTON_STATE.OVER
															: SC.Ui_styles.BUTTON_STATE.UP"
		)
		(var selectorState:number = "isCurrentAppliedByMe ? EMOJI_STATES.SELECTED : EMOJI_STATES.APPLIED")

		
		(var actionName:str = "	!isCurrentAppliedByMe && _isAppliedByMe ? 'action.changeEmoji' :
								isCurrentAppliedByMe 					? 'action.removeEmoji'
																		: 'action.applyEmoji'"
		)
	)

	(macro STRUCT_MOUSE_DISPATCHER
		_mouseHandler = "mouseHandler"
	)

	(dispatch evEmojiSelected args="{emojiName: emojiName}" dir="EventDirection.UP" on='leftClick' (bind enabled "_isApplyEnabled"))
	(bindcall externalCall 'direct.action' "[actionName, 	{
																ownerAccountId: _ownerId,
																emojiPackId: emojiPackId,
																emojiName: emojiName
															}
											]"
											watch = false
											(event "evEmojiSelected"))

	(style
		(align = "middle|center")
		(width = "EMOJI_SIZE.MEDIUM")
		(height = "EMOJI_SIZE.MEDIUM")
	)

	
	(block
		(class $FullsizeAbsolute)
		(style
			(borderRadius = "XS")
			(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.WHITE")

			(alpha = "EMOJI_BACKGROUND_ALPHA_STATES[selectorState][mouseState]")
		)

		(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA
			_trigger = "[selectorState, mouseState]"
			_alpha	 = "EMOJI_BACKGROUND_ALPHA_STATES[selectorState][mouseState]"
		)
	)

	
	(block
		(class $FullsizeAbsolute)
		(style (padding = "-XS"))

		(block
			(class $Fullsize)
			(style (backgroundColor = "NO_COLOR"))
		)
	)

	
	(block
		(style
			(width = "EMOJI_ICON_SIZE.MEDIUM")
			(height = "EMOJI_ICON_SIZE.MEDIUM")
			(backgroundSize = "fill")

			(bind backgroundImage "_ownedEmojiComponent.imagePath")
		)
	)

	(controller $Tooltip
		(renderer = 'SimpleStatusTooltip')
		(bind enabled "toBool(_ownedEmojiComponent.tooltipHintText)")
		(args
			_text = "_ownedEmojiComponent.tooltipHintText"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)

(def element EmojiViewItem (_emojiComponent:dhComponent)
	(scope
		(var emojiSenderIds:array = "_emojiComponent.senderIds" (event "_emojiComponent.evSenderIdsChanged"))

		(var appliedEmojiComponent:dhComponent = "getPrimaryComponent(CC.emoji, _emojiComponent.emojiPackId + '_' + _emojiComponent.emojiName + '_' + _emojiComponent.ownerId)")
		(var isCurrentAppliedByMe:bool = "appliedEmojiComponent.isAppliedByMe" (event "appliedEmojiComponent.evIsAppliedByMeChanged"))
	)

	(style
		(align = "middle|center")
		(width = "EMOJI_SIZE.MEDIUM")
		(height = "EMOJI_SIZE.MEDIUM")
	)

	
	(block
		(class $FullsizeAbsolute)
		(style
			(borderRadius = "XS")
			(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.WHITE")

			(bind alpha "isCurrentAppliedByMe ? 0.1 : 0")
		)
	)

	
	(block
		(style
			(width = "EMOJI_ICON_SIZE.MEDIUM")
			(height = "EMOJI_ICON_SIZE.MEDIUM")
			(backgroundSize = "fill")

			(bind backgroundImage "_emojiComponent.imagePath")
		)
	)

	
	(tf
		(bind visible "emojiSenderIds.length > 1")

		(class $TextDefaultBold18NM)
		(style
			(position = "absolute")
			(top = 1px)
			(right = 1px)
			(alpha = "TA")
		)
		(bind text "emojiSenderIds.length")
	)
)

(def element EmojiSelfSummaryItem (_emojiByOwnerIdCollection:dhCollection)
	(scope
		(var firstEmojiComponent:dhComponent = "_emojiByOwnerIdCollection.getEntityAtIndex(0).emoji")
	)

	(style
		(width = "EMOJI_SIZE.SMALL")
		(height = "EMOJI_SIZE.SMALL")
	)

	
	(block
		(class $FullsizeAbsolute)
		(style (padding = "-XXS"))

		(block
			(class $Fullsize)
			(style (backgroundColor = "NO_COLOR"))
		)
	)

	
	(block
		(class $Fullsize)
		(style (align = "center|middle"))

		(block
			(style
				(width = "EMOJI_ICON_SIZE.SMALL")
				(height = "EMOJI_ICON_SIZE.SMALL")
				(backgroundSize = "fill")

				(bind backgroundImage "firstEmojiComponent ? firstEmojiComponent.imagePath : ''")
			)
		)
	)

	(controller $Tooltip
		(renderer = 'EmojiStatusTooltip')
		(args
			_emojiByOwnerIdCollection 	= "_emojiByOwnerIdCollection"
			_reactionsDisabledReason 	= ''
			_isAppliedByMe 				= false
			_isSelfStatus 				= true
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)

(def element PBSEmojiSelfOwnedContainerItem (	_emojiComponent:dhComponent,
												_animationDelay:number = 0,
												_isAppearAnimationEnabled:bool = true)
	(macro DEFAULT_MODAL_WINDOW_SCOPE_EVENTS)
	(scope
		(var emojiSenderIds:array = "_emojiComponent.senderIds" (event "_emojiComponent.evSenderIdsChanged"))
	)

	(style
		(width = "EMOJI_SIZE.SMALL")
		(height = "EMOJI_SIZE.SMALL")
		(backgroundColor = "NO_COLOR")
	)

	(macro PBS_ELEMENTS_ANIMATION
		_isEnabled 	= "_isAppearAnimationEnabled"
		_delay 		= "$index * 0.1 + _animationDelay"
	)

	
	(block
		(class $Fullsize)
		(style (align = "center|middle"))

		(block
			(style
				(width = "EMOJI_ICON_SIZE.SMALL")
				(height = "EMOJI_ICON_SIZE.SMALL")
				(backgroundSize = "fill")

				(bind backgroundImage "_emojiComponent.imagePath")
			)
		)
	)

	
	(tf
		(bind visible "emojiSenderIds.length > 1")

		(class $TextDefaultBold14NM)
		(style
			(hitTest = false)
			(position = "absolute")
			(top = 1px)
			(right = 1px)
			(alpha = "TA")
		)
		(bind text "emojiSenderIds.length")
	)

	(controller $Tooltip
		(renderer = 'EmojiSendersInfoTooltip')
		(args
			_senderIds = "emojiSenderIds"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)

(def element EmojiSendersInfoTooltip (_senderIds:array)
	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND)

	(element TOOLTIP_SYSTEM_DEFAULT_CONTAINER _width=auto
		(block
			(style (vgap = "S"))

			(controller $Repeat renderer='StatusLine'
				(bind count "_senderIds.length")
				(args
					_text 	= "getPrimaryEntity(CC.accountSimple, _senderIds[$index]).accountName.nickName"
					_width 	= auto
				)
			)
		)
	)
)
