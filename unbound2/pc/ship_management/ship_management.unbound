(def constant SHIP_MANAGEMENT_ITEM_HGAP "{ 1280:SXS, 1920:M }")

(def constant MANAGEMENT_BASE_SLOT_ITEM_SIZE 64px)

(def css $ManagementBaseSlotItem ()
	(width = "MANAGEMENT_BASE_SLOT_ITEM_SIZE")
	(height = "MANAGEMENT_BASE_SLOT_ITEM_SIZE")
)

(def css $ShipManagementSectionContainer ()
	(padding = "M")
)

(def css $ShipManagementSectionHeader ()
	(extends $TextDefaultBold20NM)
	(alpha = "TA")
	(marginBottom = "M")
)

(def macro MODULES_ALPHA_STATE (_isAvailable:expression=false)
	(bind alpha	"_isAvailable ? 0.7 : 0.3")
)

(def struct SHIP_MANAGEMENT_TOOLTIP_POSITION ()
	(struct stageSize = STAGE_SIZE())
	(var align:number = "stageSize.height > 1000 ? top|center : left|middle")
)

(def element ShipManagementMainInset ()
	(scope
		(struct highContrast = HIGH_CONTRAST_INFO())

		(event evShipManagementInsetLostTop)
		(macro PULL_SHIP_ID)
		(struct carouselAreaHeightPref = GET_PREF_NUMBER(_option = "'ui.carousel.carouselAreaHeight'"))

		(struct userPrefsData = USER_PREF_DATA())
		(var previewModuleId:number = "userPrefsData.prefs.previewModuleId")

		(macro PULL_CURRENT_TOP_WINDOW_NAME)
		(var isOnTop:bool = "currentTopWindowName == 'Dock'")


		(struct armoryRoute = PULL_FULL_ROUTE(_id = "SC.Ui_windows.ROUTE.OVERVIEW"))
		(struct upgradesRoute = PULL_FULL_ROUTE(_id = "SC.Ui_windows.ROUTE.UPGRADES"))

		(var renderManagementPage:str = "	armoryRoute.isActive	?	'ArmoryManagementInset' :
											upgradesRoute.isActive	?	'UpgradesManagementInset'
																	:	''")

	)
	
	
	(bindcall externalCall 'inputMapping.onAction' "['setCompareData', { moduleId: previewModuleId ? previewModuleId : null }]" watch=false (bind trigger "previewModuleId"))

	
	(dispatch evShipManagementInsetLostTop dir="EventDirection.NONE" (bind enabled "!isOnTop") (bind trigger "isOnTop"))
	(bindcall externalCall "previewModuleId ? 'inputMapping.onAction' : ''" "['setUserPref', {	name: 'previewModuleId',
																								value: 0 }]" watch=false	on='removedFromStage'
																															(bind trigger "viewedShipId")
																															(event "evShipManagementInsetLostTop"))

	
	(class $Fullsize)
	(bindcall externalCall 'sound.playSetSoundDirect' "['dock_inset', upgradesRoute.isActive ? 'upgrades' : 'overview']" on='addedToStage')

	(macro DEFAULT_CACHED_SHOW_ANIMATION 1)

	(block
		(class $DockInsetPageHeaderOffset)
		(style (hitTest = false))
	
		(block
			(class $FullsizeAbsolute)

			(controller $Instance renderer='BlurMap'
				(bind enabled "!highContrast.isEnabled")
				(args
					_blurType = "BLUR_TYPE.SHIP_MANAGEMENT"
				)
			)
		)

		(block
			(class $FullsizeAbsolute)
			(style
				(backgroundImage = 'url:../bg/ship_management_bg.png')
				(backgroundSize = "cover")
			)
		)
	)

	(block
		(class $Fullsize)
		(style (bind paddingBottom "carouselAreaHeightPref.value"))

		(controller $Animation
			(bindcall play
				keyframes = "[
					{ time:0,	to:{ alpha:0, visualOffsetY: 10px, hitTest: false }},
					{ time:0.2,	to:{ alpha:0, visualOffsetY: 10px, hitTest: false }},
					{ time:0.3,	to:{ alpha:1, visualOffsetY: 0px, hitTest: true }, easing:Easing.sine_in_out}
				]"
				action = "kill"
				on = 'addedToStage'
				(bind trigger "viewedShipId")
			)
		)

		(block
			(class $FullsizeAbsolute)
			(style
				(paddingLeft = "{ 1280:M, 1920:LS }")
				(paddingTop = "{ 720:M, 1080:LS }")
			)

			(block	
				(block
					(bind visible "highContrast.isEnabled")
					(class $FullsizeAbsolute)
					(style
						(paddingLeft = "-SXS")
						(paddingTop = "-SXS")
						(paddingBottom = "-SXS")
						(paddingRight = "-LM")
					)

					(block
						(class $Fullsize)
						(style
							(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.CONTRAST_PANEL")
							(borderRadius = "XS")
						)
					)
				)

				(element ShipInfoWidget)
			)
		)

		(block
			(class $FullsizeAbsolute)
			(style (align = "bottom"))

			(controller $Animation
				(bindcall play
					keyframes = "[
						{ time:0,	to:{ alpha:0, visualOffsetY: 10px, hitTest: false }},
						{ time:0.2,	to:{ alpha:0, visualOffsetY: 10px, hitTest: false }},
						{ time:0.3,	to:{ alpha:1, visualOffsetY: 0px, hitTest: true }, easing:Easing.sine_in_out}
					]"
					action = "kill"
					(bind trigger "renderManagementPage")
				)
			)

			(controller $Instance
				(bind renderer "renderManagementPage")
				(reuseElement = true)
			)
		)
	)
)

(def element UpgradesManagementInset ()
	(scope
		
		(macro PULL_SHIP_ID)
		(var shipEntity:dhEntity = "getPrimaryEntity(CC.ship, viewedShipId)")
		(var shipInfo:dhComponent = "shipEntity.ship")

		(struct signalsFeature = FEATURES(_state = "SC.Common.ACCOUNT_FEATURE.EXT_SIGNALS"))
		(var playerShipsCollection:dhCollection = "getCollection(CC.ownShip)")
		(var isHideSignalsTag:bool = "(shipInfo.tagsMask & (1 << SC.Ships.SHIP_TAG.HIDE_SIGNALS)) != 0 && playerShipsCollection.length > 0 && viewedShipId > 0")

		(var isManagementSignalsVisible:bool = "!isHideSignalsTag && signalsFeature.state != 'locked'")
		

		
		(var modernizationsCollection:dhCollection = "getCollectionByPath(CC.equipmentSlot, 'bySlotType.' + SC.Ships.SHIP_SLOT_TYPES.MODERNIZATION)")

		(struct modernizationsFeature = FEATURES(_state = "SC.Common.ACCOUNT_FEATURE.MODERNIZATIONS"))
		(var isModernizationsVisible:bool = "modernizationsFeature.state != 'locked' && modernizationsCollection.length > 0")
		

		(struct signalsBlockedCantInstallTip =		PULL_GUIDING_TIP(_type = "SC.Context_guiding_tip.TIP_TYPE.BATTLE_BONUS_BLOCKED_CANT_INSTALL"))
		(struct modNotAvailableTip =				PULL_GUIDING_TIP(_type = "SC.Context_guiding_tip.TIP_TYPE.MODERNIZATION_NOT_AVAILABLE"))

		(var newTipId:number = "signalsBlockedCantInstallTip.isActive	? SC.Context_guiding_tip.TIP_TYPE.BATTLE_BONUS_BLOCKED_CANT_INSTALL :
								modNotAvailableTip.isActive				? SC.Context_guiding_tip.TIP_TYPE.MODERNIZATION_NOT_AVAILABLE
																		: SC.Context_guiding_tip.TIP_TYPE.NONE")
	)

	(style
		(width = 100%)
		(align = "center")
		(vgap = "M")
	)

	(block
		(bind visible "(shipInfo.tagsMask & (1 << SC.Ships.SHIP_TAG.HIDE_MODULES)) == 0")
		(element ModuleManagementWidget)
	)

	(hblock
		(style
			(flow = "horizontal")
			(hgap = "M")
		)
	
		(block
			(style (backgroundColor = "NO_COLOR"))
			(bindcall externalCall "modernizationsFeature.state == 'new' ? 'inputMapping.onAction' : ''" "['featureSeen', { featureIndex: SC.Common.ACCOUNT_FEATURE.MODERNIZATIONS }]" init=false watch=false on='rollOver')

			(controller $Instance renderer='ModernizationsManagementWidget'
				(bind enabled "isModernizationsVisible")
				(args
					_modernizationsCollection = "modernizationsCollection"
				)
			)

			(controller $Instance renderer='GuidingTipHub'
				(bind enabled "newTipId && modNotAvailableTip.isActive")
				(args
					_tipId =			"newTipId"
					_tipPositioning =	"TIP_POSITION_LEFT"
					_offsetX =			220
					_offsetY =			-80
					_noPointer =		true
					_hasFinishButton =	true
					_modalWindowName =	"SC.Ui_windows.WINDOWS.DOCK"
				)
			)
		)

		(block
			(controller $Instance renderer='SignalsManagementWidget'
				(bind enabled "isManagementSignalsVisible")
			)

			(controller $Instance renderer='GuidingTipHub'
				(bind enabled "newTipId && signalsBlockedCantInstallTip.isActive")
				(args
					_tipId =			"newTipId"
					_tipPositioning =	"TIP_POSITION_LEFT"
					_offsetX =			220
					_offsetY =			-80
					_noPointer =		true
					_modalWindowName =	"SC.Ui_windows.WINDOWS.DOCK"
				)
			)
		)
	)
)

(def element ArmoryManagementInset ()
	(style
		(width = 100%)
		(align = "center")
		(flow = "horizontal")
		(hgap = "M")
	)

	(element WeaponManagementWidget)
	
	(element ConsumablesManagementWidget)
)

(def element ModuleElementModalWindow (_modulePK:str, _maxWidth:number)
	(scope
		(var moduleEntity:dhEntity = "getPrimaryEntity(CC.module, _modulePK)")
		(var moduleInfo:dhComponent = "moduleEntity.module")
		(var moduleType:str = "moduleInfo.type" (event "moduleInfo.evUpdated"))

		(var isExplored:bool = "moduleInfo.isExplored" (event "moduleInfo.evUpdated"))

		(struct moduleExplorePrice =	PULL_PRICE(_entityId = "moduleInfo.id"	_actionId = "SC.Common.PRICE_ACTION.RESEARCH"))
		(struct moduleBuyPrice =		PULL_PRICE(_entityId = "moduleInfo.id"	_actionId = "SC.Common.PRICE_ACTION.BUY"))

		(var priceInfo:dict = "isExplored ? moduleBuyPrice.info : moduleExplorePrice.info")
		(var subheaderText:str = "moduleInfo.subTypeIDS != '' ? moduleInfo.subTypeIDS : 'IDS_MODULE_TYPE' + moduleInfo.type")
	)

	(element ModalWindowSystemExpendableIconWithHeaderAndSubheader
		_headerIconType =	"MODAL_WINDOW_SYSTEM_PURCHASABLE_ITEM_ICON.MODULE"
		_imageWidth =		60px
		_imageHeight =		60px
		_maxWidth =			"_maxWidth"
		_headerText =		"'IDS_'+ moduleInfo.name"
		_subheaderText =	"subheaderText"
		_unifiedStatus =	"SC.Ui_styles.UNIFIED_STATUS.DEFAULT"
		_data =				"{	moduleInfoType:	moduleInfo.type,
								isExplored:		isExplored }"
	)

	(block
		(class $FullsizeAbsolute)
		(style (backgroundColor = "NO_COLOR"))

		(controller $Tooltip
			(renderer = 'ModuleTooltip')
			(args
				_moduleEntity = "moduleEntity"
				_noMouseInstructions = true
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)

	(block
		(style
			(position = "absolute")
			(left = 45px)
			(top = "XS")
		)

		(controller $Instance renderer='DiscountTag'
			(bind enabled "priceInfo.finalPrice != priceInfo.basePrice")
			(args
				_size = "SIZE.LARGE"
				_priceInfo = "priceInfo"
			)
		)
	)
)