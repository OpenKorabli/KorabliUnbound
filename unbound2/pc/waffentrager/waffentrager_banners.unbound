(def constant WAFFENTRAGER_BOOSTERS "[
	SC.Common.ECOBOOST_MODIFIERS.CREDITS,
	SC.Common.ECOBOOST_MODIFIERS.CREW_EXP,
	SC.Common.ECOBOOST_MODIFIERS.FREE_EXP,
	SC.Common.ECOBOOST_MODIFIERS.WAFFENTRAGER_RELAY
]")

(def constant WAFFENTRAGER_BOOSTERS_ICONS "{
	SC.Common.ECOBOOST_MODIFIERS.CREDITS: SC.Common.CURRENCIES.CREDITS,
	SC.Common.ECOBOOST_MODIFIERS.CREW_EXP: SC.Common.CURRENCIES.CREW_XP,
	SC.Common.ECOBOOST_MODIFIERS.FREE_EXP: SC.Common.CURRENCIES.FREE_XP,
	SC.Common.ECOBOOST_MODIFIERS.WAFFENTRAGER_RELAY: SC.Common.CURRENCIES.WAFFENTRAGER_RELAY
}")

(def css $WTBannerContent ()
	(width = 100%)
	(paddingTop = "MS")
	(paddingBottom = "MS")
	(paddingLeft = 20px)
	(paddingRight = 20px)
)

(def css $WTBannerHorizontalLine ()
	(width = 100%)
	(marginTop = "M")
	(marginBottom = "SXS")
)

(def element WaffentragerMainInset ()
	(scope
		(macro CAROUSEL_HEIGHT_SCOPE)

		(macro PULL_SHIP_ID)
		(struct waffentrager = PULL_WAFFENTRAGER_SHIP(_playerShipId="playerShipId"))

		(var waffentragerEvent:dhComponent = "getSingleComponent(CC.waffentragerEvent)")
		(struct waffentragerState = PULL_WAFFENTRAGER_EVENT_STATE(_component = "waffentragerEvent"))
	)
	(style
		(width = "EVENT_BANNER_WIDTH.LARGE + 10px")
		(height = 100%)
		(marginLeft = "{ 1280: SXS, 1920: L }")
		(paddingTop = "{ 720: SXS, 900: L }")
		(bind paddingBottom "carouselAreaHeight")
	)

	(macro DEFAULT_CACHED_SHOW_ANIMATION 1)

	(scrollArea
		(style
			(width = 100%)
			(maxHeight = 100%)
			(backgroundColor = "NO_COLOR")
		)

		(macro DEFAULT_VERTICAL_SCROLL_PARAMS
			_singleStep = "EVENT_BANNER_HEIGHT.LARGE"
			_wheelScrollAcceleration = "0.8"
			_isContrastScrollBar = "true"
		)

		(content
			(style
				(flow = "tile_horizontal")
				(width = 100%)
				(gap = "S")
			)

			(element WaffentragerBannerEvent)

			(element WaffentragerBannerPortal)

			(element WaffentragerBannerProgress
				_isWaffentragerSelected = "waffentrager.isSelected"
			)

			(block
				(controller $Instance renderer='WaffentragerBannerBureau'
					(bind enabled "!waffentragerState.isFinalStatsTimeReached")
					(args
						_isWaffentragerSelected = "waffentrager.isSelected"
					)
				)
			)
		)
	)
)

(def element WaffentragerBannerEvent ()
	(scope
		(macro MOUSE_HANDLER_SCOPE)
		(var waffentragerEventEntity:dhEntity = "getSingleEntity(CC.waffentragerEvent)")
		(var isNewMarker:bool = "waffentragerEventEntity.hasComponent(CC.newItem)")
	)
	(style
		(width = "EVENT_BANNER_WIDTH.MEDIUM")
		(height = "EVENT_BANNER_HEIGHT.MEDIUM")
	)

	(macro MOUSE_HANDLER_BANNER
		_methods = "[
			{	type: 'inputMapping.onAction',
				name: 'navigateTo',
				args: { route: SC.Ui_windows.ROUTE.OVERLAY_BROWSER, data: { url: SC.Ui_windows.GUI_URL.WAFFENTRAGER_LANDING_IN_GAME }}},
			{   type: 'inputMapping.onAction',
				name: isNewMarker ? 'makeSeen' : '',
				args: { entityId: waffentragerEventEntity.id }}
		]"
	)

	(element WaffentragerBannerBackground
		_rollOver = "rollOver"
		_mouseDown = "mouseDown"
		_bannerName = 'event'
	)

	(block
		(class $WTBannerContent)

		(element WaffentragerBannerTitle
			_title = 'IDS_WT_ABOUT_EVENT_TITLE'
		)

		(block
			(class $WTBannerHorizontalLine)
			(element HorizontalDividerTwoPx)
		)

		(element WaffentragerBannerDescription
			_description = 'IDS_WT_ABOUT_EVENT_DESCRIPTION'
		)
	)

	(block
		(macro DEFAULT_CONTROL_MARKER_ANIMATION "isNewMarker")

		(style
			(position = "absolute")
			(right = "LM")
			(top = "XS")
		)

		(element MarkerNew)
	)

	(controller $Tooltip
		(renderer = 'WaffentragerBannerEventTooltip')
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)

(def element WaffentragerBannerPortal ()
	(scope
		(macro MOUSE_HANDLER_SCOPE)

		(var waffentragerEvent:dhComponent = "getSingleComponent(CC.waffentragerEvent)")
		(struct waffentragerState = PULL_WAFFENTRAGER_EVENT_STATE(_component = "waffentragerEvent"))

		(var waffentragerPortalMessages:dhCollection = "getCollectionByPath(CC.waffentragerPortalMessage, 'byPriority')")
		(var waffentragerPortalMessageEntity:dhEntity = "waffentragerPortalMessages.getEntityAtIndex(0)")
		(var tokenId:str = "waffentragerPortalMessageEntity.waffentragerPortalMessage.tokenId")
		(var postfix:str = "tokenId	&& !waffentragerState.isFinalStatsTimeReached ? tokenId : 'WTEVENT_2510_FINAL'")

		(var isNewMarker:bool = "waffentragerPortalMessageEntity.hasComponent(CC.newItem)")
	)

	(macro MOUSE_HANDLER_BANNER
		_methods = "[
			{	type: 'inputMapping.onAction',
				name: 'navigateTo',
				args: { route: SC.Ui_windows.ROUTE.OVERLAY_BROWSER, data: { url: SC.Ui_windows.GUI_URL.WAFFENTRAGER_PORTAL_COMPANY }}},
			{	type: 'inputMapping.onAction',
				name: isNewMarker ? 'makeSeen' : '',
				args: { entityId: waffentragerPortalMessageEntity.id }}
		]"
	)

	(style
		(width = "EVENT_BANNER_WIDTH.MEDIUM")
		(height = "EVENT_BANNER_HEIGHT.MEDIUM")
	)

	(element WaffentragerBannerBackground
		_rollOver = "rollOver"
		_mouseDown = "mouseDown"
		_bannerName = 'portal'
	)

	(block
		(class $WTBannerContent)
		(block
			(style
				(width = 100%)
				(height = 42px)
			)
			(element WaffentragerBannerTitle
				_title = "'IDS_PORTAL_TITLE_' + postfix"
			)
		)

		(block
			(class $WTBannerHorizontalLine)
			(element HorizontalDividerTwoPx)
		)

		(element WaffentragerBannerDescription
			_description = "'IDS_PORTAL_DESCRIPTION_' + postfix"
		)
	)

	(block
		(macro DEFAULT_CONTROL_MARKER_ANIMATION "isNewMarker")

		(style
			(position = "absolute")
			(right = "LM")
			(top = "XS")
		)

		(element MarkerNew)
	)

	(controller $Tooltip
		(renderer = 'WaffentragerBannerPortalTooltip')
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)

(def element WaffentragerBannerProgress (_isWaffentragerSelected:bool = false)
	(scope
		(macro MOUSE_HANDLER_SCOPE)

		(macro PULL_SHIP_ID)
		(struct waffentrager = PULL_WAFFENTRAGER_SHIP(_playerShipId="playerShipId"))

		(var waffentragerEvent:dhComponent = "getSingleComponent(CC.waffentragerEvent)")

		(struct serverTime = SERVER_TIME())
		(struct waffentragerState = PULL_WAFFENTRAGER_EVENT_STATE(_component = "waffentragerEvent"))
		(struct waffentragerTimer = PULL_WAFFENTRAGER_EVENT_TIMER(_component = "waffentragerEvent"))
		(struct waffentragerProgression = PULL_WAFFENTRAGER_PROGRESSION(_component = "waffentragerEvent"))

		(var isProgressBarVisible:bool = "waffentragerState.isActive && !waffentragerProgression.isCompleted")
	)
	(style
		(width = "EVENT_BANNER_WIDTH.LARGE")
		(height = "EVENT_BANNER_HEIGHT.LARGE")
	)

	(macro MOUSE_HANDLER_BANNER
		_methods = "[
			{	type: 'inputMapping.onRequest',
				name: 'openWaffentragerProgress',
				args: { }}
		]"
	)

	(element WaffentragerBannerBackground
		_rollOver = "rollOver"
		_mouseDown = "mouseDown"
		_bannerName = 'progress'
	)

	(block
		(class $WTBannerContent)

		(element WaffentragerBannerTitle
			_title = 'IDS_WT_PROGRESS_TITLE'
		)

		(block
			(class $WTBannerHorizontalLine)
			(element HorizontalDividerTwoPx)
		)

		(block
			(style
				(width = 480px)
				(bind marginTop "waffentragerState.isActive ? XS : 0")
			)
			(controller $Instance renderer='WaffentragerBannerProgressEventActive'
				(bind enabled "waffentragerState.isActive")
				(args
					_isWaffentragerSelected = "_isWaffentragerSelected"
					_isProgressBarVisible = "!waffentragerProgression.isCompleted"
					_mainProgressionUntil = "waffentragerTimer.mainProgressionUntil"
					_eventFinishReminderUntil = "waffentragerTimer.eventFinishReminderUntil"
					_currentPoints = "waffentragerProgression.progressPoints"
					_maxPoints = "waffentragerProgression.maxPoints"
					_currentThreshold = "waffentragerProgression.currentThresholdId"
					_maxThreshold = "waffentragerProgression.mainProgressionLen"
				)
			)
			(controller $Instance renderer='WaffentragerBannerProgressEventFinished'
				(bind enabled "waffentragerState.isFinalStatsTimeReached")
				(args
					_rewardsClaimUntil = "waffentragerTimer.rewardsClaimUntil"
					_progress = "waffentragerProgression.currentThresholdId"
					_isCompleted = "waffentragerProgression.isCompleted"
				)
			)
		)
	)

	(block
		(style
			(position = "absolute")
			(right = 0px)
			(bottom = 0px)
		)
		(controller $Instance renderer = 'EventBannerIcon'
			(bind enabled "waffentragerState.hasAvailableRewards")
			(args
				_size = "SC.Ui_common.TILE_SIZE.L"
				_icon = 'url:../service_kit/port_banner/icon_banner_reward.png'
				_isAnimated = true
			)
		)
	)

	(controller $Tooltip
		(renderer = 'WaffentragerBannerProgressTooltip')
		(args
			_isWaffentragerSelected = "_isWaffentragerSelected"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)

(def element WaffentragerBannerProgressEventActive (	_isWaffentragerSelected:bool = false,
														_isProgressBarVisible:bool = false,
														_mainProgressionUntil:number = 0,
														_eventFinishReminderUntil:number = 0,
														_currentPoints:number = 0,
														_maxPoints:number = 1,
														_currentThreshold:number = 0,
														_maxThreshold:number = 1)
	(scope
		(struct serverTime = SERVER_TIME())
		(struct eventFinishTime = COUNTDOWN(_time = "_mainProgressionUntil" _serverTime = "serverTime.value" _format = "'HIGHEST,WITH_DAYS'"))

		(var waffentragerEvent:dhComponent = "getSingleComponent(CC.waffentragerEvent)")
		(var activationKeys:number = "waffentragerEvent.activationKeys" (event "waffentragerEvent.evChanged"))
		(var isDeficit:bool = "activationKeys == 0 && _isWaffentragerSelected")

		(var timeLeft:number = "_mainProgressionUntil - serverTime.value")
		(var unifiedStatus:str = "timeLeft < DAY_IN_SEC	? SC.Ui_styles.UNIFIED_STATUS.DATE_ATTENTION
														: SC.Ui_styles.UNIFIED_STATUS.DATE")
		(var progress:number = "_currentPoints && _maxPoints ? _currentPoints / _maxPoints : 0")

		(var isTimerVisible:bool = "serverTime.value >= _eventFinishReminderUntil")
	)

	(style (width = 100%))

	(hblock
		(element PriceTagWithLabel
			_size = "SIZE.MEDIUM"
			_label = 'IDS_WAFFENTRAGERACTIVATIONKEYS_COLUMN'
			_priceInfo = "{ finalPrice: activationKeys, currency: SC.Common.CURRENCIES.WAFFENTRAGER_ACTIVATION_KEYS }"
			_isDeficit = "isDeficit"
		)
		(block
			(style (bind marginLeft "isTimerVisible ? L : 0"))
			(controller $Instance renderer = 'StatusLine'
				(bind enabled "isTimerVisible")
				(args
					_textClass = '$TextDefault18NM'
					_text = "subst('IDS_WT_PROGRESS_TIME_LEFT', [], { _timeLeft: eventFinishTime.value})"
					_unifiedStatus = "unifiedStatus"
				)
			)
		)
	)

	(block
		(style
			(width = 100%)
			(marginTop = "MS")
		)
		(block
			(style (width = 100%))
			(controller $Instance renderer='DefaultProgressBar'
				(bind enabled "_isProgressBarVisible")
				(args
					_progress = "progress"
				)
			)
		)

		(hblock
			(bind visible "_isProgressBarVisible")
			(style
				(marginTop = "S")
				(align = "middle")
			)
			(tf
				(class $TextDefault18NM)
				(style
					(marginRight = 6px)
					(alpha = "TA")
				)
				(text = 'IDS_WT_PROGRESS_LEVEL_COLON')
			)
			(element DefaultDividedCounter
				_curValueTextClass = '$TextDefault18NM'
				_doNotHideOnZeroMaxValue = true
				_curValue = "_currentThreshold"
				_maxValue = "_maxThreshold"
			)
		)

		(controller $Instance renderer='StatusLine'
			(bind enabled "!_isProgressBarVisible")
			(args
				_text = 'IDS_WT_PROGRESS_STATUS_EVENT_ACTIVE_TASKS_COMPLETED'
				_width = 100%
			)
		)
	)
)

(def element WaffentragerBannerProgressEventFinished (_rewardsClaimUntil:number = 0, _progress:number = 0, _isCompleted:bool = false)
	(scope
		(struct serverTime = SERVER_TIME())
		(struct countdownRewardsClaimUntil = COUNTDOWN(_time = "_rewardsClaimUntil" _serverTime = "serverTime.value" _format = "'HIGHEST'"))
		(var isParticipated:bool = "_progress > 0 && !_isCompleted")
		(var finishText:str = "	isParticipated	? subst('IDS_WT_PROGRESS_STATUS_EVENT_FINISH_PARTICIPATED', [], {_progress: _progress}, _progress) :
								_isCompleted	? 'IDS_WT_PROGRESS_STATUS_EVENT_FINISH_MAX'
												: 'IDS_WT_PROGRESS_STATUS_EVENT_FINISH_SKIP'")
		(var eventFinishText:str = "(_rewardsClaimUntil - serverTime.value) < HOUR_IN_SEC	? 'IDS_WT_PROGRESS_EVENT_FINISH_TIME_LEFT_MINUTES'
																							: 'IDS_WT_PROGRESS_EVENT_FINISH_TIME_LEFT'")
	)
	(style (width = 100%))

	(tf
		(class $TextDefault18NM)
		(style
			(marginBottom = "M")
			(alpha = "TA")
		)
		(bind text "finishText")
	)

	(element StatusLine
		_text = "subst(eventFinishText, [], { _timeLeft: countdownRewardsClaimUntil.value }, countdownRewardsClaimUntil.value)"
		_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.DATE_ATTENTION"
		_width = 100%
	)
)

(def element WaffentragerBannerBureau (_isWaffentragerSelected:bool = false)
	(scope
		(macro MOUSE_HANDLER_SCOPE)
		(struct waffentragerBoosterTotals = PULL_WAFFENTRAGER_TOTAL_ACTIVE_BOOSTERS())

		(var bureauContent:str = "	waffentragerBoosterTotals.attributes.hasActiveBoosters	? _isWaffentragerSelected	? 'WaffentragerBannerBureauContentWarning'
																														: 'WaffentragerBannerBureauContentBoosters'
																							: 'WaffentragerBannerBureauContentAbout'")
	)
	(style
		(width = "EVENT_BANNER_WIDTH.LARGE")
		(height = "EVENT_BANNER_HEIGHT.LARGE")
		(backgroundColor = "NO_COLOR")
	)
	(macro MOUSE_HANDLER_BANNER
		_methods = "[
			{	type: 'inputMapping.onRequest',
				name: 'openWaffentragerBureau',
				args: { }}
		]"
	)

	(element WaffentragerBannerBackground
		_rollOver = "rollOver"
		_mouseDown = "mouseDown"
		_bannerName = 'bureau'
	)

	(block
		(class $WTBannerContent)

		(element WaffentragerBannerTitle
			_title = 'IDS_WT_BUREAU_TITLE'
		)

		(block
			(style
				(width = 100%)
				(marginTop = "M")
				(bind marginBottom "waffentragerBoosterTotals.attributes.hasActiveBoosters	? _isWaffentragerSelected	? 36px
																														: 30px
																							: SXS")
			)
			(element HorizontalDividerTwoPx)
		)

		(block
			(style (width = 100%))
			(controller $Instance
				(bind renderer "bureauContent")
			)
		)
	)

	(controller $Tooltip
		(renderer = 'WaffentragerBannerBureauTooltip')
		(args
			_isWaffentragerSelected = "_isWaffentragerSelected"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)

(def element WaffentragerBannerBureauContentAbout ()
	(style (width = 100%))
	(element WaffentragerBannerDescription
		_description = 'IDS_WT_BUREAU_DESCRIPTION'
	)
)

(def element WaffentragerBannerBureauContentBoosters ()
	(scope
		(struct waffentragerBoosterTotals = PULL_WAFFENTRAGER_TOTAL_ACTIVE_BOOSTERS())
	)
	(style
		(width = 100%)
		(flow = "horizontal")
		(gap = "MS")
	)

	(controller $Repeat renderer='WaffentragerBureauBooster'
		(bind count "waffentragerBoosterTotals.attributes.positive.length")
		(args
			_dataItem = "waffentragerBoosterTotals.attributes.positive[$index]"
		)
	)

	(controller $Repeat renderer='WaffentragerBureauBooster'
		(bind count "waffentragerBoosterTotals.attributes.negative.length")
		(args
			_dataItem = "waffentragerBoosterTotals.attributes.negative[$index]"
		)
	)

	(controller $Repeat renderer='WaffentragerBureauBooster'
		(bind count "waffentragerBoosterTotals.attributes.neutral.length")
		(args
			_dataItem = "waffentragerBoosterTotals.attributes.neutral[$index]"
		)
	)
)

(def element WaffentragerBureauBooster (_dataItem:dict = {}, _width:number = 0)
	(style
		(flow = "horizontal")
		(align = "middle")
		(bind width "_width ?: 'auto'")
	)
	
	(block
		(style
			(width = 38px)
			(height = 38px)
			(marginRight = "XS")
			(bind backgroundImage "'url:../service_kit/currencies/icon_' + WAFFENTRAGER_BOOSTERS_ICONS[_dataItem.paramName] + '_large.png'")
		)
	)

	(tf
		(class $TextDefaultBold24NM)
		(bind class "	_dataItem.category == 'negative'	? '$FontColorCompareNegative'
															: '$FontColorDefault'")
		(bind text "_dataItem.measuredValue")
	)

	(tf
		(class $TextDefaultBold24NM)
		(bind class "	_dataItem.category == 'negative'	? '$FontColorCompareNegative'
															: '$FontColorDefault'")
		(style
			(marginLeft = "XS")
			(alpha = 0.8)
		)
		(bind text "_dataItem.measure")
	)
)

(def element WaffentragerBannerBureauContentWarning ()
	(style (width = 100%))
	(element WaffentragerBannerDescription
		_textClass = '$TextDefault20NM'
		_description = 'IDS_WT_BUREAU_WARNING'
		_isWarning = true
	)
)

(def element WaffentragerBannerTitle (_title:str = '')
	(style (width = 100%))
	(tf
		(class $TextDefaultBold24NM)
		(style
			(width = 100%)
			(leading = -4)
			(alpha = "TA")
		)
		(bind text "_title")
	)
)

(def element WaffentragerBannerDescription (_textClass:str = '', _description:str = '', _isWarning:bool = false)
	(style (width = 100%))
	(tf
		(bind class "_textClass ?: '$TextDefault18NM'")
		(style
			(width = 100%)
			(leading = -4)
			(bind textColor "_isWarning ? SC.Ui_styles.SERVICE_COLORS.RED :  SC.Ui_styles.SERVICE_COLORS.WHITE")
			(bind alpha "_isWarning ? 1 : TA")
		)
		(bind text "_description")
	)
)

(def element WaffentragerBannerBackground (_rollOver:bool = false, _mouseDown:bool=false, _bannerName:str = '')
	(scope
		(struct qualityGraphicsPref = GET_PREF_STR(_option="'graphics.preset'"))
		(var qualityGraphics:str = "qualityGraphicsPref.value")
		(var isStatic:bool = "qualityGraphics == SC.Ui_prefs.GRAPHICS_PRESET.LOW || qualityGraphics == SC.Ui_prefs.GRAPHICS_PRESET.MINIMUM")

		(var colorTransform:dict = "	_rollOver && !_mouseDown	? CT_BANNER_ROLL_OVER :
										_mouseDown					? CT_BANNER_DOWN
																	: CT_NONE")
	)
	(class $FullsizeAbsolute)

	(block
		(class $FullsizeAbsolute)

		(element BlurMapRoundedWithContrastPanel
			_roundSize = "SIZE.MEDIUM"
		)
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(borderRadius = "S")
			(backgroundSize = "cover")
			(bind backgroundImage "'url:../animations/spine/waffentrager/banners/banner_' + _bannerName + '.skel'")
		)
		(controller $Spine
			(bindcall pause init=true (bind enabled "isStatic"))
			(bindcall resume (bind enabled "!isStatic"))
		)
	)

	(macro DEFAULT_CONTROL_STATE_ANIMATION_CT
		_colorTransform = "colorTransform"
	)
)