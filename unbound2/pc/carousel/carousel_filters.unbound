(def constant DOCK_CAROUSEL_SHIP_RESTRICTION_TYPE 0)
(def constant SHIP_MASTERY_CAROUSEL_SHIP_RESTRICTION_TYPE 17)

(def constant APPLIED_FILTERS_BUTTON_ALPHA "{
	SC.Ui_styles.BUTTON_STATE.SELECTED	: 0.4,
	SC.Ui_styles.BUTTON_STATE.DOWN		: 0.4,
	SC.Ui_styles.BUTTON_STATE.OVER		: 0.5,
	SC.Ui_styles.BUTTON_STATE.UP		: 0.25
}")

(def constant APPLIED_FILTERS_BUTTON_CLOSE_ALPHA "{
	SC.Ui_styles.BUTTON_STATE.SELECTED	: 0.45,
	SC.Ui_styles.BUTTON_STATE.DOWN		: 0.45,
	SC.Ui_styles.BUTTON_STATE.OVER		: 0.75,
	SC.Ui_styles.BUTTON_STATE.UP		: 0.6
}")

(def constant CAROUSEL_SORT_FIELD_WIDTH 180px)
(def constant CAROUSEL_CONTENT_SIDE_MARGIN 30px)

(def element CarouselFilters ()
	(scope
		(event evSetString)

		(struct crewFeature = FEATURES(_state="SC.Common.ACCOUNT_FEATURE.CREW"))
		(struct shipMasteryRoute = PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.SHIP_MASTERY"))

		(struct campaignChooseRoute =		PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.CAMPAIGNS_CHOOSE_CAMPAIGN"))
		(struct campaignChooseTaskRoute =	PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.CAMPAIGNS_CHOOSE_TASK"))
		(var activeCampaignTasksCollection:dhCollection = "getCollectionByPath(CC.campaignTaskPlayer, 'active')")
		(var isCampaignsFiltersVisible:bool = "(campaignChooseRoute.isActive || campaignChooseTaskRoute.isActive) && activeCampaignTasksCollection.length > 0")

		(struct sseRoute =		PULL_ROUTE(_id = "SC.Ui_windows.ROUTE.SSE"))
		(var isFilterIconVisible:bool = "!sseRoute.isActive")

		(var panelEntity:dhEntity = "getSingleEntity(CC.filterPanelComponent)")
		(var shipListRestrictionsEntity:dhEntity = "getPrimaryEntity(CC.shipListRestrictions, panelEntity.filterPanelComponent.shipRestrictionType)" (event "panelEntity.filterPanelComponent.evShipRestrictionTypeChanged"))
		(var shipListRestrictionsComponent:dhComponent = "shipListRestrictionsEntity.shipListRestrictions")
		(var selectedFilters:array = "shipListRestrictionsComponent.selectedFilters" (event "shipListRestrictionsComponent.evUpdate"))

		(var trainingRoomEntity:dhEntity = "getSingleEntity(CC.trainingRoomWindowState)")

		(var selectedBattleTypesEntity:dhEntity = "getSingleEntity(CC.battleType, 'selected')")
		(var selectedBattleTypeComponent:dhComponent = "selectedBattleTypesEntity.battleType")
		(var selectedBattleType:str = "selectedBattleTypeComponent.type ?: ''" (event "selectedBattleTypeComponent.evBattleTypeChanged"))

		
		(var shipListRestrictions:array =	"trainingRoomEntity.shipListRestrictions.selectedFilters"	(event "trainingRoomEntity.shipListRestrictions.evUpdate"))
		(var shipsCount:array =				"trainingRoomEntity.divisionRestrictions.shipsCount"		(event "trainingRoomEntity.divisionRestrictions.evUpdate"))
		(var typesCount:dict =				"trainingRoomEntity.divisionRestrictions.typesCount"		(event "trainingRoomEntity.divisionRestrictions.evUpdate"))

		(var defaultRestrictionsEntity:dhEntity = "getPrimaryEntity(CC.battleType, SC.Common.BATTLE_TYPES.TRAINING_BATTLE + '_' + toString(SC.Common.GAME_PARAMS.INVALID_PARAM_ID))")
		(var defaultTypesCount:dict = "defaultRestrictionsEntity.divisionRestrictions.typesCount" (event "defaultRestrictionsEntity.divisionRestrictions.evUpdate"))
		(var hasForbiddenShipType:bool = "defaultRestrictionsEntity.divisionRestrictions.hasForbiddenShipType ?: false" (event "defaultRestrictionsEntity.divisionRestrictions.evUpdate"))

		(var isCarriersRestricted:bool =	"typesCount[SC.Common.SHIP_TYPE.AIRCARRIER]	&& typesCount[SC.Common.SHIP_TYPE.AIRCARRIER][1] != defaultTypesCount[SC.Common.SHIP_TYPE.AIRCARRIER][1]")
		(var isBattleShipsRestricted:bool = "typesCount[SC.Common.SHIP_TYPE.BATTLESHIP]	&& typesCount[SC.Common.SHIP_TYPE.BATTLESHIP][1] != defaultTypesCount[SC.Common.SHIP_TYPE.BATTLESHIP][1]")
		(var isCruisersRestricted:bool =	"typesCount[SC.Common.SHIP_TYPE.CRUISER]	&& typesCount[SC.Common.SHIP_TYPE.CRUISER][1] != defaultTypesCount[SC.Common.SHIP_TYPE.CRUISER][1]")
		(var isDestroyersRestricted:bool =	"typesCount[SC.Common.SHIP_TYPE.DESTROYER]	&& typesCount[SC.Common.SHIP_TYPE.DESTROYER][1] != defaultTypesCount[SC.Common.SHIP_TYPE.DESTROYER][1]")
		(var isSubmarinesRestricted:bool =	"typesCount[SC.Common.SHIP_TYPE.SUBMARINE]	&& typesCount[SC.Common.SHIP_TYPE.SUBMARINE][1] != defaultTypesCount[SC.Common.SHIP_TYPE.SUBMARINE][1]")
		(var isAnyShipTypeRestricted:bool = "isCarriersRestricted || isBattleShipsRestricted || isCruisersRestricted || isDestroyersRestricted || isSubmarinesRestricted")
		(var isShipFilterRestrictionsVisible:bool = "isAnyShipTypeRestricted && hasForbiddenShipType")

		(var hasTrainingRoomRestrictions:bool = "shipListRestrictions.length > 0 || isShipFilterRestrictionsVisible")
		(var isTrainingBattle:bool = "selectedBattleType == SC.Common.BATTLE_TYPES.TRAINING_BATTLE")
		(var isTournamentBattle:bool = "selectedBattleType == SC.Common.BATTLE_TYPES.TOURNAMENT_BATTLE")
		(var isCustomBattle:bool = "isTrainingBattle || isTournamentBattle")

		(var isCustomFilterVisible:bool = "trainingRoomEntity && hasTrainingRoomRestrictions && isCustomBattle")
		

		(var isBattleTypeFilterVisible:bool = "	(isIn(selectedBattleType, SC.Common.BATTLE_TYPES.BATTLE_TYPES_WITH_HARD_FILTER) || isCustomFilterVisible) &&
												!shipMasteryRoute.isActive &&
												!isCampaignsFiltersVisible")

		(var searchStr:str = "panelEntity.filterPanelComponent.searchString" (event "panelEntity.filterPanelComponent.evUpdate"))
		(var isResetButtonVisible:bool = "selectedFilters.length > 0 || searchStr != ''")
		(var isInfotipVisible:bool = false)

		(var filterTypes:array = "SC.Common.SHIP_FILTER_TYPE.ALL")

		(var ident:number = "panelEntity.filterPanelComponent.shipRestrictionType" (event "panelEntity.filterPanelComponent.evShipRestrictionTypeChanged"))

		(var prefDir:str = "	ident == DOCK_CAROUSEL_SHIP_RESTRICTION_TYPE			? 'carousel' :
								ident == SHIP_MASTERY_CAROUSEL_SHIP_RESTRICTION_TYPE	? 'shipMasteryCarousel'
																						: 'trainingRoom'")
	)
	(bindcall externalCall 'direct.action' "['option.set', [ 'ui.' + prefDir + '.filters.searchString', $event.inputStr]]" watch=false (event "evSetString"))
	(bindcall externalCall "crewFeature.state == 'locked' ? 'direct.action' : ''" "['option.set', [ 'ui.carousel.filters.' + SC.Common.SHIP_FILTER_TYPE.SPECIAL + '.' + SC.Common.SHIP_SPECIAL_FILTER_TYPE.WITH_COMMANDER, false ]]" watch=false on='addedToStage')
	(bindcall externalCall "crewFeature.state == 'locked' ? 'direct.action' : ''" "['option.set', [ 'ui.carousel.filters.' + SC.Common.SHIP_FILTER_TYPE.SPECIAL + '.' + SC.Common.SHIP_SPECIAL_FILTER_TYPE.WITHOUT_COMMANDER, false ]]" watch=false on='addedToStage')

	(style
		(flow = "horizontal")
		(height = 32px)
		(width = 100%)
		(align = "middle")
		(paddingLeft = "XS")
		(paddingBottom = "S")
	)

	(block
		(style
			(height = 24px)
			(width = 26px)
		)

		(block
			(macro CONTROL_VISIBLE_STATE_ANIMATION _isTrigger="isFilterIconVisible")

			(element ImageButton
				_name = 'CarouselFiltersButton'
				_width = 26px
				_height = 24px
				_mouseDown = "isInfotipVisible"
				_backgroundImage = 'url:../service_kit/buttons/context/filter.png'
			)

			(controller $Tooltip
				(renderer = 'SimpleStatusTooltip')
				(args
					_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
					_text = 'IDS_TOOLTIP_CAROUSEL_FILTERS'
				)
				(macro DEFAULT_TOOLTIP_BEHAVIOUR "0")
			)

			(controller $Tooltip
				(renderer = 'CarouselFiltersInfotip')
				(args
					_selectedFilters = "selectedFilters"
					_searchStr = "searchStr"
					_ident = "ident"
				)
				(cache = true)
				(macro CAROUSEL_INFOTIP_BEHAVIOUR "1")
				(align = "top|innerRight")
				(screenBoundsOffset = "XS")

				(bind isInfotipVisible "true" init=false watch=false on='evStartShow')
				(bind isInfotipVisible "false" init=false watch=false on='evHide')
			)
		)
	)

	(hblock
		(style
			(width = 100%)
			(marginLeft = "XXS")
			(hgap = "XS")
		)

		(block
			(controller $Animation
				(bindcall play	duration = 0.15
								from = "{ alpha: 0, visualOffsetY: 10px }"
								to = "{ alpha: 1, visualOffsetY: 0px }"
								easing = "Easing.quad_in"
								on = 'addedToStage'
				)
			)

			(controller $Instance renderer='AppliedHardSystemFilter'
				(bind enabled "isBattleTypeFilterVisible")
			)

			(controller $Instance renderer='AppliedShipMasteryFilters'
				(bind enabled "shipMasteryRoute.isActive")
			)

			(controller $Instance renderer='AppliedCampaignsFilters'
				(bind enabled "isCampaignsFiltersVisible")
			)
		)

		(scrollArea
			(style (maxWidth = 100%))
			(macro DEFAULT_HORIZONTAL_SCROLL_PARAMS
				_isScrollBarVisible = "false"
				_hasShadow = "true"
			)

			(content
				(style
					(flow = "horizontal")
					(hgap = "XS")
				)

				(controller $Repeat renderer='AppliedFilter'
					(bind count "filterTypes.length")
					(args
						_filterType = "filterTypes[$index]"
						_shipListRestrictionsComponent = "shipListRestrictionsComponent"
						_searchStr = "searchStr"
						_ident = "ident"
					)
				)
			)
		)

		(block
			(style (marginRight = 10px))

			(controller $Animation
				(bindcall play
					duration = 0.15
					from = {alpha: 0}
					to = {alpha: 1}
					easing = "Easing.quad_in"
					(bind enabled "isResetButtonVisible")
				)
			)

			(controller $Instance renderer='ResetAllCarouselFiltersButton'
				(bind enabled "isResetButtonVisible")
				(args
					_ident = "ident"
				)
			)
		)
	)
)

(def constant CAROUSEL_ROW_COUNT [
	'IDS_CAROUSEL_VIEW_ROW_ONE',
	"subst('IDS_CAROUSEL_VIEW_ROW', [], { _rowsCount: 2 })",
	"subst('IDS_CAROUSEL_VIEW_ROW', [], { _rowsCount: 3 })",
	"subst('IDS_CAROUSEL_VIEW_ROW', [], { _rowsCount: 4 })"
])

(def element CarouselFiltersInfotip (_searchStr:str, _selectedFilters:array, _ident:number)
	(scope
		(event searchShipButtonClicked)
		(event closeSearchField)
		(event inputStrChanged)
		(event carouselHideFilteredChanged)
		(event ItemChooser_shipsSortSelected)
		(event ItemChooser_carouselRowsCountChanged)
		(event evResetAllFilters)

		(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_SCOPE)

		(macro PULL_ROUTE "SC.Ui_windows.ROUTE.SHIP_MASTERY" "'isInShipMastery'")

		(macro GET_PREF_NUMBER 'uiRowCountIndex' "'ui.carousel.uiRowCountIndex'")
		(struct userPrefs = USER_PREF_DATA())
		(var isFilteredShipsHided:bool = "userPrefs.prefs.isFilteredShipsHided")

		(var isSearchingShipByName:bool = "toBool(_searchStr)" watch=false (event "evStartShow"))
		(bind isSearchingShipByName "true" init=false watch=false (event "searchShipButtonClicked"))
		(bind isSearchingShipByName "false" init=false watch=false (event "closeSearchField") (event "evResetAllFilters"))

		(var inputStr:str = "_searchStr" watch=false)
		(bind inputStr "$event.value" init=false watch=false (event "inputStrChanged"))
		(bind inputStr "''" init=false watch=false (event "closeSearchField"))

		(var isResetButtonVisible:bool = "_selectedFilters || _searchStr")

		(var filterBlockTitlesDock:array = "['IDS_LEVEL', 'IDS_CLASS', 'IDS_NATION', 'IDS_SPECIAL', 'IDS_SHIP_BONUS']")
		(var filterBlockTitlesShipMastery:array = "['IDS_LEVEL', 'IDS_CLASS', 'IDS_NATION', 'IDS_SPECIAL', 'IDS_SHIP_MASTERY']")

		(var filterBlockTitles:array = "isInShipMastery ? filterBlockTitlesShipMastery : filterBlockTitlesDock")

		(var panelEntity:dhEntity = "getSingleEntity(CC.filterPanelComponent)")
		(var sortFields:array =	"panelEntity.filterPanelComponent.sortFields" (event "panelEntity.filterPanelComponent.evSortFieldsChanged"))
		(var sortIndex:number =	"panelEntity.filterPanelComponent.sortIndex" (event "panelEntity.filterPanelComponent.evUpdate"))
		(var isDescending:bool = "panelEntity.filterPanelComponent.isDescending" (event "panelEntity.filterPanelComponent.evUpdate"))

		(var filterTypes:array = "isInShipMastery ? SC.Common.SHIP_FILTER_TYPE.SHIP_MASTERY_FILTERS : SC.Common.SHIP_FILTER_TYPE.SHIP_APPLIED_FILTERS")

		(var prefDir:str = "	_ident == DOCK_CAROUSEL_SHIP_RESTRICTION_TYPE			? 'carousel' :
		 						_ident == SHIP_MASTERY_CAROUSEL_SHIP_RESTRICTION_TYPE	? 'shipMasteryCarousel'
																						: 'trainingRoom'")
	)
	(macro HIDE_UI_ON_SHIPOVERVIEW)
	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_MARKUP _isInfotip="true")
	(name = 'CarouselFiltersInfotipClip')

	(dispatch evSetString delay=0.2 reset=true dir="EventDirection.UP" args="{inputStr: inputStr}" (event "inputStrChanged") (event "closeSearchField"))
	(bindcall externalCall 'direct.action' "['option.set', [ 'ui.' + prefDir + '.sorting.sortIndex', $event.selectedIndex]]" init=false watch=false (event "ItemChooser_shipsSortSelected"))
	(bindcall externalCall 'direct.action' "['option.set', [ 'ui.' + prefDir + '.sorting.isDescending', $event.direction]]" init=false watch=false (event "ItemChooser_shipsSortSelected"))
	(bindcall externalCall 'direct.action' "['option.set', [ 'ui.carousel.rowCountIndex', $event.selectedIndex]]" init=false watch=false (event "ItemChooser_carouselRowsCountChanged"))

	(element INFOTIP_SYSTEM_DEFAULT_CONTAINER _isAutoSize=true _hasInsideOffset=false
		(hblock
			(style
				(align = "middle")
				(height = 30px)
				(width = 100%)
				(paddingLeft = "SXS")
				(paddingRight = "SXS")
				(marginTop = "S")
				(marginBottom = "S")
			)

			(tf
				(class $TextDefaultBold18NM)
				(style
					(alpha = "TA")
					(marginLeft = "XS")
					(marginRight = "M")
				)
				(text = 'IDS_FILTERS')
			)

			(block
				(style (marginTop = "XXS"))

				(controller $Animation
					(bindcall play
						duration = 0.15
						from = {alpha: 0}
						to = {alpha: 1}
						easing = "Easing.quad_in"
						(bind enabled "isResetButtonVisible")
					)
				)

				(controller $Instance renderer='DefaultButton'
					(bind enabled "isResetButtonVisible")
					(args
						_width = 120px
						_label = 'IDS_RESET_ALL_FILTERS'
						_type = "SC.Ui_styles.BUTTON_TYPE.SECONDARY"
						_focusIndex = 1
						_methods = "[	{	type: 'inputMapping.onAction',
											name: 'resetAllFilters',
											args: {ident: _ident}
										}]"
						_dispatchedEv = "'evResetAllFilters'"
						_size = "SIZE.SMALL"
					)
				)

				(controller $Tooltip
					(renderer = 'SimpleStatusTooltip')
					(args
						_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
						_text = 'IDS_HINT_RESET_ALL_FILTERS'
					)
					(macro DEFAULT_TOOLTIP_BEHAVIOUR)
				)
			)

			(block
				(bind visible "!isSearchingShipByName")
				(name = 'ButtonSearchShip')
				(style
					(align = "right")
					(width = 100%)
					(paddingRight = "XS")
				)

				(controller $Instance renderer='ImageWithTextButton'
					(bind enabled "!isSearchingShipByName")
					(args
						_imgUrl = 'url:../service_kit/buttons/context/search.png'
						_text = 'IDS_SEARCH_SHIP_BY_NAME'
						_dispatchedEv = 'searchShipButtonClicked'
						_isBoldText = false
						_size = "SIZE.SMALL"
					)
				)

				(controller $Tooltip
					(renderer = 'SimpleStatusTooltip')
					(args
						_text = 'IDS_HINT_SEARCH_SHIP_BY_NAME'
					)
					(macro DEFAULT_TOOLTIP_BEHAVIOUR)
				)
			)

			(block
				(bind visible "isSearchingShipByName")
				(style
					(position = "absolute")
					(right = "XS")
					(marginTop = "XXS")
				)

				(dispatch "'evInputFocusReset'" dir="EventDirection.DOWN" (bind enabled "_searchStr.length > 0") (event "evStartShow"))

				(controller $Instance renderer='InputTextDefault'
					(bind enabled "isSearchingShipByName")
					(args
						_onCloseButtonEvent = 'closeSearchField'
						_onInputChangedEvent = 'inputStrChanged'
						_closeButtonTooltipText = 'IDS_HINT_RESET_FILTER'
						_hideButtonEnter = true
						_defaultText = "_searchStr"
						_maxChars = 20
						_width = '260px'
						_defaultFocused = true
						_name = 'ShipNameField'
						_closeButtonName = 'ClearTextButton'
					)
				)
			)
		)

		(hblock
			(style
				(hgap = "S")
				(marginRight = "SXS")
				(marginLeft = "SXS")
			)

			(controller $Repeat renderer='FilterBlock'
				(bind count "filterTypes.length")
				(args
					_title = "filterBlockTitles[$index]"
					_filterType = "filterTypes[$index]"
					_ident = "_ident"
					_inCarousel = true
				)
			)
		)

		(hblock
			(style
				(width = 100%)
				(paddingLeft = "SXS")
				(paddingRight = "SXS")
				(marginTop = "M")
				(marginBottom = "S")
			)

			
			(hblock
				(style
					(width = 225px)
					(marginLeft = "XS")
					(marginRight = "XS")
				)
				(name = 'SmallCarouselView')

				(tf
					(class $TextDefaultNM)
					(style (alpha = "TC"))
					(text = 'IDS_CAROUSEL_VIEW_COLON')
				)

				(block
					(style
						(marginTop = -7px)
						(marginLeft = "XS")
					)

					(element ItemChooser
						_name = 'CarouselRows'
						_items = "CAROUSEL_ROW_COUNT"
						_listItemRenderer = 'CarouselShipRowsListItemRenderer'
						_onItemSelectedEvent = 'carouselRowsCountChanged'
						_curIndex = "uiRowCountIndex"
						_choosedItemRenderer = 'SmallTextItemChooserPickedItemRenderer'
						_itemChooserTooltipText = 'IDS_HINT_CAROUSEL_VIEW'
						_itemChooserTooltipUnifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
						_name = 'CarouselView'
					)
				)
			)

			
			(hblock
				(style
					(width = 290px)
					(marginRight = "L")
				)

				(tf
					(class $TextDefaultNM)
					(style (alpha = "TC"))
					(text = 'IDS_CAROUSEL_SORT_COLON')
				)

				(block
					(style
						(marginTop = -7px)
						(marginLeft = "XS")
					)

					(element ItemChooser
						_items = "sortFields"
						_curIndex = "sortIndex"
						_curDirection = "isDescending"
						_choosedItemRenderer = 'SmallTextItemChooserPickedItemRenderer'
						_listItemRenderer = 'TextListItemRenderer'
						_onItemSelectedEvent = 'shipsSortSelected'
						_itemChooserTooltipText = 'IDS_HINT_SHIP_CAROUSEL_SORT'
						_itemChooserTooltipUnifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
						_dropDownWidth = "CAROUSEL_SORT_FIELD_WIDTH"
						_name = 'CarouselOrdering'
					)
				)
			)

			
			(block
				(style
					(align = "right|middle")
					(width = 100%)
				)

				(element SwitchWithLeftLabel
					_name = 'HideFilteredShips'
					_state = "isFilteredShipsHided"
					_textClass = '$TextDefaultNM'
					_label = 'IDS_HIDE_FILTERED_SHIPS'
					_dispatchedEv = 'carouselHideFilteredChanged'
					_methods = "[ { type: 'inputMapping.onAction', name: 'setUserPref', args: { name: 'isFilteredShipsHided', value: !isFilteredShipsHided } } ]"
				)

				(controller $Tooltip
					(renderer = 'SimpleStatusTooltip')
					(args
						_text = "isFilteredShipsHided ? 'IDS_TOOLTIP_CAROUSEL_HIDE_FILTERED_SHIPS_DISABLE' : 'IDS_TOOLTIP_CAROUSEL_HIDE_FILTERED_SHIPS'"
						_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
					)
					(macro DEFAULT_TOOLTIP_BEHAVIOUR)
				)
			)
		)

		(block
			(style
				(hitTest = false)
				(marginBottom = "M")
				(paddingLeft = "SXS")
				(marginLeft = "XS")
			)

			(element ShipsAndSlotsCounter _isFilterActive = "isResetButtonVisible")
		)
	)
)

(def element CarouselShipRowsListItemRenderer (_curItemIndex:number=0, _item:str='' )
	(scope
		(macro STAGE_SIZE)
		(var fourRowsHeight:number = "CAROUSEL_ITEM_SMALL_HEIGHT_WITH_OFFSET * 4 + SPACING_AROUND_CAROUSEL")
		(var threeRowsHeight:number = "CAROUSEL_ITEM_SMALL_HEIGHT_WITH_OFFSET * 3 + SPACING_AROUND_CAROUSEL")

		
		(var isFourRowsEnabled:bool = "stageHeight > 560 + fourRowsHeight")
		
		(var isThreeRowsEnabled:bool = "stageHeight > 560 + threeRowsHeight")
		
		(var isEnabled:bool = "	SC.Ui_common.CAROUSEL_ROWS.ALL[$index] == SC.Ui_common.CAROUSEL_ROWS.ONE ||
								SC.Ui_common.CAROUSEL_ROWS.ALL[$index] == SC.Ui_common.CAROUSEL_ROWS.TWO ||
								isThreeRowsEnabled && SC.Ui_common.CAROUSEL_ROWS.ALL[$index] == SC.Ui_common.CAROUSEL_ROWS.THREE ||
								isFourRowsEnabled && SC.Ui_common.CAROUSEL_ROWS.ALL[$index] == SC.Ui_common.CAROUSEL_ROWS.FOUR")
	)

	(style
		(width = 100%)
		(backgroundColor = "NO_COLOR")
	)

	(element TextListItemRenderer
		_curItemIndex = "_curItemIndex"
		_item = "_item"
		_isInactive = "!isEnabled"
	)

	(controller $Tooltip
		(renderer = 'SimpleStatusTooltip')
		(bind enabled "isEnabled")
		(args
			_text = "'IDS_SHOW_' + SC.Ui_common.CAROUSEL_ROWS.VALUE_TO_NAME[$index+1] + '_ROWS_IN_CAROUSEL'"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)

	(controller $Tooltip
		(renderer = 'SimpleStatusTooltip')
		(bind enabled "!isEnabled")
		(args
			_text = 'IDS_NOT_ENABLED_ON_LOW_RESOLUTION'
			_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.WARNING"
		)
		(macro DEFAULT_TOOLTIP_BEHAVIOUR)
	)
)

(def element AppliedHardSystemFilter ()
	(scope
		(var selectedBattleTypesEntity:dhEntity = "getSingleEntity(CC.battleType, 'selected')")
		(var selectedBattleTypeComponent:dhComponent = "selectedBattleTypesEntity.battleType")
		(var selectedBattleType:str = "selectedBattleTypeComponent.type ?: ''" (event "selectedBattleTypeComponent.evBattleTypeChanged"))
		(var battleTypeGameParamId:number = "selectedBattleTypeComponent.battleTypeGameParamId")
		(var restrictionsEntityId:number = "selectedBattleTypeComponent.restrictionEntityId" (event "selectedBattleTypeComponent.evRestrictionEntityIdChanged"))

		(var defaultRestrictionsEntity:dhEntity = "getPrimaryEntity(CC.battleType, SC.Common.BATTLE_TYPES.TRAINING_BATTLE + '_' + toString(SC.Common.GAME_PARAMS.INVALID_PARAM_ID))")
		(var operationEntity:dhEntity = "getPrimaryEntity(CC.operation, battleTypeGameParamId)")
		(var operationCustomIconName:str = "operationEntity.operation.customIconName" (event "operationEntity.operation.evStatusChanged"))

		(var isPveBattle:bool = 				"selectedBattleType == SC.Common.BATTLE_TYPES.PVE_BATTLE")
		(var isEventBattle:bool = 				"selectedBattleType == SC.Common.BATTLE_TYPES.EVENT_BATTLE")
		(var isActiveTournamentBattle:bool = 	"selectedBattleType == SC.Common.BATTLE_TYPES.TOURNAMENT_BATTLE")
		(var isTrainingBattle:bool = 			"selectedBattleType == SC.Common.BATTLE_TYPES.TRAINING_BATTLE")
		(var isCustomBattle:bool = 				"isActiveTournamentBattle || isTrainingBattle")

		(var operationBattleName:str = "operationEntity.operation.gpName")
		(var operationBattleNameIDS:str = "tr('IDS_' + operationBattleName + '_NAME')")

		(var eventBattleName:str = "selectedBattleTypesEntity.eventBattleState.name")

		(var battleTypeIcon:str = "isEventBattle			? eventBattleName :
									operationCustomIconName ? operationCustomIconName
															: selectedBattleType")

		(var filterText:str = " isPveBattle && operationBattleName		? tr('IDS_' + operationBattleName + '_NAME') :
								isEventBattle && eventBattleName		? tr('IDS_' + eventBattleName) :
								isActiveTournamentBattle				? 'IDS_TOURNAMENTBATTLE' :
								selectedBattleType						? tr('IDS_' + selectedBattleType)
																		: ''")

		(var filterTooltipText:str = "	isEventBattle && eventBattleName	? tr('IDS_CAROUSEL_' + eventBattleName + '_FILTER') :
										isActiveTournamentBattle			? 'IDS_CAROUSEL_TOURNAMENTBATTLE_FILTER' :
										isPveBattle && operationBattleName	? subst('IDS_CAROUSEL_FILTER_CONSTRUCTOR', [], { operationBattleNameIDS: operationBattleNameIDS }):
										selectedBattleType					? tr('IDS_CAROUSEL_' + selectedBattleType + '_FILTER')
																			: ''")
	)
	(name = 'appliedHardSystemFilter')

	(block
		(class $FullsizeAbsolute)
		(element BlurMapRoundedWithContrastPanel
			_blurType = "ROUNDED_BLUR_TYPE.LOW"
		)
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.DARK_BLUE")
			(alpha = 0.4)
			(borderRadius = "XS")
		)
	)

	(hblock
		(style
			(flow = "horizontal")
			(paddingBottom = 3px)
		)

		(hblock
			(style (backgroundColor = "NO_COLOR"))

			(block
				(style
					(width = 23px)
					(height = 23px)
					(marginTop = 3px)
					(marginLeft = "S")
					(backgroundSize = "cover")
					(bind backgroundImage "'url:../service_kit/battle_types/' + battleTypeIcon + '_tiny.png'")
				)
			)

			(tf
				(class $TextDefault18NM)
				(style
					(marginTop = "S")
					(marginLeft = "XS")
					(alpha = "TA")
				)
				(bind text "filterText")
			)

			(controller $Tooltip
				(renderer='SimpleStatusTooltip')
				(args
					_text="filterTooltipText"
				)
				(macro DEFAULT_TOOLTIP_BEHAVIOUR "0")
			)
		)

		(block
			(style
				(marginLeft = "SXS")
				(marginTop = "XS")
			)

			(element ShipRestrictions
				_restrictionsEntityId = "restrictionsEntityId"
				_defaultRestrictionsEntityId = "isCustomBattle ? defaultRestrictionsEntity.id : null"
				_isCompactListShips = true
			)
		)
	)
)

(def element AppliedShipMasteryFilters ()
	(scope
		(var masteryRestrictionsEntity:dhEntity = "getSingleEntity(CC.shipMasteryCommon)")
	)

	(block
		(class $FullsizeAbsolute)
		(element BlurMapRoundedWithContrastPanel
			_blurType = "ROUNDED_BLUR_TYPE.LOW"
		)
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.DARK_BLUE")
			(alpha = 0.4)
			(borderRadius = "XS")
		)
	)

	(block
		(style
			(height = 29px)
			(paddingLeft = "S")
			(paddingTop = "XS")
		)

		(element ShipRestrictions
			_restrictionsEntityId = "masteryRestrictionsEntity.id"
			_isCompactListShips = true
		)
	)
)

(def element AppliedCampaignsFilters ()
	(scope
		(var shipListRestrictionsEntity:dhEntity = "getPrimaryEntity(CC.shipListRestrictions, SC.Common.SHIP_RESTRICTION_TYPES.CAMPAIGNS)")
	)

	(block
		(class $FullsizeAbsolute)
		(element BlurMapRoundedWithContrastPanel
			_blurType = "ROUNDED_BLUR_TYPE.LOW"
		)
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.DARK_BLUE")
			(alpha = 0.4)
			(borderRadius = "XS")
		)
	)

	(hblock
		(style
			(height = 29px)
			(paddingLeft = "S")
			(paddingTop = "XS")
			(hgap = "MS")
		)

		(tf
			(class $TextDefault18NM)
			(style
				(alpha = "TA")
				(marginTop = "XS")
			)
			(text = 'IDS_CAMPAIGNS_TITLE')
		)

		(element ShipRestrictions
			_restrictionsEntityId = "shipListRestrictionsEntity.id"
			_isCompactListShips = true
		)
	)
)

(def element ResetAllCarouselFiltersButton (_ident:number, _hasBlurBackground:bool = true)
	(scope
		(macro MOUSE_HANDLER_SCOPE)
		(var state:number = "	mouseDown	? SC.Ui_styles.BUTTON_STATE.DOWN :
								rollOver	? SC.Ui_styles.BUTTON_STATE.OVER
											: SC.Ui_styles.BUTTON_STATE.UP")

		(var buttonAlpha:number = "APPLIED_FILTERS_BUTTON_ALPHA[state]")
		(var closeIconAlpha:number = "APPLIED_FILTERS_BUTTON_CLOSE_ALPHA[state]")
	)

	(block
		(class $FullsizeAbsolute)

		(controller $Instance renderer='BlurMapRoundedWithContrastPanel'
			(bind enabled "_hasBlurBackground")
			(args
				_blurType = "ROUNDED_BLUR_TYPE.LOW"
			)
		)
	)

	(block
		(style (height = 29px))

		(block
			(class $FullsizeAbsolute)
			(style
				(hitTest = false)
				(borderRadius = "XS")
				(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.DARK_BLUE")
				(alpha = "buttonAlpha")
			)

			(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA
				_trigger = "state"
				_alpha = "buttonAlpha"
			)
		)

		(hblock
			(style (padding = "S"))

			(tf
				(class $TextDefault18NM)
				(style
					(hitTest = false)
					(alpha = "TC")
				)
				(text = 'IDS_RESET_ALL_FILTERS')
			)

			(block
				(style
					(marginLeft = 6px)
					(marginRight = -1px)
					(marginTop = 1px)
					(alpha = "closeIconAlpha")
				)

				(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA
					_trigger = "state"
					_alpha = "closeIconAlpha"
				)

				(element CloseButton)
			)
		)

		(macro MOUSE_HANDLER
			_methods = "[	{	type: 'inputMapping.onAction',
								name: 'resetAllFilters',
								args: {ident: _ident}
							}]"
			_dispatchedEv = "'evResetAllFilters'"
			_soundSet = "'button_secondary'"
		)

		(controller $Tooltip
			(renderer = 'SimpleStatusTooltip')
			(args
				_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
				_text = 'IDS_HINT_RESET_ALL_FILTERS'
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR)
		)
	)
)

(def element AppliedFilter (_shipListRestrictionsComponent:dhComponent, _ident:number, _filterType:str = '', _searchStr:str = '')
	(scope
		(macro MOUSE_HANDLER_SCOPE)
		(var selectedTypeFilters:array = "_shipListRestrictionsComponent.selectedFiltersByType[_filterType] ?: []" (event "_shipListRestrictionsComponent.evUpdate"))
		(var levelString:str = "_shipListRestrictionsComponent.levelString ?: ''" (event "_shipListRestrictionsComponent.evUpdate"))

		(var isLevelTypeFilter:bool = "_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_LEVEL")
		(var isShipNameFilter:bool = "_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_NAME")
		(var isAppliedFiltersVisible:bool = " isShipNameFilter && _searchStr || !isShipNameFilter && selectedTypeFilters ")

		(var appliedFilterInfotip:str = "isShipNameFilter ? 'CarouselAppliedFilterShipNameInfotip' : 'CarouselAppliedFilterInfotip'")
		(var infotipTitle:str = "_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_LEVEL	? 'IDS_LEVEL' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_TYPE		? 'IDS_CLASS' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_NATION	? 'IDS_NATION' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.SPECIAL		? 'IDS_SPECIAL' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.BONUS			? 'IDS_SHIP_BONUS' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_MASTERY  ? 'IDS_SHIP_MASTERY'
																						: ''")

		(var itemRenderer:str = "_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_TYPE	? 'CarouselFilterShipTypeIcon' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_NATION	? 'CarouselFilterTinyNationFlag' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.SPECIAL		? 'CarouselFilterSpecialSortingIcon' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.BONUS			? 'CarouselFilterBonusSortingIcon' :
								_filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_MASTERY  ? 'CarouselFilterShipMasterySortingIcon'
																						: ''")

		(var isInfotipVisible:bool = false)
		(var state:number = "	isInfotipVisible	? SC.Ui_styles.BUTTON_STATE.SELECTED :
								mouseDown			? SC.Ui_styles.BUTTON_STATE.DOWN :
								rollOver			? SC.Ui_styles.BUTTON_STATE.OVER
													: SC.Ui_styles.BUTTON_STATE.UP")
		(var buttonAlpha:number = "APPLIED_FILTERS_BUTTON_ALPHA[state]")
		(var closeIconAlpha:number = "APPLIED_FILTERS_BUTTON_CLOSE_ALPHA[state]")

		(var prefDir:str = "	_ident == DOCK_CAROUSEL_SHIP_RESTRICTION_TYPE			? 'carousel' :
								_ident == SHIP_MASTERY_CAROUSEL_SHIP_RESTRICTION_TYPE	? 'shipMasteryCarousel'
																						: 'trainingRoom'")
	)
	(bind visible "isAppliedFiltersVisible")
	(style
		(height = 30px)
		(backgroundColor = "NO_COLOR")
	)
	(macro MOUSE_EVENTS_DISPATCHER)
	(macro SOUND_HANDLER "'button_secondary'")

	(block
		(class $FullsizeAbsolute)
		(style (backgroundColor = "NO_COLOR"))

		(block
			(class $FullsizeAbsolute)

			(element BlurMapRoundedWithContrastPanel
				_blurType = "ROUNDED_BLUR_TYPE.LOW"
			)
		)

		(block
			(class $Fullsize)
			(style
				(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.DARK_BLUE")
				(borderRadius = "XS")
				(alpha = "buttonAlpha")
			)
			(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA _trigger="state" _alpha="buttonAlpha")
		)

		(controller $Tooltip
			(renderer = 'SimpleStatusTooltip')
			(args
				_unifiedStatus = "SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT"
				_text = "tr('IDS_CAROUSEL_APPLIED_FILTER_HINT_' + _filterType)"
			)
			(macro DEFAULT_TOOLTIP_BEHAVIOUR "0")
		)

		(controller $Tooltip
			(bind renderer "appliedFilterInfotip")
			(args
				_title = "infotipTitle"
				_filterType = "_filterType"
				_searchStr = "_searchStr"
				_ident = "_ident"
			)
			(macro CAROUSEL_INFOTIP_BEHAVIOUR "1")
			(position = "borderNoTrack")

			(bind isInfotipVisible "true" init=false watch=false on='evStartShow')
			(bind isInfotipVisible "false" init=false watch=false on='evHide')
		)
	)

	(hblock
		(style
			(marginLeft = "S")
			(marginRight = "S")
		)

		(hblock
			(bind visible "isShipNameFilter")
			(name = 'CarouselSortingText')

			(block
				(style
					(hitTest = false)
					(width = 18px)
					(height = 18px)
					(marginLeft = -2px)
					(marginTop = 6px)
					(backgroundImage = 'url:../service_kit/buttons/context/search.png')
				)
			)

			(tf
				(class $TextDefault18NM)
				(style
					(hitTest = false)
					(marginLeft = "XS")
					(marginTop = 8px)
					(alpha = "TA")
				)
				(bind text "_searchStr")
			)
		)

		(block
			(bind visible "isLevelTypeFilter")
			(style
				(hitTest = false)
				(marginLeft = "XS")
				(marginTop = 8px)
			)

			(tf
				(class $TextDefault18NM)
				(style (alpha = "TA"))
				(bind text "levelString")
			)
		)

		(hblock
			(bind visible "!isLevelTypeFilter && !isShipNameFilter")
			(style
				(hitTest = false)
				(marginLeft = -4px)
			)

			(controller $Repeat
				(bind renderer "itemRenderer")
				(bind enabled "!isLevelTypeFilter")
				(bind count "selectedTypeFilters.length")
				(args
					_filterEntityId = "selectedTypeFilters[$index]"
				)
			)
		)

		(block
			(style (width = 17px))

			(block
				(bind name "'CarouselFilterClose_' + _filterType")
				(style
					(height = 21px)
					(marginLeft = 6px)
					(marginTop = 9px)
					(alpha = "closeIconAlpha")
				)

				(macro DEFAULT_CONTROL_STATE_ANIMATION_ALPHA
					_trigger = "state"
					_alpha = "closeIconAlpha"
				)

				(element CloseButton
					_methods = "isShipNameFilter	?	[{	type: 'direct.action',
															name: 'option.set',
															args: { preferenceId: 'ui.' + prefDir + '.filters.searchString', newValue: '' }
														}]
													:	[ {	type: 'inputMapping.onAction',
															name: 'resetFilterType',
															args: { type: _filterType, ident: _ident }
														}]"
					_tooltipText = 'IDS_HINT_RESET_FILTER'
				)
			)
		)
	)
)

(def element CarouselFilterShipTypeIcon (_filterEntityId:number)
	(scope
		(var filterEntity:dhEntity = "getEntity(_filterEntityId)")
		(var field:str = "filterEntity.shipFilterItem.field ?: ''" (event "filterEntity.shipFilterItem.evUpdate"))
	)

	(style (marginTop = 3px))

	(element ShipIcon _shipType = "field")
)

(def element CarouselFilterTinyNationFlag (_filterEntityId:number)
	(scope
		(var filterEntity:dhEntity = "getEntity(_filterEntityId)")
		(var field:str = "filterEntity.shipFilterItem.field ?: ''" (event "filterEntity.shipFilterItem.evUpdate"))
	)

	(style
		(marginLeft = "XS")
		(marginTop = 1px)
	)

	(element NationFlagsTiny _shipCountry = "field")
)

(def element CarouselFilterSpecialSortingIcon (_filterEntityId:number)
	(scope
		(var filterEntity:dhEntity = "getEntity(_filterEntityId)")
		(var field:str = "filterEntity.shipFilterItem.field ?: ''" (event "filterEntity.shipFilterItem.evUpdate"))
		(var imagePath:str = "field ? 'swf:../service_kit/filters_svg/filters_svg.swf:' + field : ''")
	)

	(style
		(height = 21px)
		(width = 37px)
	)

	(block
		(style
			(hitTest = false)
			(position = "absolute")
			(height = 39px)
			(width = 39px)
			(bind top "SC.Common.SHIP_SPECIAL_FILTER_TYPE.ALL[0] == field ? -6px : -3px")
			(bind backgroundImage "imagePath")
		)
	)
)

(def element CarouselFilterBonusSortingIcon (_filterEntityId:number)
	(scope
		(var filterEntity:dhEntity = "getEntity(_filterEntityId)")
		(var field:str = "filterEntity.shipFilterItem.field ?: ''" (event "filterEntity.shipFilterItem.evUpdate"))
		(var imagePath:str = "field ? 'swf:../service_kit/filters_svg/filters_svg.swf:' + field : ''")
	)

	(style
		(height = 21px)
		(width = 27px)
		(marginLeft = -6px)
	)

	(block
		(style
			(hitTest = false)
			(position = "absolute")
			(height = 39px)
			(width = 39px)
			(top = -4px)
			(bind backgroundImage "imagePath")
		)
	)
)

(def element CarouselFilterShipMasterySortingIcon (_filterEntityId:number)
	(scope
		(var filterEntity:dhEntity = "getEntity(_filterEntityId)")
		(var field:str = "filterEntity.shipFilterItem.field ?: ''" (event "filterEntity.shipFilterItem.evUpdate"))
		(var imagePath:str = "field ? 'swf:../service_kit/filters_svg/filters_svg.swf:' + field : ''")
	)

	(style
		(height = 22px)
		(width = 22px)
	)

	(block
		(style
			(position = "absolute")
			(height = 17px)
			(width = 19px)
			(top = "5px")
			(left = "XXS")
			(hitTest = false)
			(bind backgroundImage "imagePath")
		)
	)
)

(def element CarouselAppliedFilterShipNameInfotip (_searchStr:str, _ident:number)
	(scope
		(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_SCOPE)
		(event inputStrChanged)
		(event closeSearchField)

		(var inputStr:str = "_searchStr" watch=false)
		(bind inputStr "$event.value" init=false watch=false (event "inputStrChanged"))
		(bind inputStr "''" init=false watch=false (event "closeSearchField"))
	)

	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_MARKUP "true")
	(macro HIDE_UI_ON_SHIPOVERVIEW)
	(name = 'CarouselAppliedFilterShipNameInfotip')
	(dispatch evSetString delay=0.2 reset=true dir="EventDirection.UP" args="{inputStr: inputStr}" (event "inputStrChanged") (event "closeSearchField"))

	(block
		(style (margin = "M"))

		(element InputTextDefault
			_onCloseButtonEvent = 'closeSearchField'
			_onInputChangedEvent = 'inputStrChanged'
			_closeButtonTooltipText = 'IDS_HINT_RESET_FILTER'
			_hideButtonEnter = true
			_defaultText = "_searchStr"
			_maxChars = 20
			_width = '260px'
			_defaultFocused = true
			_name = 'ShipNameField'
			_closeButtonName = 'ClearTextButton'
		)
	)
)

(def element CarouselAppliedFilterInfotip (_title:str, _filterType:str, _ident:number)
	(scope
		(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_SCOPE)
	)
	(name = 'CarouselAppliedFilterInfotip')
	(macro HIDE_UI_ON_SHIPOVERVIEW)

	(macro TOOLTIP_SYSTEM_DEFAULT_BACKGROUND_MARKUP _isInfotip="true")
	(element INFOTIP_SYSTEM_DEFAULT_CONTAINER _isAutoSize=true
		(element FilterBlock
			_title = "_title"
			_filterType = "_filterType"
			_ident = "_ident"
			_inCarousel = true
			_inCarouselFilters = true
		)
	)
)

(def element FilterBlock (_title:str, _filterType:str, _ident:number, _tooltipPrefix:str='', _inCarousel:bool=false, _inCarouselFilters:bool=false)
	(scope
		(var filtersCollection:dhCollection = "getCollectionByPath(CC.shipFilterItem, 'byFilterType.' + _filterType)")
	)

	(style
		(align = "center")
		(borderRadius = "XS")
		(paddingLeft = "MS")
		(paddingRight = "MS")
		(bind backgroundColor "_inCarouselFilters ? NO_COLOR : SC.Ui_styles.SERVICE_COLORS.INNER_PANEL")
	)

	(block
		(style
			(paddingTop = "M")
			(paddingBottom = "SXS")
		)

		(tf
			(class $TextDefaultBold18NM)
			(style (alpha = "TA"))
			(bind text "_title")
		)
	)

	(vtile
		(name = 'FilterBlockValues')
		(style
			(align = "center")
			(height = 208px)
			(gap = "S")
		)

		(controller $Repeat renderer='FilterItem'
			(bind count "filtersCollection.length")
			(args
				_filterEntity = "filtersCollection.getEntityAtIndex($index)"
				_ident = "_ident"
				_tooltipPrefix = "_tooltipPrefix"
				_inCarousel = "_inCarousel"
			)
		)
	)
)

(def element FilterItem (_filterEntity:dhEntity, _ident:number, _tooltipPrefix:str, _inCarousel:bool=false)
	(scope
		(var panelEntity:dhEntity = "getSingleEntity(CC.filterPanelComponent)")
		(var enabledFilters:array = "panelEntity.filterPanelComponent.enabledFilters ?: []" (event "panelEntity.filterPanelComponent.evUpdate"))
		(var isEnabled:bool = "isIn(_filterEntity.id, enabledFilters)")

		(var filterType:str = "_filterEntity.shipFilterItem.type ?: ''" (event "_filterEntity.shipFilterItem.evUpdate"))
		(var field:str = "_filterEntity.shipFilterItem.field ?: ''" (event "_filterEntity.shipFilterItem.evUpdate"))

		(var filtersDir:str = "	_ident == DOCK_CAROUSEL_SHIP_RESTRICTION_TYPE			? 'carousel' :
								_ident == SHIP_MASTERY_CAROUSEL_SHIP_RESTRICTION_TYPE	? 'shipMasteryCarousel'
																						: 'trainingRoom'")

		(var prefName:str = "filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_LEVEL	?	'ui.' + filtersDir + '.filters.' + filterType + '.' + shipLevelsToRoman(toNumber(field))
																					:	'ui.' + filtersDir + '.filters.' + filterType + '.' + field")
		(struct pref = GET_PREF_BOOL(_option = "prefName"))

		(var renderItem:str = "	filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_LEVEL		? 'ShipLevelCheckBox' :
								filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_TYPE		? 'ShipClassCheckBox' :
								filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_NATION	? field != 'Events'	? 'ShipNationCheckBox'
																											: '' :
								filterType == SC.Common.SHIP_FILTER_TYPE.SPECIAL		? 'ShipSpecialCheckBox' :
								filterType == SC.Common.SHIP_FILTER_TYPE.BONUS			? 'ShipBonusCheckBox' :
								filterType == SC.Common.SHIP_FILTER_TYPE.SHIP_MASTERY	? 'ShipMasteryCheckBox'
																						: 'FilterCheckBox'")
	)

	(controller $Instance
		(bind renderer "renderItem")
		(bind enabled "renderItem")
		(args
			_filterType = "filterType"
			_prefName = "prefName"
			_value = "pref.value"
			_field = "field"
			_tooltipPrefix = "_tooltipPrefix"
			_isEnabled = "!_inCarousel || isEnabled"
		)
	)
)

(def element FilterCheckBox (_filterType:str, _prefName:str, _value:bool, _field:str, _tooltipPrefix:str, _isEnabled:bool)
	(style
		(marginRight = 44px)
		(marginBottom = "S")
	)

	(element ImageRadioButton
		_enabled = "_isEnabled"
		_selected = "_value"
		_renderElement = 'tf'
		_renderArgs = "{ _shipType: _field }"
		_methods = "_isEnabled	?	[{
										type:	'direct.action',
										name:	'option.set',
										args:	[_prefName, !_value]
									}]
								:	[]"
		_size = "SIZE.MEDIUM"
	)
)

(def element ShipLevelCheckBox (_filterType:str, _prefName:str, _value:bool, _field:str, _isEnabled:bool, _tooltipPrefix:str)
	(scope
		(var tooltipPrefix:str = "_tooltipPrefix ?: 'IDS_'")
		(var isSupershipLevel:bool = "toNumber(_field) == SC.Ships.SHIP_LEVELS.SUPER_SHIP")

		(var statusTooltipData:dict = "_isEnabled	?	!_value	?	{	_text: isSupershipLevel	?	tooltipPrefix + 'HINT_CHECKBOX_FILTER_LEVEL_SUPERSHIP'
																								:	subst(tooltipPrefix + 'HINT_CHECKBOX_FILTER_LEVEL', [], { level: shipLevelsToRoman(toNumber(_field)) }),
																		_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
																:	{	_text: isSupershipLevel	?	tooltipPrefix + 'HINT_CHECKBOX_FILTER_LEVEL_SUPERSHIP_DISABLE'
																								:	subst(tooltipPrefix + 'HINT_CHECKBOX_FILTER_LEVEL_DISABLE', [], { level: shipLevelsToRoman(toNumber(_field)) }),
																		_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
													: {	_text: subst(tooltipPrefix + 'HINT_CHECKBOX_FILTER_LEVEL_NOT_AVAILABLE', [], { level: shipLevelsToRoman(toNumber(_field)) }),
														_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.ATTENTION }")
	)
	(bind name "'CarouselCheckBox_' + _filterType + '_' + _field")

	(element ImageRadioButton
		_enabled = "_isEnabled"
		_selected = "_value"
		_renderElement = 'CheckBoxShipLevel'
		_renderArgs = "{ _shipLevel: _field }"
		_methods = "_isEnabled	?	[{
										type:	'direct.action',
										name:	'option.set',
										args:	[_prefName, !_value]
									}]
								:	[]"
		_size = "SIZE.MEDIUM"
		_statusTooltipData = "statusTooltipData"
	)
)

(def element ShipClassCheckBox (_filterType:str, _prefName:str, _value:bool, _field:str, _tooltipPrefix:str, _isEnabled:bool)
	(scope
		(var tooltipPrefix:str = "_tooltipPrefix ?: 'IDS_'")
		(var statusTooltipData:dict = "_isEnabled	?	!_value	?	{ _text: 'IDS_HINT_CHECKBOX_FILTER_CLASS_' + _field,
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
																:	{ _text: 'IDS_HINT_CHECKBOX_FILTER_CLASS_' + _field + '_DISABLE',
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
													:	{	_text: 'IDS_HINT_CHECKBOX_FILTER_CLASS_NOT_AVAILABLE_' + _field,
															_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.ATTENTION }")
	)
	(bind name "'CarouselCheckBox_' + _filterType + '_' + _field")

	(element ImageRadioButton
		_enabled = "_isEnabled"
		_selected = "_value"
		_renderElement = 'CheckBoxShipTypeLabel'
		_renderArgs = "{	_shipType: _field,
							_marginTop: 2px }"
		_methods = "_isEnabled	?	[{
										type:	'direct.action',
										name:	'option.set',
										args:	[_prefName, !_value]
									}]
								:	[]"
		_size = "SIZE.MEDIUM"
		_statusTooltipData = "statusTooltipData"
	)
)

(def element ShipNationCheckBox (_filterType:str, _prefName:str, _value:bool, _field:str, _tooltipPrefix:str, _isEnabled:bool)
	(scope
		(var tooltipPrefix:str = "_tooltipPrefix ?: 'IDS_'")
		(var statusTooltipData:dict = "_isEnabled	?	!_value	?	{ _text: 'IDS_HINT_CHECKBOX_FILTER_NATION_' + _field,
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
																:	{ _text: 'IDS_HINT_CHECKBOX_FILTER_NATION_' + _field + '_DISABLE',
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
													:	{ _text: 'IDS_HINT_CHECKBOX_FILTER_NATION_NOT_AVAILABLE_' + _field,
														 _unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.ATTENTION }")
	)
	(bind name "'CarouselCheckBox_' + _filterType + '_' + _field")

	(element ImageRadioButton
		_enabled = "_isEnabled"
		_selected = "_value"
		_renderElement = 'CheckBoxNationLabel'
		_renderArgs = "{ _shipCountry: _field }"
		_methods = "_isEnabled	?	[{
										type:	'direct.action',
										name:	'option.set',
										args:	[_prefName, !_value]
									}]
								:	[]"
		_size = "SIZE.MEDIUM"
		_statusTooltipData = "statusTooltipData"
	)
)

(def element ShipSpecialCheckBox (_filterType:str, _prefName:str, _value:bool, _field:str, _tooltipPrefix:str, _isEnabled:bool)
	(scope
		(macro FEATURES "13")
		(macro PULL_ROUTE "SC.Ui_windows.ROUTE.SHIP_MASTERY" "'isInShipMastery'")
		(var isCommanderFilter:bool = "isIn(_field, SC.Common.SHIP_SPECIAL_FILTER_TYPE.COMMANDER_FILTERS)")

		(var isVisible:bool = "	!(	isInShipMastery && isCommanderFilter ||
									isCommanderFilter && feature_13 == 'locked' ||
									isIn(_field, SC.Common.SHIP_SPECIAL_FILTER_TYPE.SPECIAL_SHIP_FILTERS) && !_isEnabled)")

		(var imagePath:str = "'swf:../service_kit/filters_svg/filters_svg.swf:' + _field")

		(var statusTooltipData:dict = "_isEnabled	?	!_value	?	{ _text:'IDS_HINT_CHECKBOX_FILTER_' + _field,
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
																:	{ _text: 'IDS_HINT_CHECKBOX_FILTER_' + _field + '_DISABLE',
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
													:	{	_text: 'IDS_HINT_CHECKBOX_FILTER_NOT_AVAILABLE_' + _field,
															_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.ATTENTION }")
	)
	(bind name "'CarouselCheckBox_' + _filterType + '_' + _field")
	(bind visible "isVisible")

	(element ImageRadioButton
		_enabled = "_isEnabled"
		_selected = "_value"
		_renderElement = 'CheckBoxImageLabel'
		_renderArgs = "{	_height: 39px,
							_width: 39px,
							_marginTop: SC.Common.SHIP_SPECIAL_FILTER_TYPE.ALL[0] == _field ? -1px : 2px,
							_imagePath: imagePath}"
		_methods = "_isEnabled	?	[{
										type:	'direct.action',
										name:	'option.set',
										args:	[_prefName, !_value]
									}]
								:	[]"
		_size = "SIZE.MEDIUM"
		_statusTooltipData = "statusTooltipData"
	)
)

(def element ShipBonusCheckBox (_filterType:str, _prefName:str, _value:bool, _field:str, _tooltipPrefix:str, _isEnabled:bool)
	(scope
		(macro FEATURES "13")
		(var isVisible:bool = "!isIn(_field, SC.Common.SHIP_BONUS_FILTER_TYPE.SHIP_BONUS_FILTERS) || _isEnabled")

		(var imagePath:str = "'swf:../service_kit/filters_svg/filters_svg.swf:' + _field")

		(var statusTooltipData:dict = "_isEnabled	?	!_value	?	{ _text: 'IDS_HINT_CHECKBOX_FILTER_' + _field,
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
																:	{ _text: 'IDS_HINT_CHECKBOX_FILTER_' + _field + '_DISABLE',
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
													:	{	_text: 'IDS_HINT_CHECKBOX_FILTER_NOT_AVAILABLE_' + _field,
															_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.ATTENTION }")
	)
	(bind name "'CarouselCheckBox_' + _filterType + '_' + _field")
	(bind visible "isVisible")

	(element ImageRadioButton
		_enabled = "_isEnabled"
		_selected = "_value"
		_renderElement = 'CheckBoxImageLabel'
		_renderArgs = "{	_height: 39px,
							_width: 39px,
							_marginTop: 4px,
							_imagePath: imagePath}"
		_methods = "_isEnabled	?	[{
										type:	'direct.action',
										name:	'option.set',
										args:	[_prefName, !_value]
									}]
								:	[]"
		_size = "SIZE.MEDIUM"
		_statusTooltipData = "statusTooltipData"
	)
)

(def element ShipMasteryCheckBox (_filterType:str, _prefName:str, _value:bool, _field:str, _tooltipPrefix:str, _isEnabled:bool)
	(scope
		(macro PULL_ROUTE "SC.Ui_windows.ROUTE.SHIP_MASTERY" "'isInShipMastery'")

		(var imagePath:str = "'swf:../service_kit/filters_svg/filters_svg.swf:' + _field")

		(var statusTooltipData:dict = "_isEnabled	?	!_value	?	{ _text: 'IDS_HINT_CHECKBOX_FILTER_' + _field,
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
																:	{ _text: 'IDS_HINT_CHECKBOX_FILTER_' + _field + '_DISABLE',
																	_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.MOUSE_LEFT }
													:	{	_text: 'IDS_HINT_CHECKBOX_FILTER_NOT_AVAILABLE_' + _field,
															_unifiedStatus:	 SC.Ui_styles.UNIFIED_STATUS.ATTENTION }")
		(var isCheckBoxEnabled:bool = "_isEnabled && isInShipMastery")
	)
	(bind name "'CarouselCheckBox_' + _filterType + '_' + _field")
	(bind visible "isInShipMastery")

	(element ImageRadioButton
		_enabled = "isCheckBoxEnabled"
		_selected = "_value"
		_renderElement = 'CheckBoxImageLabel'
		_renderArgs = "{_height: 21px,
						_width: 21px,
						_imagePath: imagePath }"
		_methods = "_isEnabled	?	[{
										type:	'direct.action',
										name:	'option.set',
										args:	[_prefName, !_value]
									}]
								:	[]"
		_size = "SIZE.MEDIUM"
		_statusTooltipData = "statusTooltipData"
	)
)

(def element CheckBoxShipLevel (_params:dict)
	(class $Fullsize)
	(style (align = "center|middle"))

	(tf
		(class $TextDefault18NM)
		(style (alpha = "TA"))
		(bind text "shipLevelsToRoman(toNumber(_params._shipLevel), true)")
	)
)

(def element CheckBoxShipTypeLabel (_params:dict)
	(class $Fullsize)
	(style (align = "center|middle"))

	(element ShipIcon
		_shipType = "_params._shipType"
	)
)

(def element CheckBoxNationLabel (_params:dict)
	(class $Fullsize)
	(style (align = "center|middle"))

	(element NationFlagsTiny
		_shipCountry = "_params._shipCountry"
	)
)

(def element CheckBoxImageLabel (_params:dict)
	(style
		(bind width "_params._width")
		(bind height "_params._height")
		(bind marginTop "_params._marginTop ?: 0")
		(bind backgroundImage "_params._imagePath")
	)
)

(def element ShipsAndSlotsCounter(_isFilterActive:bool=false)
	(scope
		
		(event evFilterApplied)
		(event evFilteredShipsChanged)
		(var playerShips:dhCollection = "getCollection(CC.ownShip)")
		(var playerShipsCount:number = "playerShips.length")

		(var timeAppliedFilter:number = 0.1)
		(var filteredShips:dhCollection = "getCollection(CC.mainShipFilter).getChildByPath('filtered.sorted')")
		(var filteredShipsCount:number = "filteredShips.length")
		(var shipsCountAfterFilterApplied:number = "filteredShipsCount" watch=false (event "evFilterApplied"))
		(var showFilteredShipsCount:bool = "_isFilterActive" watch=false (event "evFilteredShipsChanged"))

		
		(var resourceEntity:dhEntity = "getSingleEntity(CC.accountResource)")
		(var accountResourceComponent:dhComponent = "resourceEntity.accountResource")
		(var accountSlotsCount:number = "accountResourceComponent.slotsNum" (event "accountResourceComponent.evChangedSlotsNum"))
	)

	(style
		(flow = "horizontal")
		(align = "right")
	)

	(dispatch evFilterApplied delay="timeAppliedFilter" reset=true (bind trigger "filteredShipsCount"))
	(dispatch evFilteredShipsChanged delay="timeAppliedFilter + 0.05" reset=true (bind enabled "_isFilterActive") (bind trigger "_isFilterActive"))
	(dispatch evFilteredShipsChanged (bind enabled "!_isFilterActive") (bind trigger "_isFilterActive"))

	
	(hblock
		(style (marginRight = 14px))

		(tf
			(class $TextDefaultNM)
			(style
				(marginRight = 6px)
				(alpha = "TC")
			)
			(bind text "tr('IDS_SHIPS') + tr('IDS_COLON')")
		)

		(hblock
			(bind visible "showFilteredShipsCount")

			(tf
				(class $TextDefaultNM)
				(style
					(marginRight = "XS")
					(alpha = "TC")
				)
				(bind text "shipsCountAfterFilterApplied")
			)

			(tf
				(class $TextDefaultNM)
				(style
					(marginRight = "XS")
					(alpha = "TC")
				)
				(text = '/')
			)
		)

		(block
			(style (alpha = "showFilteredShipsCount ? TS : TC"))

			(controller $Animation
				(bindcall play
					duration = 0.1
					from = "{alpha: TC}"
					to = "{alpha: TS}"
					action = "kill"
					reverse = "!showFilteredShipsCount"
					(bind trigger "showFilteredShipsCount")
				)
			)

			(tf
				(class $TextDefaultNM)
				(bind text "playerShipsCount")
			)
		)
	)

	
	(hblock
		(tf
			(class $TextDefaultNM)
			(style
				(marginRight = "XS")
				(alpha = "TC")
			)
			(bind text "tr('IDS_FREE_SLOTS')")
		)

		(tf
			(class $TextDefaultNM)
			(style (alpha = "TC"))
			(bind text "accountSlotsCount")
		)
	)
)