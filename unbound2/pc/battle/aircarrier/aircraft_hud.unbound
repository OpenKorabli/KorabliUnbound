(def constant AIRPLANE_FLIGHT_STATE_INACTIVE 0)
(def constant AIRPLANE_FLIGHT_STATE_LAUNCHING 1)
(def constant AIRPLANE_FLIGHT_STATE_FLY 2)

(def constant SKIP_ANIM_PANEL_BOTTOM_OFFSET 154px)
(def constant DEATH_TIMER_PANEL_BOTTOM_OFFSET 190px)


(def element AircraftHud ()
	(scope
		(var cameraEntity:gfx = "$datahub.getSingleEntity(CC.camera)")
		(var isTacticalMap:bool = "cameraEntity.camera.isTactical" (event "cameraEntity.camera.evTacticalStateChanged"))

		(var aircarrier:gfx = "$datahub.getSingleComponent(CC.aircarrier)")

		(var activeSquadronIndex:number = "aircarrier ? aircarrier.activeSquadronIndex : DEFAULT_SQUADRON_OWNER_ID" (event "aircarrier.evStateChanged"))
		(var selectedSquadron:number = "aircarrier ? aircarrier.selectedSquadron : DEFAULT_SQUADRON_OWNER_ID" (event "aircarrier.evSelectedSquadronChanged"))

		(var lastSelectedSquadron:number = "aircarrier ? aircarrier.lastSelectedSquadron : ActiveSquadron.NONE" (event "aircarrier.evLastSelectedSquadronChanged"))
		(var activeOrSelectedSquadronIndex:number = "	activeSquadronIndex != ActiveSquadron.NONE 	? activeSquadronIndex :
														lastSelectedSquadron != ActiveSquadron.NONE ? lastSelectedSquadron
																									: ActiveSquadron.NONE"
		)

		(var squadronCameraMode:str = "aircarrier.squadronCameraMode" (event "aircarrier.evSquadronCameraModeChanged"))
		(var canLaunchSquadrons:bool = "aircarrier.canLaunchSquadrons" (event "aircarrier.evCanLaunchSquadronsChanged"))

		(var currentSquadronEntity:gfx = "$datahub.getPrimaryEntity(CC.ownSquadron, activeSquadronIndex)")
		(var ownSquadron:gfx = "currentSquadronEntity ? currentSquadronEntity.ownSquadron : null")
		(var flightState:number = "ownSquadron ? ownSquadron.state : 0" (event "ownSquadron.evStateChanged"))
		(var attackState:number = "ownSquadron ? ownSquadron.attackState : SC.Battle.SQUADRON_ATTACK_STATE.DEFAULT" (event "ownSquadron.evAttackStateChanged"))

		(var avatar:gfx = "$datahub.getSingleEntity(CC.playerAvatar)")
		(var timeToLive:number = "avatar.playerAvatar.timeToLive" (event "avatar.playerAvatar.evWillDieSoon"))
		(var isAlive:bool = "avatar.health.isAlive" (event "avatar.health.evIsAliveChanged"))

		(var controlledSquadronId:number = "aircarrier != null ? aircarrier.controlledSquadronId : DEFAULT_SQUADRON_ID" (event "aircarrier.evControlledSquadronIdChanged"))
		(var isControllingSquadron:bool = "controlledSquadronId != DEFAULT_SQUADRON_ID")

		(var isOnSquadron:bool = "isControllingSquadron && squadronCameraMode == SquadronCameraModes.DEFAULT")
		(var isOnNoAvatarCamera:bool = "aircarrier && (squadronCameraMode != SquadronCameraModes.DEFAULT)")
		(var lastAttackStartedState:bool = "squadronCameraMode == SquadronCameraModes.LAST_SQUADRON_ATTACK_START")
		(var lastAttackedState:bool = "squadronCameraMode == SquadronCameraModes.LAST_SQUADRON_ATTACKED")
		(var squadronDeadState:bool = "squadronCameraMode == SquadronCameraModes.SQUADRON_DEAD")

		(var isTimerToDieVisible:bool = "isOnSquadron && timeToLive != 0")
		(var isDeathCamera:bool = "!(isOnSquadron || isAlive)")
		(var isFlying:bool = "flightState == AIRPLANE_FLIGHT_STATE_FLY")
		(var isShowSquadronHealthBar:bool = "isControllingSquadron && !isOnNoAvatarCamera && !isDeathCamera && !lastAttackStartedState && !lastAttackedState")

		(var battleStateEntity:gfx = "$datahub.getSingleEntity(CC.battleState)")
		(var battleState:number = "battleStateEntity.battleState.battleState" (event "battleStateEntity.battleState.evBattleStateChanged"))

		(var isShowReturnAnimation:bool = "isOnNoAvatarCamera && isAlive && (lastAttackedState || squadronDeadState)")
		(var isSquadronAttacking:bool = "attackState == SC.Battle.SQUADRON_ATTACK_STATE.MAIN_SQUADRON_ATTACK")

		(var weaponControllerComponent:dhComponent = "getSingleComponent(CC.weaponController)")
		(var weaponId:str = "weaponControllerComponent.activeIdWeapon" (event "weaponControllerComponent.evSelectedWeaponChanged"))

		(var reloadBarsCollection:dhCollection = "getCollection(CC.reloadBar)")
		(var activeWeaponType:number = "weaponControllerComponent != null ? weaponControllerComponent.selectedWeapon : SC.Ships.SHIP_WEAPON_TYPES.NONE" (event "weaponControllerComponent.evSelectedWeaponChanged") (event "weaponControllerComponent.evSelectedAmmoTypeChanged"))
		(var hasActiveWeaponBar:bool = "reloadBarsCollection.length != 0 && activeWeaponType != SC.Ships.SHIP_WEAPON_TYPES.NONE && activeWeaponType != SC.Ships.SHIP_WEAPON_TYPES.AIRPLANES")

		(var slot:gfx = "$datahub.getPrimaryEntity(CC.weaponSlot, weaponId)")
		(var state:number = "slot ? slot.weaponSlot.state : 0" (event "slot.weaponSlot.evStateChanged"))
		(var isDisabled:bool = "state == SC.Weapons.GUN_STATE.DISABLED")

		(var isShowSwitchToAirplanesInstruction:bool = "!isControllingSquadron &&
														isAlive &&
														!isOnNoAvatarCamera &&
														activeSquadronIndex != DEFAULT_SQUADRON_OWNER_ID &&
														selectedSquadron == DEFAULT_SQUADRON_OWNER_ID"
		)
	)

	(class $FullsizeAbsolute)

	(controller $Animation
		(bindcall play
			duration = 0.08
			from = {alpha: 1, visible: true}
			to = {alpha: 0, visible: false}
			reverse = "!isTacticalMap"
			action = "kill"
			(bind trigger "isTacticalMap")
		)
	)

	(block
		(visible = "isFlying && isShowSquadronHealthBar")

		(class $FullsizeAbsolute)
		(style (visualOffsetY = "isFlying ? 0px : 5px"))

		(alpha = "isFlying && isShowSquadronHealthBar ? 1 : 0")

		(controller $Animation
			(bindcall play
				duration = 0.1
				delay = 0.18
				from = {alpha: 0, visible: false, visualOffsetY: 5px}
				to = {alpha: 1, visible: true, visualOffsetY: 0px}
				action = "kill"
				(bind enabled "isFlying && isShowSquadronHealthBar")
			)
			(bindcall play
				duration = 0.1
				from = {alpha: 1, visible: true, visualOffsetY: 0px}
				to = {alpha: 0, visible: false, visualOffsetY: 5px}
				action = "kill"
				(bind enabled "!(isFlying && isShowSquadronHealthBar)")
			)
		)

		(element AircraftHealthbar
			(bind visible "isFlying")
		)
	)

	(block
		(bind visible "isOnSquadron")

		(element AircraftCentralHud
			_activeSquadronIndex = "activeSquadronIndex"
		)
	)

	(block
		(visible = "isTimerToDieVisible")

		(style
			(position = "absolute")
			(width = 100%)
			(align = "center")
			(bottom = "DEATH_TIMER_PANEL_BOTTOM_OFFSET")
		)

		(controller $Animation
			(bindcall play
				duration = 0.1
				delay = 0.25
				from = "{alpha: 0, visible: false, bottom: DEATH_TIMER_PANEL_BOTTOM_OFFSET - 5px}"
				to = "{alpha: 1, visible: true, bottom: DEATH_TIMER_PANEL_BOTTOM_OFFSET}"
				action = "kill"
				(bind enabled "isTimerToDieVisible")
			)
			(bindcall play
				duration = 0.1
				from = "{alpha: 1, visible: true, bottom: DEATH_TIMER_PANEL_BOTTOM_OFFSET}"
				to = "{alpha: 0, visible: false, bottom: DEATH_TIMER_PANEL_BOTTOM_OFFSET - 5px}"
				action = "kill"
				(bind enabled "!isTimerToDieVisible")
			)
		)

		(element AircraftDeathTimer)
	)

	(block
		(visible = "isShowReturnAnimation")

		(style
			(position = "absolute")
			(width = 100%)
			(align = "center")
			(bottom = 92px)
		)

		(controller $Animation
			(bindcall play
				duration = 0.08
				delay = 0.08
				from = {alpha: 0, visible: false, bottom: 87px}
				to = {alpha: 1, visible: true, bottom: 92px}
				reverse = "!isShowReturnAnimation"
				action = "kill"
				(bind trigger "isShowReturnAnimation")
			)
		)

		(element AircraftCarrierPanelReturnInstruction)
	)

	(block
		(visible = "isShowSwitchToAirplanesInstruction")

		(style
			(position = "absolute")
			(width = 100%)
			(align = "center")
			(bottom = "hasActiveWeaponBar ? 160px : 120px")
		)

		(controller $Animation
			(bindcall play
				duration = 0.15
				delay = 0.05
				from = {alpha: 0, visible: false}
				to = {alpha: 1, visible: true}
				reverse = "!isShowSwitchToAirplanesInstruction"
				action = "kill"
				(bind trigger "isShowSwitchToAirplanesInstruction")
			)
		)

		(controller $Animation
			(bindcall play
				duration = 0.15
				delay = 0.05
				from = {bottom: 120px}
				to = {bottom: 160px}
				reverse = "!hasActiveWeaponBar"
				action = "kill"
				(bind trigger "hasActiveWeaponBar")
			)
		)

		(element AircraftCarrierPanelSwitchToAirplanesInstruction)
	)

	(block
		(visible = "isSquadronAttacking")

		(style
			(position = "absolute")
			(width = 100%)
			(align = "center")
			(paddingRight = "S")
			(bottom = "SKIP_ANIM_PANEL_BOTTOM_OFFSET")
		)

		(controller $Animation
			(bindcall play
				duration = 0.08
				delay = 0.12
				from = "{alpha: 0, visible: false, bottom: SKIP_ANIM_PANEL_BOTTOM_OFFSET - 5px}"
				to = "{alpha: 1, visible: true, bottom: SKIP_ANIM_PANEL_BOTTOM_OFFSET}"
				action = "kill"
				(bind enabled "isSquadronAttacking")
			)
			(bindcall play
				duration = 0.08
				delay = 0.05
				from = "{alpha: 1, visible: true, bottom: SKIP_ANIM_PANEL_BOTTOM_OFFSET}"
				to = "{alpha: 0, visible: false, bottom: SKIP_ANIM_PANEL_BOTTOM_OFFSET - 5px}"
				action = "kill"
				(bind enabled "!isSquadronAttacking")
			)
		)

		(element AircraftCarrierPanelSkipAttackCameraInstruction)
	)


	(block
		(style
			(position = "absolute")
			(width = 100%)
			(align = "center")
			(bottom = 117px)
		)

		(controller $Instance renderer='AircraftCarrierPanelInstruction'
			(bind enabled "!isControllingSquadron && battleState == SC.Common.CLIENT_BATTLE_STATE.STARTED && canLaunchSquadrons && !isDisabled")
			(args
				_selectedSquadronId = "selectedSquadron"
				_isShowPanel 		= "isOnNoAvatarCamera || isDeathCamera"
			)
		)
	)

	(element SquadronWeaponsPanel
		_isActiveSquadron 		= "isControllingSquadron && activeSquadronIndex != DEFAULT_SQUADRON_OWNER_ID"
		_activeSquadronIndex 	= "activeOrSelectedSquadronIndex"
	)
)
