(def constant MASK_WIDTH 56px)
(def constant MASK_HEIGHT 54px)


(def element SlotRageModeRenderer (_entityId:number)
	(scope
		(var selfVehicleComponent:dhComponent = "getSingleComponent(CC.selfVehicle)")
		(var avatarId:number = "getSingleEntity(CC.playerAvatar).avatar.id")
		(var rageModeTTX:dict = "selfVehicleComponent.shipTTX.specials.rageMode")

		(var rageModeSlotEntity:dhEntity = "getEntity(_entityId)")
		(var rageModeVisualDataComponent:dhComponent = "rageModeSlotEntity.visualSlotData")
		(var consumableName:str = "rageModeTTX.name")

		(var commandId:number = "rageModeVisualDataComponent ? rageModeVisualDataComponent.commandId : CMD_NONE")
		(var isAutoUsage:bool = "commandId == CMD_AUTO")

		(var rageModeStateEntity:dhEntity = "getSingleEntity(CC.rageModeState)")
		(var rageModeStateComponent:dhComponent = "rageModeStateEntity.rageModeState")
		(var currentRageModeState:number = "rageModeStateComponent ? rageModeStateComponent.state : SC.Battle.RAGE_MODE_STATE.IDLE" (event "rageModeStateComponent.evStateChanged"))

		(var isCharged:bool = "currentRageModeState == SC.Battle.RAGE_MODE_STATE.CHARGED")
		(var isWorking:bool = "currentRageModeState == SC.Battle.RAGE_MODE_STATE.ACTIVE")
		(var isInstant:bool = "rageModeStateComponent.isInstant")

		(var currentProgress:number = "rageModeStateComponent ? rageModeStateComponent.currentProgress : 0" (event "rageModeStateComponent.evCurrentProgressChanged"))

		(var timerComponent:dhComponent = "getSingleComponent(CC.timer)")
		(var countdownComponent:dhComponent = "rageModeStateEntity.countDown")
		(var remainTime:number = "countdownComponent ? countdownComponent.endTime - timerComponent.currentTime : 0" (event "timerComponent.evFrequent") (event "countdownComponent.evEndTimeChanged"))
		(var percentPassed:number = "countdownComponent.duration > 0 && !isInstant ? remainTime / countdownComponent.duration : 1")

		(var cameraComponent:dhComponent = "getSingleComponent(CC.camera)")
		(var isAltVision:bool = "cameraComponent.altVision" (event "cameraComponent.evAltVisionChanged"))

		(var currentActivationCount:number = "rageModeStateComponent.currentActivationCount ?: 0" (event "rageModeStateComponent.evStateChanged"))
		(var maxActivationCount:number = "rageModeTTX ? rageModeTTX.maxActivationCount : SC.Battle.RAGE_MODE_ACTIVATION_COUNT.UNLIMITED")
	)

	(style
		(width = "SLOT_SIZE")
		(height = "SLOT_SIZE")
		(marginRight = "PANEL_ITEM_MARGIN")
		(marginBottom = "PANEL_HOTKEY_GAP")
		(backgroundColor = "SC.Ui_styles.SERVICE_COLORS.INNER_PANEL")
	)

	(macro MOUSE_LMB_EXTERNAL_CALL 'direct.action' "['weaponSlot.pressed', [commandId]]" "!isAutoUsage")

	(block
		(bind visible "!isAltVision || isInstant")

		(style (position = "absolute"))

		(controller $Instance
			(bind renderer "isInstant ? 'RageModeProgressInstant' : 'RageModeProgressDefault'")
			(args
				_rageModeStateEntity = "rageModeStateEntity"
			)
		)
	)

	(element SlotItem
		_itemImageUrl 	= "'url:../consumables/rageMode_' + consumableName + '.png'"
		_isSelectable 	= false
		_width 			= "SLOT_SIZE"
		_height 		= "SLOT_SIZE"
	)

	(block
		(bind visible "!isWorking && isAltVision")

		(style (position = "absolute"))

		(controller $Instance renderer='RageModeAltInfo'
			(bind enabled "!isInstant")
			(args
				_currentProgress 	= "currentProgress"
				_remainTime 		= "remainTime"
			)
		)
	)

	
	(block
		(bind visible "isWorking")

		(class $FullsizeAbsolute)

		(controller $Instance renderer='SlotReloadBar'
			(bind enabled "!isInstant")
			(args
				_isWorking 		= "isWorking"
				_percentPassed 	= "percentPassed"
				_remainTime 	= "remainTime > 0 ? remainTime : 0"
			)
		)
	)

	
	(hblock
		(bind visible "maxActivationCount != SC.Battle.RAGE_MODE_ACTIVATION_COUNT.UNLIMITED")
		(class $FullsizeAbsolute)
		(style
			(align = "right")
			(paddingTop = "XS")
			(paddingRight = "XS")
		)

		(tf
			(class $TextDefaultBoldNM)
			(bind text "currentActivationCount")
		)

		(tf
			(class $TextDefaultBoldNM)
			(style
				(marginRight = 1px)
				(marginLeft = 1px)
			)
			(text = '/')
		)

		(tf
			(class $TextDefaultBoldNM)
			(bind text "maxActivationCount")
		)
	)

	
	(block
		(class $FullsizeAbsolute)

		(controller $FxInstance lifetime=0.5
			(renderer = 'SlotWorkStartedFX')
			(bindcall create (bind enabled "isWorking"))
		)

		(controller $FxInstance lifetime=0.5
			(renderer = 'SlotWorkStartedFX')
			(args
				_isAccented = true
			)
			(bindcall create (bind enabled "isCharged && !isInstant"))
		)

		(controller $FxInstance lifetime=0.5
			(renderer = 'SlotReloadStartedFX')
			(bindcall create (bind enabled "!isWorking && !isInstant"))
		)
	)

	
	(block
		(style
			(position = "absolute")
			(bottom = "-HOTKEY_SIZE[SIZE.MEDIUM] - PANEL_HOTKEY_GAP")
			(hcenter = 0px)
		)

		(controller $Instance renderer='HotkeyIndicator'
			(bind enabled "!isAutoUsage")
			(args
				_commandId = "commandId"
			)
		)
	)

	
	(controller $Instance renderer='LabelAuto'
		(bind enabled "isAutoUsage")
	)

	(block
		(class $FullsizeAbsolute)
		(style (backgroundColor = "NO_COLOR"))

		(controller $Tooltip
			(renderer = 'BattleWeaponTooltip')
			(args
				_ammoType = "rageModeVisualDataComponent.id"
				_entityId = "avatarId"
			)
			(align = "bottom|center")
			(position = "border")
			(offset = [0, 20])
			(screenBoundsOffset = {left:10, top:30, right:10, bottom:100})
			(macro SIMPLE_TOOLTIP_ANIMATION)
		)
	)
)

(def element RageModeProgressDefault (_rageModeStateEntity:dhEntity)
	(scope
		(var selfVehicleComponent:dhComponent = "getSingleComponent(CC.selfVehicle)")
		(var shipTTX:dict = "selfVehicleComponent.shipTTX")
		(var rageModeTTX:dict = "shipTTX.specials.rageMode")

		(var rageModeStateComponent:dhComponent = "_rageModeStateEntity.rageModeState")
		(var currentRageModeState:number = "rageModeStateComponent ? rageModeStateComponent.state : SC.Battle.RAGE_MODE_STATE.IDLE" (event "rageModeStateComponent.evStateChanged"))

		(var currentProgress:number = "rageModeStateComponent ? rageModeStateComponent.currentProgress : 0" (event "rageModeStateComponent.evCurrentProgressChanged"))
		(var decrementCount:number	= "rageModeTTX ? rageModeTTX.decrementCount.value : 1")
		(var decrementPeriod:number = "rageModeTTX ? rageModeTTX.decrementPeriod.value : 1")

		(var decrementPeriodLong:number = "decrementPeriod*3")

		(var currentProgressAnim:number = "currentProgress" watch=false)
		(controller $Animation
			(bindcall play
				duration = 0.35
				easing = "Easing.quad_in"
				to = "{ currentProgressAnim: currentProgress}"
				watch = false
				(event "rageModeStateComponent.evCurrentProgressChanged")
			)
		)

		(var fillMaskHeight:number = "MASK_HEIGHT * currentProgressAnim * 0.01")
		(var decrementedMaskBottomOffset:number = "MASK_HEIGHT * ((currentProgressAnim - decrementCount) * 0.01)")

		(var timerComponent:dhComponent = "getSingleComponent(CC.timer)")
		(var countdownComponent:dhComponent = "_rageModeStateEntity.countDown")
		(var remainTime:number = "countdownComponent ? countdownComponent.endTime - timerComponent.currentTime : 0" (event "timerComponent.evFrequent") (event "countdownComponent.evEndTimeChanged"))

		(var isDecayOn:bool = "currentRageModeState == SC.Battle.RAGE_MODE_STATE.DECAYING || (currentRageModeState == SC.Battle.RAGE_MODE_STATE.DECAY_DELAY && remainTime < decrementPeriodLong)")
		(var isCharged:bool = "currentRageModeState == SC.Battle.RAGE_MODE_STATE.CHARGED")

		(var fillImageColorName:str = "isCharged ? '_green' : '_yellow'")

		(var fillImageUrl:str = "'url:../consumables/rageMode_background' + fillImageColorName + '.png'")
	)
	(block 
		(style
			(position = "absolute")
			(width = "SLOT_SIZE")
			(height = "SLOT_SIZE")
		)
		(block 
			(style
				(position = "absolute")
				(width = "SLOT_SIZE")
				(height = "SLOT_SIZE")
				(backgroundSize = "fill")
				(backgroundImage = 'url:../consumables/rageMode_background_track.png')
			)
			(block 
				(isMask = true)
				(style
					(position = "absolute")
					(marginTop = 3px)
					(marginBottom = 3px)
					(marginLeft = 2px)
					(width = "MASK_WIDTH")
					(backgroundColor = 0xFFFFFFFF)
					(bind height "MASK_HEIGHT - fillMaskHeight")
				)
			)
		)

		(block 
			(style
				(position = "absolute")
				(width = "SLOT_SIZE")
				(height = "SLOT_SIZE")
				(backgroundSize = "fill")
				(bind backgroundImage "fillImageUrl")
			)
			(block 
				(isMask = true)
				(style
					(position = "absolute")
					(marginTop = 3px)
					(marginLeft = 2px)
					(marginBottom = 3px)
					(rotation = 180)
					(pivotX = "MASK_WIDTH")
					(pivotY = "MASK_HEIGHT")
					(width = "MASK_WIDTH")
					(backgroundColor = 0xFFFFFFFF)
					(bind height "fillMaskHeight")
				)
			)
		)
		(block 
			(bind visible "isDecayOn")
			(controller $Animation

				(bindcall play
					duration = "decrementPeriod/2"
					from = {alpha: 1}
					to = {alpha: 0}
					repeatCount = -1
					action = "killAll"
					(bind enabled "decrementPeriod > 0.0")
				)
			)
			(style
				(position = "absolute")
				(width = "SLOT_SIZE")
				(height = "SLOT_SIZE")
				(backgroundSize = "fill")
				(backgroundImage = 'url:../consumables/rageMode_background_white.png')
			)
			(block 
				(isMask = true)
				(style
					(position = "absolute")
					(marginTop = 3px)
					(marginLeft = 2px)
					(width = "MASK_WIDTH")
					(backgroundColor = 0xFFFFFFFF)
					(bind bottom "3px + decrementedMaskBottomOffset")
					(bind height "MASK_HEIGHT * (decrementCount * 0.01)")
				)
			)
		)
	)
)

(def element RageModeProgressInstant (_rageModeStateEntity:dhEntity)
	(scope
		(var rageModeStateComponent:dhComponent = "_rageModeStateEntity.rageModeState")
		(var currentRageModeState:number = "rageModeStateComponent ? rageModeStateComponent.state : SC.Battle.RAGE_MODE_STATE.IDLE" (event "rageModeStateComponent.evStateChanged"))

		(var isWorking:bool = "currentRageModeState == SC.Battle.RAGE_MODE_STATE.ACTIVE")
	)

	(style
		(width = "SLOT_SIZE")
		(height = "SLOT_SIZE")
		(backgroundSize = "fill")
		(backgroundImage = 'url:../consumables/rageMode_background_track.png')
	)

	(block
		(class $FullsizeAbsolute)
		(style
			(backgroundSize = "fill")
			(backgroundImage = 'url:../consumables/rageMode_background_green.png')
			(alpha = 0)
		)

		(controller $Animation
			(bindcall play
				duration = 0.3
				from = "{alpha: 2}"
				to = "{alpha: 0}"
				action = "kill"
				(bind enabled "isWorking")
			)
		)
	)
)

(def element RageModeAltInfo (_currentProgress:number=0, _remainTime:number=0)
	(scope
		(macro HUMAN_READABLE_COUNTDOWN_SCOPE "_remainTime")
		(var countdownColor:number = "_remainTime < 5 ? SC.Ui_styles.SERVICE_COLORS.RED
														: _remainTime < 10	? SC.Ui_styles.SERVICE_COLORS.YELLOW
																			: SC.Ui_styles.SERVICE_COLORS.WHITE")
	)
	(style
		(position = "absolute")
		(width = "SLOT_SIZE")
		(height = "SLOT_SIZE")
	)
	(block 
		(style
			(width = 100%)
			(height = 100%)
			(align = "center|middle")
			(backgroundColor = 0xCC000000)
		)
		(tf
			(class $TextDefault18NM)
			(bind alpha "_remainTime > 0 ? 0.8 : 0")
			(bind text "countdownText")
			(style
				(marginBottom = 10px)
				(bind textColor "countdownColor")
			)
		)
		(hblock
			(class $MiddleAlignedAbsolutely)
			(style (bottom = 6px))
			(tf
				(alpha = 0.7)
				(class $TextDefaultBold22NM)
				(style (marginRight = 2px))
				(bind text "_currentProgress")
			)
			(tf
				(alpha = 0.5)
				(class $TextDefaultNM)
				(text = '/100')
			)
		)
	)
)
